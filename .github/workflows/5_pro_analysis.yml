name: 5. Pro Analysis & Email

on:
  repository_dispatch:
    types: [initial-market-data, final-lineup-data-ready] # Listen for both types
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        type: string
      analysis_type:
        description: 'Type of analysis (e.g., initial, final_lineups, default)'
        required: false
        default: 'default'
        type: string

jobs:
  generate_analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main
          
      - name: Pull latest changes
        run: git pull origin main
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: pip install pandas numpy
      
      - name: Get Week Number
        id: get_week
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
            WEEK="${WEEK%.*}"
          elif [ -n "${{ github.event.client_payload.week }}" ]; then
            WEEK="${{ github.event.client_payload.week }}"
            WEEK="${WEEK%.*}"
          else
            # Auto-detect from existing files
            WEEK=$(ls data/week*/week*_referees.csv 2>/dev/null | grep -oP 'week\K[0-9]+' | sort -n | tail -1)
          fi
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "üìÖ Generating analysis for Week $WEEK"
      
      - name: Get Analysis Type
        id: analysis_type
        run: |
          # Priority 1: workflow_dispatch input
          TYPE="${{ github.event.inputs.analysis_type }}"
          
          # Priority 2: repository_dispatch client_payload
          # Check for empty string "null" from workflow_dispatch default if not provided
          if [ -z "$TYPE" ] || [ "$TYPE" == "null" ] || [ "$TYPE" == "default" ]; then
            TYPE="${{ github.event.client_payload.analysis_type }}"
          fi

          # Ensure TYPE is set to a default if still empty/null
          if [ -z "$TYPE" ] || [ "$TYPE" == "null" ]; then
            TYPE="default"
          fi

          FLIPS="${{ github.event.client_payload.line_flips }}" # Line flips will only come from repository_dispatch

          # --- UPDATED LOGIC FOR ANALYSIS TYPE ---
          if [ "$TYPE" = "initial" ]; then
            echo "type=Initial Market Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üèà Initial Market" >> $GITHUB_OUTPUT
            echo "intro_text=Here's your initial market analysis for Week ${{ steps.get_week.outputs.week }}, hot off the press! We've crunched the early numbers and identified the biggest opportunities and potential traps as lines open." >> $GITHUB_OUTPUT
          elif [ "$TYPE" = "final_lineups" ]; then # This is the key addition
            echo "type=Final Lineup Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üö® Final Lineup" >> $GITHUB_OUTPUT
            echo "intro_text=The final lineups are in, and so is your updated analysis for Week ${{ steps.get_week.outputs.week }}! This report incorporates all the latest player news and how it impacts the market." >> $GITHUB_OUTPUT
          elif [ "$TYPE" = "default" ]; then # Explicitly handle default (manual or other updates)
            echo "type=Updated Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üìä Updated" >> $GITHUB_OUTPUT
            echo "intro_text=Here's an updated analysis for Week ${{ steps.get_week.outputs.week }}, reflecting the latest market movements and data changes." >> $GITHUB_OUTPUT
          else # Fallback for any unexpected type
            echo "type=General Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üìà General" >> $GITHUB_OUTPUT
            echo "intro_text=Here's your general analysis for Week ${{ steps.get_week.outputs.week }}." >> $GITHUB_OUTPUT
          fi

          if [ -n "$FLIPS" ] && [ "$FLIPS" != "0" ]; then
            echo "flip_alert=üö® $FLIPS line flip(s) detected and processed" >> $GITHUB_OUTPUT
          else
            echo "flip_alert=" >> $GITHUB_OUTPUT
          fi
      
      - name: Get Timestamp
        id: timestamp
        run: echo "time=$(date '+%Y-%m-%d %I:%M %p ET')" >> $GITHUB_OUTPUT
      
      - name: Run Pro Analyzer
        run: |
          echo "üî¨ Running Pro Analysis Engine..."
          python3 analyzers/nfl_pro_analyzer.py ${{ steps.get_week.outputs.week }}
      
      - name: Send Enhanced Professional Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'PYTHON_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          import email.mime.application
          import os
          import re
          import json
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          analysis_type = "${{ steps.analysis_type.outputs.type }}" # From Get Analysis Type step
          subject_prefix = "${{ steps.analysis_type.outputs.subject_prefix }}" # From Get Analysis Type step
          flip_alert = "${{ steps.analysis_type.outputs.flip_alert }}"

          # Load detailed pro analysis
          try:
              with open(f"data/week{week}/week{week}_pro_analysis.txt", "r") as f:
                  pro_analysis_content = f.read()
          except:
              pro_analysis_content = "Pro analysis file not found"
          
          # --- DATA PARSING LOGIC (Restored from your old script) ---
          def parse_game_sections(content):
              games = []
              # Split by game divider
              game_sections = content.split("======================================================================")
              
              for section in game_sections:
                  # Check for a new game section
                  if "===" in section and "Classification:" in section:
                      game = {}
                      lines = section.strip().split('\n')
                      
                      # Initial line parsing
                      for line in lines:
                          line = line.strip()
                          if line.startswith("=== ") and " ===" in line:
                              game['matchup'] = line.replace("===", "").strip()
                          elif line.startswith("Classification:"):
                              game['classification'] = line.replace("Classification:", "").strip()
                          elif line.startswith("Total Score:"):
                              game['total_score'] = line.replace("Total Score:", "").strip()
                          elif line.startswith("Confidence:"):
                              game['confidence'] = line.replace("Confidence:", "").strip().split('/')[0] # Clean up /10 if present
                          elif line.startswith("Recommendation:"):
                              game['recommendation'] = line.replace("Recommendation:", "").strip()
                      
                      # Detailed section parsing
                      game['sharp_stories'] = []
                      game['referee_context'] = []
                      game['weather'] = ""
                      game['injury'] = ""
                      game['situational'] = []
                      game['statistical'] = []
                      game['market'] = []
                      
                      current_section = None
                      for line in lines:
                          line = line.strip()
                          
                          if "SHARP MONEY STORY:" in line:
                              current_section = "sharp"
                          elif "REFEREE CONTEXT:" in line:
                              current_section = "referee"
                          elif "WEATHER IMPACT:" in line:
                              current_section = "weather"
                          elif "INJURY ANALYSIS:" in line:
                              current_section = "injury"
                          elif "SITUATIONAL FACTORS:" in line:
                              current_section = "situational"
                          elif "STATISTICAL EDGE:" in line:
                              current_section = "statistical"
                          elif "MARKET DYNAMICS:" in line:
                              current_section = "market"
                          elif "THE VERDICT:" in line:
                              current_section = "verdict" # Stop parsing bullet points after verdict
                          
                          # Extract bullet points/data
                          elif (line.startswith("‚Ä¢") or line.startswith("‚Üí") or line.startswith("-")) and current_section and current_section != "verdict":
                              content_line = line[1:].strip()
                              
                              if current_section == "sharp":
                                  game['sharp_stories'].append(content_line)
                              elif current_section == "referee":
                                  game['referee_context'].append(content_line)
                              elif current_section == "situational":
                                  game['situational'].append(content_line)
                              elif current_section == "statistical":
                                  game['statistical'].append(content_line)
                              elif current_section == "market":
                                  game['market'].append(content_line)
                              
                              # Specific handling for non-list items
                              elif current_section == "weather" and content_line and not game['weather']: # Only set if not already set
                                  game['weather'] = content_line
                              elif current_section == "injury" and "Impact:" in line:
                                  game['injury'] = line.split("Impact:")[-1].strip()
                                  
                      if game.get('matchup'):
                          games.append(game)
                          
              return games
          
          games = parse_game_sections(pro_analysis_content)
          
          # Calculate summary stats
          blue_chip = [g for g in games if "üîµ BLUE CHIP" in g.get('classification', '')]
          targeted = [g for g in games if "üéØ TARGETED" in g.get('classification', '')]
          traps = [g for g in games if "‚ùå FADE" in g.get('classification', '') or "‚ö†Ô∏è LANDMINE" in g.get('classification', '')]
          total_games = len(games)
          
          # --- HTML GENERATION (Restored and Refined) ---
          def generate_game_card(game):
              classification = game.get('classification', '')
              
              # Determine card styling
              if "üîµ BLUE CHIP" in classification:
                  card_class = "border-left: 5px solid #2196F3; background: #e3f2fd;"
                  badge_color = "#2196F3"
                  emoji = "üîµ"
              elif "üéØ TARGETED" in classification:
                  card_class = "border-left: 5px solid #ff9800; background: #fff3e0;"
                  badge_color = "#ff9800"
                  emoji = "üéØ"
              elif "‚ùå FADE" in classification or "‚ö†Ô∏è LANDMINE" in classification:
                  card_class = "border-left: 5px solid #f44336; background: #ffebee;"
                  badge_color = "#f44336"
                  emoji = "‚ùå"
              else:
                  card_class = "border-left: 5px solid #666; background: #f5f5f5;"
                  badge_color = "#666"
                  emoji = "üìà"
              
              # Combine all bullet-point factors for a concise "Other Factors" list
              other_factors = []
              if game.get('weather'):
                  other_factors.append(f"<strong>Weather:</strong> {game['weather']}")
              if game.get('injury'):
                  other_factors.append(f"<strong>Injury Impact:</strong> {game['injury']}")
              if game.get('situational'):
                  other_factors.extend([f"<strong>Situational:</strong> {factor}" for factor in game['situational'][:2]])
              if game.get('statistical'):
                  other_factors.extend([f"<strong>Statistical:</strong> {factor}" for factor in game['statistical'][:2]])
              if game.get('market'):
                  other_factors.extend([f"<strong>Market:</strong> {factor}" for factor in game['market'][:2]])
              
              factors_html = ""
              if other_factors:
                  factors_html += """
                  <div style="background: white; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #34495e; font-size: 15px;">üìä Additional Context</h4>
                  """
                  for factor in other_factors[:4]: # Limit to 4 factors
                      factors_html += f"<p style='margin: 3px 0; font-size: 13px;'>‚Ä¢ {factor}</p>"
                  factors_html += "</div>"
                  
              sharp_html = ""
              if game.get('sharp_stories'):
                  sharp_html += """
                  <div style="background: white; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #e65100; font-size: 15px;">üí∞ Sharp Money Analysis</h4>
                  """
                  for story in game['sharp_stories'][:3]: # Top 3 stories
                      sharp_html += f"<p style='margin: 3px 0; font-size: 13px;'>‚Ä¢ {story}</p>"
                  sharp_html += "</div>"

              ref_html = ""
              if game.get('referee_context'):
                  ref_html += """
                  <div style="background: white; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #5d4e75; font-size: 15px;">‚öñÔ∏è Referee Context</h4>
                  """
                  for context in game['referee_context'][:2]: # Top 2 contexts
                      ref_html += f"<p style='margin: 3px 0; font-size: 13px;'>‚Ä¢ {context}</p>"
                  ref_html += "</div>"
              
              
              card_html = f"""
              <div class="game-card" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; {card_class}">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                      <h3 style="margin: 0; color: #2c3e50; font-size: 20px;">{emoji} {game.get('matchup', 'N/A')}</h3>
                      <span style="background: {badge_color}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                          {classification}
                      </span>
                  </div>
                  
                  <div style="background: #f0f0f0; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #1976D2; font-size: 16px;">
                          Prediction: {game.get('recommendation', 'No recommendation')}
                      </h4>
                      <div style="display: flex; gap: 20px; font-size: 14px;">
                          <span><strong>Total Score:</strong> {game.get('total_score', 'N/A')}</span>
                          <span><strong>Confidence:</strong> {game.get('confidence', 'N/A')}/10</span>
                      </div>
                  </div>
                  
                  {sharp_html}
                  {ref_html}
                  {factors_html}
                  
              </div>
              """
              return card_html
          
          
          # Build HTML email
          flip_section = ""
          if flip_alert:
              flip_section = f"""
              <div style="background:#fff3cd; padding:15px; border-left:4px solid #ffc107; margin:20px 0;">
                  <h3 style="margin-top:0;">‚ö†Ô∏è Line Movement Alert</h3>
                  <p><b>{flip_alert}</b></p>
                  <p>Analysis has been updated to reflect new line movements.</p>
              </div>
              """
          
          game_cards_html = "".join([generate_game_card(game) for game in games])
          
          html_body = f"""<html>
          <head>
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                  @media only screen and (max-width: 600px) {{
                      .container {{ padding: 10px !important; }}
                      .game-card {{ margin: 10px 0 !important; padding: 15px !important; }}
                      .stats-grid {{ grid-template-columns: 1fr !important; }}
                  }}
                  /* Ensure links in the download section look like buttons */
                  .download-link {{
                      display:inline-block; padding:12px 24px; background:#0066cc; color:white; text-decoration:none; border-radius:5px; font-weight:bold; margin-top: 10px;
                  }}
              </style>
          </head>
          <body style="font-family:Arial, sans-serif; line-height:1.6; margin:0; padding:0; background-color: #f5f5f5;">
          <div class="container" style="max-width: 800px; margin: 0 auto; background: white; padding: 20px;">
          
          <div style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h1 style="margin: 0 0 10px 0;">üèà NFL Week {week} - {analysis_type}</h1>
              <p style="margin: 0; opacity: 0.9;">Generated: {timestamp}</p>
          </div>
          
          {flip_section}
          
          <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin:20px 0;">
              <h2 style="margin-top:0; color:#0066cc;">üìä Week {week} Executive Summary</h2>
              <div class="stats-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px; margin: 15px 0;">
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #2196F3;">
                      <div style="font-size:24px; font-weight:bold; color:#2196F3;">{len(blue_chip)}</div>
                      <div style="font-weight:bold;">üîµ BLUE CHIP</div>
                      <div style="font-size:12px; color:#666;">Highest Confidence</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #ff9800;">
                      <div style="font-size:24px; font-weight:bold; color:#ff9800;">{len(targeted)}</div>
                      <div style="font-weight:bold;">üéØ TARGETED</div>
                      <div style="font-size:12px; color:#666;">Good Value Plays</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4(total_games)} games.

                  """ if total_games > 0 else "<p>No games analyzed in this report.</p>"

            conversational_body = f"""
            <html>
            <body style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; background-color: #f9f9f9;">
                <div style="max-width: 600px; margin: 20px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
                    <div style="background-color: #0056b3; color: white; padding: 25px; text-align: center;">
                        <h1 style="margin: 0; font-size: 24px;">üëã Quick Hit: Week {week} NFL {analysis_type}</h1>
                        <p style="margin: 5px 0 0; font-size: 14px; opacity: 0.9;">Generated: {timestamp}</p>
                    </div>
                    <div style="padding: 25px;">
                        <p style="font-size: 15px; color: #555;">Hi Team,</p>
                        <p style="font-size: 15px; color: #555;">{intro_text}</p>
                        
                        {flip_section_conversational}

                        <h2 style="color: #0056b3; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 25px; font-size: 20px;">üéØ My Top Plays for Week {week}</h2>
                        {plays_intro}
                        {plays_html_conversational}

                        <h2 style="color: #d9534f; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 30px; font-size: 20px;">‚ùå Games to Fade / Avoid</h2>
                        {fades_intro}
                        {fades_html_conversational}

                        <p style="margin-top: 30px; font-size: 14px; color: #777;">
                            For the full, detailed breakdown, including all game cards and comprehensive data files, please refer to the attached **Professional Analysis & Data Package**.
                        </p>
                        <p style="font-size: 14px; color: #777;">
                            Good luck this week!
                        </p>
                        <p style="font-size: 14px; color: #777; margin-top: 20px;">Best,</p>
                        <p style="font-size: 14px; color: #777;">Your NFL Analysis Bot</p>
                    </div>
                    <div style="background-color: #f0f0f0; padding: 15px; text-align: center; font-size: 12px; color: #777; border-top: 1px solid #e7e7e7;">
                        <p style="margin: 0;">Automated NFL Analysis System | Week {week} {analysis_type} | {timestamp}</p>
                    </div>
                </div>
            </body>
            </html>
            """
            
            # --- EMAIL ASSEMBLY FOR CONVERSATIONAL EMAIL ---
            msg_conv = MIMEMultipart()
            msg_conv['Subject'] = f"Quick Hit: {subject_prefix} Week {week} NFL Plays & Fades" # Use dynamic subject prefix
            msg_conv['From'] = os.getenv('GMAIL_USER')
            msg_conv['To'] = "lvarughese@gmail.com" # Can be different recipient for conversational
            
            msg_conv.attach(MIMEText(conversational_body, 'html', 'utf-8'))
            
            # No attachments for conversational email, just plain text if needed
            
            server_conv = smtplib.SMTP('smtp.gmail.com', 587)
            server_conv.starttls()
            server_conv.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
            server_conv.send_message(msg_conv)
            server_conv.quit()
            
            print(f"‚úÖ Conversational email sent: Week {week}")
            PYTHON_EOF
      
      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: week-${{ steps.get_week.outputs.week }}-analysis
          path: |
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_executive_summary.txt
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_pro_analysis.txt
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.csv
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.json
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_referee_trends.txt
          retention-days: 30
      
      - name: Commit Pro Analysis
        run: |
          # 1. Configuration
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 2. Stage ALL changes (-A) and attempt the initial commit.
          # Use "|| true" to prevent the step from failing if there are no changes to commit initially.
          git add -A || true 
          # Use dynamic analysis_type for the commit message
          git commit -m "üìä Week ${{ steps.get_week.outputs.week }} pro analysis - ${{ steps.analysis_type.outputs.type }}" || echo "No new analysis changes to commit initially."
          
          # 3. Defensive Cleanup: Amend any new changes to ensure a clean commit.
          # This is important if initial commit found no changes but new files were generated,
          # or if changes were introduced between git add and git commit.
          # The --allow-empty flag ensures this step doesn't fail even if no changes are detected for amendment.
          git add -A
          git commit --amend --no-edit --allow-empty || true 
      
          # 4. Integrate remote changes with conflict handling
          # Fetch latest remote state
          git fetch origin
          
          # Attempt rebase; if it fails (due to conflicts), execute the block in curly braces.
          # This handles cases where changes were pushed to 'main' by another workflow or directly
          # while this workflow was running.
          git rebase origin/main || {
              echo "Rebase conflict detected. Attempting to resolve generated files automatically."
              
              # Resolve: For generated files, we typically want to take 'OURS' (the version generated by this workflow)
              # and discard 'THEIRS' (any conflicting version from the remote).
              # CRITICAL FIX: Dynamically specify the week number for all generated files.
              git checkout --ours data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_executive_summary.txt || true
              git checkout --ours data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_pro_analysis.txt || true
              git checkout --ours data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.csv || true
              git checkout --ours data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.json || true
              git checkout --ours data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_referee_trends.txt || true
              
              # Stage the resolved files so Git knows they've been handled.
              git add data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_executive_summary.txt
              git add data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_pro_analysis.txt
              git add data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.csv
              git add data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.json
              git add data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_referee_trends.txt
              
              # Continue the rebase, completing the operation now that conflicts are resolved.
              git rebase --continue || {
                  echo "ERROR: Failed to continue rebase after automatic conflict resolution. Manual intervention may be needed."
                  exit 1
              }
          }
          
          # 5. Push the resulting changes to the remote 'main' branch.
          # The --force-with-lease is safer than --force as it prevents overwriting others' work
          # if they pushed changes while the rebase was being resolved.
          git push --force-with-lease
      
      - name: Summary
        run: |
          echo "‚úÖ Pro Analysis Complete!"
          echo "üìß Email sent: ${{ steps.analysis_type.outputs.type }}"
          echo "üìÅ Analysis files:"
          ls -lh data/week${{ steps.get_week.outputs.week }}/*.txt data/week${{ steps.get_week.outputs.week }}/*.csv data/week${{ steps.get_week.outputs.week }}/*.json 2>/dev/null || true
