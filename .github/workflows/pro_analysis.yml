name: 4. Pro Analysis & Email

on:
  repository_dispatch:
    types: [market-data-ready]
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        type: number

jobs:
  generate_analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main
      
      - name: Pull latest changes
        run: git pull origin main
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install pandas numpy
      
      - name: Get Week Number
        id: get_week
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK=${{ github.event.inputs.week }}
          elif [ -n "${{ github.event.client_payload.week }}" ]; then
            WEEK=${{ github.event.client_payload.week }}
          else
            # Auto-detect from existing files
            WEEK=$(ls data/week*/week*_referees.csv 2>/dev/null | grep -oP 'week\K[0-9]+' | sort -n | tail -1)
          fi
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "üìÖ Generating analysis for Week $WEEK"
      
      - name: Get Analysis Type
        id: analysis_type
        run: |
          TYPE="${{ github.event.client_payload.analysis_type }}"
          FLIPS="${{ github.event.client_payload.line_flips }}"
          
          if [ "$TYPE" = "initial" ]; then
            echo "type=Initial Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üèà Initial" >> $GITHUB_OUTPUT
          else
            echo "type=Updated Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üìä Updated" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$FLIPS" ] && [ "$FLIPS" != "0" ]; then
            echo "flip_alert=üö® $FLIPS line flip(s) detected and processed" >> $GITHUB_OUTPUT
          else
            echo "flip_alert=" >> $GITHUB_OUTPUT
          fi
      
      - name: Get Timestamp
        id: timestamp
        run: echo "time=$(date '+%Y-%m-%d %I:%M %p ET')" >> $GITHUB_OUTPUT
      
      - name: Run Pro Analyzer
        run: |
          echo "üî¨ Running Pro Analysis Engine..."
          python3 nfl_pro_analyzer.py ${{ steps.get_week.outputs.week }}
      
      - name: Prepare Email Content
        run: |
          WEEK="${{ steps.get_week.outputs.week }}"
          
          # Load all report content
          REF_DIGEST=$(cat week${WEEK}_referee_trends.txt 2>/dev/null || echo "Referee trends not available")
          EXEC_SUMMARY=$(cat week${WEEK}_executive_summary.txt 2>/dev/null || echo "Executive summary not available")
          
          # Escape HTML
          REF_DIGEST_ESCAPED=$(printf '%s\n' "$REF_DIGEST" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
          EXEC_SUMMARY_ESCAPED=$(printf '%s\n' "$EXEC_SUMMARY" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
          
          # Save to env
          echo "REFEREE_DIGEST<<EOF" >> $GITHUB_ENV
          echo "$REF_DIGEST_ESCAPED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "EXEC_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$EXEC_SUMMARY_ESCAPED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
      - name: Send Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'PYTHON_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          import os
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          analysis_type = "${{ steps.analysis_type.outputs.type }}"
          flip_alert = "${{ steps.analysis_type.outputs.flip_alert }}"
          ref_digest = """${{ env.REFEREE_DIGEST }}"""
          exec_summary = """${{ env.EXEC_SUMMARY }}"""
          
          # Build HTML email
          flip_section = ""
          if flip_alert:
              flip_section = f"""
              <div style="background:#fff3cd; padding:15px; border-left:4px solid #ffc107; margin:20px 0;">
                  <h3 style="margin-top:0;">‚ö†Ô∏è Line Movement Alert</h3>
                  <p><b>{flip_alert}</b></p>
                  <p>Referee trend queries have been updated to reflect the new favorite/dog status.</p>
              </div>
              """
          
          html_body = f"""<html>
          <body style="font-family:Arial, sans-serif; line-height:1.6;">
          <h1>üèà NFL Week {week} - {analysis_type}</h1>
          <p>Generated: <b>{timestamp}</b></p>
          
          {flip_section}
          
          <div style="background:#e8f4f8; padding:15px; border-left:4px solid #0066cc; margin:20px 0;">
              <h2 style="margin-top:0;">üìä Sharp Money Intelligence</h2>
              <ul>
                  <li><b>Multi-Market Analysis:</b> Spread + Total + Moneyline consensus</li>
                  <li><b>Divergence Detection:</b> When sharps target opposite sides</li>
                  <li><b>Trap Game Alerts:</b> Public vs. sharp money discrepancies</li>
                  <li><b>Line-Flip Tracking:</b> Automatic referee trend updates</li>
              </ul>
          </div>
          
          <h2>‚≠ê EXECUTIVE SUMMARY</h2>
          <pre style="background:#f4f4f4; padding:15px; border-radius:6px; white-space:pre-wrap; font-size:13px;">{exec_summary}</pre>
          
          <h2>üßë‚Äç‚öñÔ∏è Referee Trends</h2>
          <pre style="background:#f4f4f4; padding:15px; border-radius:6px; white-space:pre-wrap; font-size:12px;">{ref_digest}</pre>
          
          <h3>üì• Download Full Reports</h3>
          <p><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">
             Click here to download complete analysis package (CSV/JSON)
          </a></p>
          
          <div style="background:#f8f9fa; padding:10px; border-left:4px solid #6c757d; margin:20px 0;">
              <p style="margin:0;"><b>üí° Quick Start:</b> Executive Summary shows top plays. Full Pro Analysis available in GitHub artifacts.</p>
          </div>
          
          <p style="color:#666; font-size:12px; margin-top:30px;">
              Automated NFL Betting Intelligence System<br>
              Week {week} {analysis_type}
          </p>
          </body>
          </html>"""
          
          msg = MIMEMultipart('alternative')
          msg['Subject'] = f"${{ steps.analysis_type.outputs.subject_prefix }} NFL Week {week} Analysis - Sharp Money Intelligence"
          msg['From'] = os.getenv('GMAIL_USER')
          msg['To'] = "lvarughese@gmail.com"
          
          html_part = MIMEText(html_body, 'html', 'utf-8')
          msg.attach(html_part)
          
          server = smtplib.SMTP('smtp.gmail.com', 587)
          server.starttls()
          server.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
          server.send_message(msg)
          server.quit()
          
          print(f"‚úÖ Email sent: {analysis_type} for Week {week}")
          PYTHON_EOF
      
      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: week-${{ steps.get_week.outputs.week }}-analysis
          path: |
            week${{ steps.get_week.outputs.week }}_executive_summary.txt
            week${{ steps.get_week.outputs.week }}_pro_analysis.txt
            week${{ steps.get_week.outputs.week }}_analytics.csv
            week${{ steps.get_week.outputs.week }}_analytics.json
            week${{ steps.get_week.outputs.week }}_referee_trends.txt
          retention-days: 30
      
      - name: Commit Analysis Files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add week${{ steps.get_week.outputs.week }}_executive_summary.txt \
                  week${{ steps.get_week.outputs.week }}_pro_analysis.txt \
                  week${{ steps.get_week.outputs.week }}_analytics.csv \
                  week${{ steps.get_week.outputs.week }}_analytics.json || true
          git commit -m "üìä Week ${{ steps.get_week.outputs.week }} pro analysis - ${{ steps.analysis_type.outputs.type }}" || echo "No changes"
          git push
      
      - name: Summary
        run: |
          echo "‚úÖ Pro Analysis Complete!"
          echo "üìß Email sent: ${{ steps.analysis_type.outputs.type }}"
          echo "üìÅ Analysis files:"
          ls -lh week${{ steps.get_week.outputs.week }}_*.txt week${{ steps.get_week.outputs.week }}_*.csv week${{ steps.get_week.outputs.week }}_*.json 2>/dev/null || true
