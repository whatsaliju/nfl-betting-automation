name: 4. Pro Analysis & Email

on:
  repository_dispatch:
    types: [market-data-ready]
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        type: string

jobs:
  generate_analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main
      
      - name: Pull latest changes
        run: git pull origin main
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: pip install pandas numpy
      
      - name: Get Week Number
        id: get_week
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
            WEEK="${WEEK%.*}"
          elif [ -n "${{ github.event.client_payload.week }}" ]; then
            WEEK="${{ github.event.client_payload.week }}"
            WEEK="${WEEK%.*}"
          else
            # Auto-detect from existing files
            WEEK=$(ls data/week*/week*_referees.csv 2>/dev/null | grep -oP 'week\K[0-9]+' | sort -n | tail -1)
          fi
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "üìÖ Generating analysis for Week $WEEK"
      
      - name: Get Analysis Type
        id: analysis_type
        run: |
          TYPE="${{ github.event.client_payload.analysis_type }}"
          FLIPS="${{ github.event.client_payload.line_flips }}"
          
          if [ "$TYPE" = "initial" ]; then
            echo "type=Initial Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üèà Initial" >> $GITHUB_OUTPUT
          else
            echo "type=Updated Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üìä Updated" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$FLIPS" ] && [ "$FLIPS" != "0" ]; then
            echo "flip_alert=üö® $FLIPS line flip(s) detected and processed" >> $GITHUB_OUTPUT
          else
            echo "flip_alert=" >> $GITHUB_OUTPUT
          fi
      
      - name: Get Timestamp
        id: timestamp
        run: echo "time=$(date '+%Y-%m-%d %I:%M %p ET')" >> $GITHUB_OUTPUT
      
      - name: Run Pro Analyzer
        run: |
          echo "üî¨ Running Pro Analysis Engine..."
          python3 analyzers/nfl_pro_analyzer.py ${{ steps.get_week.outputs.week }}
      
      - name: Send Enhanced Professional Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'PYTHON_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          import os
          import re
          import json
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          analysis_type = "${{ steps.analysis_type.outputs.type }}"
          flip_alert = "${{ steps.analysis_type.outputs.flip_alert }}"
          
          # Load detailed pro analysis
          try:
              with open(f"data/week{week}/week{week}_pro_analysis.txt", "r") as f:
                  pro_analysis_content = f.read()
          except:
              pro_analysis_content = "Pro analysis file not found"
          
          # Load analytics JSON for stats
          try:
              with open(f"data/week{week}/week{week}_analytics.json", "r") as f:
                  analytics_data = json.load(f)
          except:
              analytics_data = []
          
          # Parse game sections from pro analysis
          def parse_game_sections(content):
              games = []
              # Split by game divider
              game_sections = content.split("======================================================================")
              
              for section in game_sections:
                  if "===" in section and "Classification:" in section:
                      game = {}
                      lines = section.strip().split('\n')
                      
                      for line in lines:
                          line = line.strip()
                          if line.startswith("=== ") and " ===" in line:
                              game['matchup'] = line.replace("===", "").strip()
                          elif line.startswith("Classification:"):
                              game['classification'] = line.replace("Classification:", "").strip()
                          elif line.startswith("Total Score:"):
                              game['total_score'] = line.replace("Total Score:", "").strip()
                          elif line.startswith("Confidence:"):
                              game['confidence'] = line.replace("Confidence:", "").strip()
                          elif line.startswith("Recommendation:"):
                              game['recommendation'] = line.replace("Recommendation:", "").strip()
                      
                      # Extract sections
                      game['sharp_stories'] = []
                      game['referee_context'] = []
                      game['weather'] = ""
                      game['injury'] = ""
                      game['situational'] = []
                      game['statistical'] = []
                      game['market'] = []
                      
                      current_section = None
                      for line in lines:
                          line = line.strip()
                          if "SHARP MONEY STORY:" in line:
                              current_section = "sharp"
                          elif "REFEREE CONTEXT:" in line:
                              current_section = "referee"
                          elif "WEATHER IMPACT:" in line:
                              current_section = "weather"
                          elif "INJURY ANALYSIS:" in line:
                              current_section = "injury"
                          elif "SITUATIONAL FACTORS:" in line:
                              current_section = "situational"
                          elif "STATISTICAL EDGE:" in line:
                              current_section = "statistical"
                          elif "MARKET DYNAMICS:" in line:
                              current_section = "market"
                          elif "THE VERDICT:" in line:
                              current_section = "verdict"
                          elif line.startswith("  ‚Ä¢") or line.startswith("  ‚Üí"):
                              content_line = line[3:].strip()
                              if current_section == "sharp":
                                  game['sharp_stories'].append(content_line)
                              elif current_section == "referee":
                                  game['referee_context'].append(content_line)
                              elif current_section == "situational":
                                  game['situational'].append(content_line)
                              elif current_section == "statistical":
                                  game['statistical'].append(content_line)
                              elif current_section == "market":
                                  game['market'].append(content_line)
                          elif current_section == "weather" and line.startswith("  ‚Ä¢"):
                              game['weather'] = line[3:].strip()
                          elif current_section == "injury" and "Impact:" in line:
                              game['injury'] = line.split("Impact:")[-1].strip()
                      
                      if game.get('matchup'):
                          games.append(game)
              
              return games
          
          games = parse_game_sections(pro_analysis_content)
          
          # Calculate summary stats
          blue_chip = [g for g in games if "üîµ BLUE CHIP" in g.get('classification', '')]
          targeted = [g for g in games if "üéØ TARGETED" in g.get('classification', '')]
          traps = [g for g in games if "üö® TRAP" in g.get('classification', '')]
          total_games = len(games)
          
          # Generate game cards HTML
          def generate_game_card(game):
              classification = game.get('classification', '')
              
              # Determine card styling
              if "üîµ BLUE CHIP" in classification:
                  card_class = "border-left: 5px solid #2196F3; background: #e3f2fd;"
                  badge_color = "#2196F3"
              elif "üéØ TARGETED" in classification:
                  card_class = "border-left: 5px solid #ff9800; background: #fff3e0;"
                  badge_color = "#ff9800"
              elif "üö® TRAP" in classification:
                  card_class = "border-left: 5px solid #f44336; background: #ffebee;"
                  badge_color = "#f44336"
              elif "üìä LEAN" in classification:
                  card_class = "border-left: 5px solid #9c27b0; background: #f3e5f5;"
                  badge_color = "#9c27b0"
              else:
                  card_class = "border-left: 5px solid #666; background: #f5f5f5;"
                  badge_color = "#666"
              
              card_html = f"""
              <div style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; {card_class}">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                      <h3 style="margin: 0; color: #2c3e50; font-size: 20px;">{game.get('matchup', '')}</h3>
                      <span style="background: {badge_color}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                          {classification}
                      </span>
                  </div>
                  
                  <div style="background: white; padding: 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 10px 0; color: #1976D2; font-size: 16px;">
                          {game.get('recommendation', 'No recommendation')}
                      </h4>
                      <div style="display: flex; gap: 20px; font-size: 14px;">
                          <span><strong>Total Score:</strong> {game.get('total_score', 'N/A')}</span>
                          <span><strong>Confidence:</strong> {game.get('confidence', 'N/A')}/10</span>
                      </div>
                  </div>
              """
              
              # Sharp Money Analysis
              if game.get('sharp_stories'):
                  card_html += """
                  <div style="background: white; padding: 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 10px 0; color: #e65100;">üí∞ Sharp Money Analysis</h4>
              """
                  for story in game['sharp_stories'][:3]:  # Top 3 stories
                      card_html += f"<p style='margin: 5px 0; font-size: 14px;'>‚Ä¢ {story}</p>"
                  card_html += "</div>"
              
              # Referee Context
              if game.get('referee_context'):
                  card_html += """
                  <div style="background: white; padding: 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 10px 0; color: #5d4e75;">‚öñÔ∏è Referee Context</h4>
              """
                  for context in game['referee_context']:
                      card_html += f"<p style='margin: 5px 0; font-size: 14px;'>{context}</p>"
                  card_html += "</div>"
              
              # Other Factors (Weather, Injury, Situational, etc.)
              other_factors = []
              if game.get('weather'):
                  other_factors.append(f"<strong>Weather:</strong> {game['weather']}")
              if game.get('injury'):
                  other_factors.append(f"<strong>Injury Impact:</strong> {game['injury']}")
              if game.get('situational'):
                  other_factors.extend([f"<strong>Situational:</strong> {factor}" for factor in game['situational'][:2]])
              if game.get('statistical'):
                  other_factors.extend([f"<strong>Statistical:</strong> {factor}" for factor in game['statistical'][:2]])
              if game.get('market'):
                  other_factors.extend([f"<strong>Market:</strong> {factor}" for factor in game['market'][:2]])
              
              if other_factors:
                  card_html += """
                  <div style="background: white; padding: 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 10px 0; color: #34495e;">üìä Additional Factors</h4>
              """
                  for factor in other_factors[:4]:  # Limit to 4 factors to avoid clutter
                      card_html += f"<p style='margin: 5px 0; font-size: 14px;'>‚Ä¢ {factor}</p>"
                  card_html += "</div>"
              
              card_html += "</div>"
              return card_html
          
          # Build HTML email
          flip_section = ""
          if flip_alert:
              flip_section = f"""
              <div style="background:#fff3cd; padding:15px; border-left:4px solid #ffc107; margin:20px 0;">
                  <h3 style="margin-top:0;">‚ö†Ô∏è Line Movement Alert</h3>
                  <p><b>{flip_alert}</b></p>
                  <p>Analysis has been updated to reflect new line movements.</p>
              </div>
              """
          
          html_body = f"""<html>
          <head>
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                  @media only screen and (max-width: 600px) {{
                      .container {{ padding: 10px !important; }}
                      .game-card {{ margin: 10px 0 !important; padding: 15px !important; }}
                      .stats-grid {{ grid-template-columns: 1fr !important; }}
                  }}
              </style>
          </head>
          <body style="font-family:Arial, sans-serif; line-height:1.6; margin:0; padding:0; background-color: #f5f5f5;">
          <div class="container" style="max-width: 800px; margin: 0 auto; background: white; padding: 20px;">
          
          <div style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h1 style="margin: 0 0 10px 0;">üèà NFL Week {week} - {analysis_type}</h1>
              <p style="margin: 0; opacity: 0.9;">Generated: {timestamp}</p>
          </div>
          
          {flip_section}
          
          <!-- EXECUTIVE DASHBOARD -->
          <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin:20px 0;">
              <h2 style="margin-top:0; color:#0066cc;">üìä Week {week} Executive Summary</h2>
              <div class="stats-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px; margin: 15px 0;">
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #2196F3;">
                      <div style="font-size:24px; font-weight:bold; color:#2196F3;">{len(blue_chip)}</div>
                      <div style="font-weight:bold;">üîµ BLUE CHIP</div>
                      <div style="font-size:12px; color:#666;">Highest Confidence</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #ff9800;">
                      <div style="font-size:24px; font-weight:bold; color:#ff9800;">{len(targeted)}</div>
                      <div style="font-weight:bold;">üéØ TARGETED</div>
                      <div style="font-size:12px; color:#666;">Good Value Plays</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #f44336;">
                      <div style="font-size:24px; font-weight:bold; color:#f44336;">{len(traps)}</div>
                      <div style="font-weight:bold;">üö® TRAP GAMES</div>
                      <div style="font-size:12px; color:#666;">Fade the Public</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #666;">
                      <div style="font-size:24px; font-weight:bold; color:#666;">{total_games}</div>
                      <div style="font-weight:bold;">üìà TOTAL GAMES</div>
                      <div style="font-size:12px; color:#666;">Full Analysis</div>
                  </div>
              </div>
          </div>
          
          <!-- DETAILED GAME ANALYSIS -->
          <div style="margin: 30px 0;">
              <h2 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                  üéØ Complete Game-by-Game Analysis
              </h2>
              <p style="color: #7f8c8d; margin-bottom: 25px;">
                  Comprehensive breakdown of all {total_games} games with sharp money analysis, referee trends, 
                  situational factors, and confidence scores.
              </p>
          """
          
          # Add all game cards
          for game in games:
              html_body += generate_game_card(game)
          
          html_body += f"""
          </div>
          
          <!-- DOWNLOAD SECTION -->
          <div style="text-align:center; padding:25px; background:#f8f9fa; border-radius:8px; margin:30px 0;">
              <h3 style="margin-top:0; color:#2c3e50;">üìÅ Complete Analysis Package</h3>
              <p style="color:#666; margin: 10px 0;">Download detailed files for deeper analysis or AI consultation:</p>
              
              <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0;">
                  <span style="background: #e8f5e8; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                      üìä week{week}_analytics.csv - Data Spreadsheet
                  </span>
                  <span style="background: #fff3e0; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                      üìù week{week}_pro_analysis.txt - Complete Text Analysis  
                  </span>
                  <span style="background: #f3e5f5; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                      ü§ñ week{week}_analytics.json - AI-Ready Raw Data
                  </span>
              </div>
              
              <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                 style="display:inline-block; padding:12px 24px; background:#0066cc; color:white; text-decoration:none; border-radius:5px; font-weight:bold; margin-top: 10px;">
                 üîΩ Download All Files
              </a>
          </div>
          
          <!-- FOOTER -->
          <div style="border-top:1px solid #ddd; padding-top:15px; margin-top:30px; font-size:12px; color:#666;">
              <p><b>ü§ñ Analysis Engine:</b> 8-layer system covering sharp money, referee trends, weather, injuries, situational factors, statistical modeling, game theory, and schedule analysis</p>
              <p><b>üìä Data Sources:</b> Action Network, Football Zebras, RotoWire, SDQL Historical Database</p>
              <p><b>‚è∞ Generated:</b> {timestamp} | Week {week} {analysis_type}</p>
          </div>
          
          </div>
          </body>
          </html>"""
          
          msg = MIMEMultipart('alternative')
          msg['Subject'] = f"üèà Week {week} Enhanced Analysis - {len(blue_chip)} Blue Chip + {len(targeted)} Targeted Plays"
          msg['From'] = os.getenv('GMAIL_USER')
          msg['To'] = "lvarughese@gmail.com"
          
          html_part = MIMEText(html_body, 'html', 'utf-8')
          msg.attach(html_part)
          
          server = smtplib.SMTP('smtp.gmail.com', 587)
          server.starttls()
          server.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
          server.send_message(msg)
          server.quit()
          
          print(f"‚úÖ Enhanced email sent: {analysis_type} for Week {week}")
          print(f"üìß Games included: {total_games} total ({len(blue_chip)} Blue Chip, {len(targeted)} Targeted, {len(traps)} Traps)")
          PYTHON_EOF
      
      - name: Send Conversational Analysis Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'PYTHON_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          import os
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          analysis_type = "${{ steps.analysis_type.outputs.type }}"
          
          # Build conversational HTML email
          html_body = f"""<html>
          <body style="font-family: Georgia, serif; line-height: 1.8; max-width: 700px; margin: 0 auto; padding: 20px; color: #333;">
          
          <h1 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
              Week {week} NFL Analysis - Conversational Brief
          </h1>
          <p style="color: #7f8c8d; font-style: italic;">{timestamp}</p>
          
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h2 style="color: #2c3e50; margin-top: 0;">What I'm seeing this week</h2>
              
              <p>Looking at Week {week}, a few things jump out right away. The sharp money is unusually concentrated 
              on a handful of games, while the public seems to be chasing some obvious narratives that might not hold up. 
              Weather is going to be a factor in at least two outdoor games, and we've got some interesting scheduling 
              spots that create clear advantages.</p>
              
              <p>The referee assignments this week favor a couple of specific trends we've been tracking, particularly 
              around total movements. Overall, there are probably 3-4 games worth serious consideration and a couple 
              others we should definitely avoid.</p>
          </div>
          
          <h2 style="color: #2c3e50; border-bottom: 1px solid #bdc3c7; padding-bottom: 5px;">
              Walking through the week
          </h2>
          
          <!-- Thursday Night Football -->
          <div style="margin: 30px 0; padding: 20px; border-left: 4px solid #e74c3c; background: #fdf2f2;">
              <h3 style="color: #c0392b; margin-top: 0;">Thursday Night (8:15 PM ET)</h3>
              <p>Starting with Thursday night, we've got a game that's already played out by the time you read this, 
              but it sets the tone for what sharp bettors are thinking about primetime spots this week. The key 
              takeaway is watching how the market reacted to any late news or line movement.</p>
          </div>
          
          <!-- International Games -->
          <div style="margin: 30px 0; padding: 20px; border-left: 4px solid #9b59b6; background: #f8f4ff;">
              <h3 style="color: #8e44ad; margin-top: 0;">International Games (London/Germany/Mexico)</h3>
              <p>This week's international game presents some unique angles most bettors overlook. Teams playing 
              overseas deal with travel, time zone adjustments, and sometimes unfamiliar playing surfaces. The 
              public often doesn't properly factor in how these logistics affect performance, especially for teams 
              that haven't played internationally before.</p>
              
              <p>The early kickoff time (typically 9:30 AM ET for London games) can also create some interesting 
              under situations, as teams sometimes start slow while adjusting to the unusual schedule.</p>
          </div>
          
          <!-- Sunday 1:00 PM ET Games -->
          <div style="margin: 30px 0; padding: 20px; border-left: 4px solid #f39c12; background: #fef9e7;">
              <h3 style="color: #d68910; margin-top: 0;">Sunday Early Window (1:00 PM ET)</h3>
              <p>The early slate has some of the most interesting setups this week. Two games stand out where sharp 
              money is going against heavy public action. The first is a classic trap spot where a popular team 
              is getting way too much love from casual bettors, while the second involves a weather situation that 
              most people aren't properly factoring in.</p>
              
              <p>I'm particularly interested in the matchup with the bye week advantage - one team is coming off rest 
              while their opponent played a physical game just six days ago. The line hasn't moved enough to reflect 
              this edge, which creates some value.</p>
          </div>
          
          <!-- Sunday 4:00/4:25 PM ET Games -->
          <div style="margin: 30px 0; padding: 20px; border-left: 4px solid #27ae60; background: #eafaf1;">
              <h3 style="color: #229954; margin-top: 0;">Sunday Late Window (4:00-4:25 PM ET)</h3>
              <p>The late afternoon games are where I'm finding the best value this week. One game has a massive 
              sharp money edge that's been building all week - the kind of spot where professional bettors are 
              clearly seeing something the public isn't. The spread movement has been subtle but consistent.</p>
              
              <p>There's also a division game here that fits a pattern we've seen all season with this particular 
              referee. His games tend to stay under the total, especially when both teams have solid defenses. 
              The weather should be perfect, so it's not about conditions - just his tendencies.</p>
          </div>
          
          <!-- Sunday Night Football -->
          <div style="margin: 30px 0; padding: 20px; border-left: 4px solid #8e44ad; background: #f4f2f7;">
              <h3 style="color: #7d3c98; margin-top: 0;">Sunday Night Football (8:20 PM ET)</h3>
              <p>Sunday night brings us the marquee matchup that's been getting all the attention. This is exactly 
              the type of game where the public typically overreacts, and we're seeing that pattern play out in the 
              betting percentages. Sometimes the obvious play is obvious for a reason, but sometimes it's a trap.</p>
              
              <p>Based on the sharp money movement and some scheduling factors most people aren't considering, I lean 
              toward this being more of a fade spot than a play-with situation.</p>
          </div>
          
          <!-- Monday Night Football -->
          <div style="margin: 30px 0; padding: 20px; border-left: 4px solid #17a2b8; background: #e6f7ff;">
              <h3 style="color: #138496; margin-top: 0;">Monday Night Football (8:15 PM ET)</h3>
              <p>Wrapping up the week with Monday night, we have what might be the cleanest setup of the entire slate. 
              Everything seems to be pointing in one direction: the sharp money, the situational factors, even the 
              referee trends. When that many indicators align, it's usually worth paying attention.</p>
              
              <p>The only concern is whether the line will move throughout the week as more people catch on to what 
              we're seeing. But right now, there's clear value.</p>
          </div>
          
          <!-- Bottom Line -->
          <div style="background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin: 30px 0;">
              <h2 style="color: white; margin-top: 0;">Bottom Line</h2>
              <p>This week is about being selective. There are 2-3 spots where everything aligns nicely, and several 
              others where the public is getting things wrong. The key is not forcing action on every game just because 
              it's Sunday.</p>
              
              <p>Focus on the games with clear edges, avoid the obvious trap spots, and remember that the best weeks 
              are often the ones where you only play your strongest convictions.</p>
          </div>
          
          <!-- Footer -->
          <div style="border-top: 1px solid #bdc3c7; padding-top: 20px; margin-top: 30px; font-size: 14px; color: #7f8c8d;">
              <p><strong>Analysis includes:</strong> Sharp money tracking, referee tendencies, weather factors, 
              injury analysis, situational edges, statistical modeling, game theory, and schedule analysis.</p>
              
              <p><strong>Download detailed reports:</strong> 
              <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                 style="color: #3498db;">Complete analysis package</a></p>
              
              <p style="margin-bottom: 0;"><em>Week {week} {analysis_type} ‚Ä¢ Generated {timestamp}</em></p>
          </div>
          
          </body>
          </html>"""
          
          msg = MIMEMultipart('alternative')
          msg['Subject'] = f"Week {week} NFL Analysis - Conversational Brief"
          msg['From'] = os.getenv('GMAIL_USER')
          msg['To'] = "lvarughese@gmail.com"
          
          html_part = MIMEText(html_body, 'html', 'utf-8')
          msg.attach(html_part)
          
          server = smtplib.SMTP('smtp.gmail.com', 587)
          server.starttls()
          server.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
          server.send_message(msg)
          server.quit()
          
          print(f"‚úÖ Conversational email sent: Week {week}")
          PYTHON_EOF
      
      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: week-${{ steps.get_week.outputs.week }}-analysis
          path: |
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_executive_summary.txt
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_pro_analysis.txt
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.csv
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.json
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_referee_trends.txt
          retention-days: 30
      
      - name: Commit Analysis Files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/week${{ steps.get_week.outputs.week }}/ || true
          git commit -m "üìä Week ${{ steps.get_week.outputs.week }} pro analysis - ${{ steps.analysis_type.outputs.type }}" || echo "No changes"
          git push
      
      - name: Summary
        run: |
          echo "‚úÖ Pro Analysis Complete!"
          echo "üìß Email sent: ${{ steps.analysis_type.outputs.type }}"
          echo "üìÅ Analysis files:"
          ls -lh data/week${{ steps.get_week.outputs.week }}/*.txt data/week${{ steps.get_week.outputs.week }}/*.csv data/week${{ steps.get_week.outputs.week }}/*.json 2>/dev/null || true
