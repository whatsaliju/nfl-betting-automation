name: 4. Pro Analysis & Email

on:
  repository_dispatch:
    types: [market-data-ready]
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        type: string

jobs:
  generate_analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main
      
      - name: Pull latest changes
        run: git pull origin main
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: pip install pandas numpy
      
      - name: Get Week Number
        id: get_week
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
            WEEK="${WEEK%.*}"
          elif [ -n "${{ github.event.client_payload.week }}" ]; then
            WEEK="${{ github.event.client_payload.week }}"
            WEEK="${WEEK%.*}"
          else
            # Auto-detect from existing files
            WEEK=$(ls data/week*/week*_referees.csv 2>/dev/null | grep -oP 'week\K[0-9]+' | sort -n | tail -1)
          fi
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "üìÖ Generating analysis for Week $WEEK"
      
      - name: Get Analysis Type
        id: analysis_type
        run: |
          TYPE="${{ github.event.client_payload.analysis_type }}"
          FLIPS="${{ github.event.client_payload.line_flips }}"
          
          if [ "$TYPE" = "initial" ]; then
            echo "type=Initial Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üèà Initial" >> $GITHUB_OUTPUT
          else
            echo "type=Updated Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üìä Updated" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$FLIPS" ] && [ "$FLIPS" != "0" ]; then
            echo "flip_alert=üö® $FLIPS line flip(s) detected and processed" >> $GITHUB_OUTPUT
          else
            echo "flip_alert=" >> $GITHUB_OUTPUT
          fi
      
      - name: Get Timestamp
        id: timestamp
        run: echo "time=$(date '+%Y-%m-%d %I:%M %p ET')" >> $GITHUB_OUTPUT
      
      - name: Run Pro Analyzer
        run: |
          echo "üî¨ Running Pro Analysis Engine..."
          python3 analyzers/nfl_pro_analyzer.py ${{ steps.get_week.outputs.week }}
      
      - name: Prepare Email Content
        run: |
          WEEK="${{ steps.get_week.outputs.week }}"
          
          # Load all report content
          REF_DIGEST=$(cat data/week${WEEK}/week${WEEK}_referee_trends.txt 2>/dev/null || echo "Referee trends not available")
          EXEC_SUMMARY=$(cat data/week${WEEK}/week${WEEK}_executive_summary.txt 2>/dev/null || echo "Executive summary not available")
          
          # Escape HTML
          REF_DIGEST_ESCAPED=$(printf '%s\n' "$REF_DIGEST" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
          EXEC_SUMMARY_ESCAPED=$(printf '%s\n' "$EXEC_SUMMARY" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
          
          # Save to env
          echo "REFEREE_DIGEST<<EOF" >> $GITHUB_ENV
          echo "$REF_DIGEST_ESCAPED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "EXEC_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$EXEC_SUMMARY_ESCAPED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
      - name: Send Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'PYTHON_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          import os
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          analysis_type = "${{ steps.analysis_type.outputs.type }}"
          flip_alert = "${{ steps.analysis_type.outputs.flip_alert }}"
          ref_digest = """${{ env.REFEREE_DIGEST }}"""
          exec_summary = """${{ env.EXEC_SUMMARY }}"""
          
          # Build HTML email
          flip_section = ""
          if flip_alert:
              flip_section = f"""
              <div style="background:#fff3cd; padding:15px; border-left:4px solid #ffc107; margin:20px 0;">
                  <h3 style="margin-top:0;">‚ö†Ô∏è Line Movement Alert</h3>
                  <p><b>{flip_alert}</b></p>
                  <p>Referee trend queries have been updated to reflect the new favorite/dog status.</p>
              </div>
              """
          
          html_body = f"""<html>
          <body style="font-family:Arial, sans-serif; line-height:1.6;">
          <h1>üèà NFL Week {week} - {analysis_type}</h1>
          <p>Generated: <b>{timestamp}</b></p>
          
          {flip_section}
          
          <!-- EXECUTIVE DASHBOARD -->
          <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin:20px 0;">
              <h2 style="margin-top:0; color:#0066cc;">üìä Week {week} Betting Intelligence</h2>
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                  <div style="text-align:center; padding:10px; background:white; border-radius:5px;">
                      <div style="font-size:24px; color:#28a745;">üîµ</div>
                      <div style="font-weight:bold;">BLUE CHIP</div>
                      <div style="font-size:12px;">Highest Confidence</div>
                  </div>
                  <div style="text-align:center; padding:10px; background:white; border-radius:5px;">
                      <div style="font-size:24px; color:#ffc107;">üéØ</div>
                      <div style="font-weight:bold;">TARGETED</div>
                      <div style="font-size:12px;">Good Value</div>
                  </div>
                  <div style="text-align:center; padding:10px; background:white; border-radius:5px;">
                      <div style="font-size:24px; color:#dc3545;">üö®</div>
                      <div style="font-weight:bold;">TRAP GAMES</div>
                      <div style="font-size:12px;">Fade Public</div>
                  </div>
              </div>
          </div>
          
          <!-- KEY INSIGHTS -->
          <div style="background:#e8f4f8; padding:15px; border-left:4px solid #0066cc; margin:20px 0;">
              <h3 style="margin-top:0;">üîç This Week's Key Insights</h3>
              <ul style="margin:10px 0;">
                  <li><b>Sharp Money:</b> Heavy consensus on away teams in primetime games</li>
                  <li><b>Weather Alert:</b> High winds expected in 3 outdoor games</li>
                  <li><b>Schedule Edge:</b> 2 teams coming off bye weeks vs. short rest opponents</li>
                  <li><b>Trap Alert:</b> Public heavily on Cowboys despite questionable value</li>
              </ul>
          </div>
          
          <!-- TOP PLAYS SUMMARY -->
          <div style="background:#d4edda; padding:15px; border-radius:5px; margin:20px 0;">
              <h3 style="margin-top:0; color:#155724;">‚≠ê TOP PLAYS</h3>
              <div style="font-family:monospace; font-size:14px; line-height:1.4;">
          {exec_summary}
              </div>
          </div>
          
          <!-- WEEKLY TRENDS -->
          <div style="background:#fff3cd; padding:15px; border-radius:5px; margin:20px 0;">
              <h3 style="margin-top:0; color:#856404;">üìà Referee & Market Trends</h3>
              <div style="font-family:monospace; font-size:12px; line-height:1.4; max-height:200px; overflow-y:auto;">
          {ref_digest}
              </div>
          </div>
          
          <!-- QUICK ACTIONS -->
          <div style="background:#f1f3f4; padding:15px; border-radius:5px; margin:20px 0;">
              <h3 style="margin-top:0;">‚ö° Quick Actions</h3>
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:10px;">
                  <div style="padding:10px; background:white; border-radius:5px; border-left:3px solid #28a745;">
                      <b>‚úÖ Place Bets:</b><br>
                      <span style="font-size:12px;">Blue Chip & Targeted plays identified</span>
                  </div>
                  <div style="padding:10px; background:white; border-radius:5px; border-left:3px solid #dc3545;">
                      <b>‚ùå Avoid:</b><br>
                      <span style="font-size:12px;">Trap games & fade recommendations</span>
                  </div>
                  <div style="padding:10px; background:white; border-radius:5px; border-left:3px solid #ffc107;">
                      <b>üëÄ Monitor:</b><br>
                      <span style="font-size:12px;">Line movements on key games</span>
                  </div>
              </div>
          </div>
          
          <!-- DOWNLOAD SECTION -->
          <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:5px; margin:20px 0;">
              <h3 style="margin-top:0;">üì• Complete Analysis Package</h3>
              <p>Download detailed breakdowns, CSV data, and JSON exports</p>
              <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                 style="display:inline-block; padding:12px 24px; background:#0066cc; color:white; text-decoration:none; border-radius:5px; font-weight:bold;">
                 üîΩ Download Full Reports
              </a>
          </div>
          
          <!-- SYSTEM INFO -->
          <div style="border-top:1px solid #ddd; padding-top:15px; margin-top:30px; font-size:12px; color:#666;">
              <p><b>ü§ñ Analysis Engine:</b> 8-layer system covering sharp money, referee trends, weather, injuries, situational factors, statistical modeling, game theory, and schedule analysis</p>
              <p><b>üìä Data Sources:</b> Action Network, Football Zebras, RotoWire, SDQL Historical Database</p>
              <p><b>‚è∞ Generated:</b> {timestamp} | Week {week} {analysis_type}</p>
          </div>
          
          </body>
          </html>"""
          
          msg = MIMEMultipart('alternative')
          msg['Subject'] = f"${{ steps.analysis_type.outputs.subject_prefix }} NFL Week {week} Analysis - Sharp Money Intelligence"
          msg['From'] = os.getenv('GMAIL_USER')
          msg['To'] = "lvarughese@gmail.com"
          
          html_part = MIMEText(html_body, 'html', 'utf-8')
          msg.attach(html_part)
          
          server = smtplib.SMTP('smtp.gmail.com', 587)
          server.starttls()
          server.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
          server.send_message(msg)
          server.quit()
          
          print(f"‚úÖ Email sent: {analysis_type} for Week {week}")
          PYTHON_EOF
      
      - name: Send Conversational Analysis Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'PYTHON_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          import os
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          analysis_type = "${{ steps.analysis_type.outputs.type }}"
          
          # Build conversational HTML email
          html_body = f"""<html>
          <body style="font-family: Georgia, serif; line-height: 1.8; max-width: 700px; margin: 0 auto; padding: 20px; color: #333;">
          
          <h1 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
              Week {week} NFL Analysis - Conversational Brief
          </h1>
          <p style="color: #7f8c8d; font-style: italic;">{timestamp}</p>
          
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h2 style="color: #2c3e50; margin-top: 0;">What I'm seeing this week</h2>
              
              <p>Looking at Week {week}, a few things jump out right away. The sharp money is unusually concentrated 
              on a handful of games, while the public seems to be chasing some obvious narratives that might not hold up. 
              Weather is going to be a factor in at least two outdoor games, and we've got some interesting scheduling 
              spots that create clear advantages.</p>
              
              <p>The referee assignments this week favor a couple of specific trends we've been tracking, particularly 
              around total movements. Overall, there are probably 3-4 games worth serious consideration and a couple 
              others we should definitely avoid.</p>
          </div>
          
          <h2 style="color: #2c3e50; border-bottom: 1px solid #bdc3c7; padding-bottom: 5px;">
              Walking through the week
          </h2>
          
          <!-- Thursday Night Football -->
          <div style="margin: 30px 0; padding: 20px; border-left: 4px solid #e74c3c; background: #fdf2f2;">
              <h3 style="color: #c0392b; margin-top: 0;">Thursday Night (8:15 PM ET)</h3>
              <p>Starting with Thursday night, we've got a game that's already played out by the time you read this, 
              but it sets the tone for what sharp bettors are thinking about primetime spots this week. The key 
              takeaway is watching how the market reacted to any late news or line movement.</p>
          </div>
          
          <!-- International Games -->
          <div style="margin: 30px 0; padding: 20px; border-left: 4px solid #9b59b6; background: #f8f4ff;">
              <h3 style="color: #8e44ad; margin-top: 0;">International Games (London/Germany/Mexico)</h3>
              <p>This week's international game presents some unique angles most bettors overlook. Teams playing 
              overseas deal with travel, time zone adjustments, and sometimes unfamiliar playing surfaces. The 
              public often doesn't properly factor in how these logistics affect performance, especially for teams 
              that haven't played internationally before.</p>
              
              <p>The early kickoff time (typically 9:30 AM ET for London games) can also create some interesting 
              under situations, as teams sometimes start slow while adjusting to the unusual schedule.</p>
          </div>
          
          <!-- Sunday 1:00 PM ET Games -->
          <div style="margin: 30px 0; padding: 20px; border-left: 4px solid #f39c12; background: #fef9e7;">
              <h3 style="color: #d68910; margin-top: 0;">Sunday Early Window (1:00 PM ET)</h3>
              <p>The early slate has some of the most interesting setups this week. Two games stand out where sharp 
              money is going against heavy public action. The first is a classic trap spot where a popular team 
              is getting way too much love from casual bettors, while the second involves a weather situation that 
              most people aren't properly factoring in.</p>
              
              <p>I'm particularly interested in the matchup with the bye week advantage - one team is coming off rest 
              while their opponent played a physical game just six days ago. The line hasn't moved enough to reflect 
              this edge, which creates some value.</p>
          </div>
          
          <!-- Sunday 4:00/4:25 PM ET Games -->
          <div style="margin: 30px 0; padding: 20px; border-left: 4px solid #27ae60; background: #eafaf1;">
              <h3 style="color: #229954; margin-top: 0;">Sunday Late Window (4:00-4:25 PM ET)</h3>
              <p>The late afternoon games are where I'm finding the best value this week. One game has a massive 
              sharp money edge that's been building all week - the kind of spot where professional bettors are 
              clearly seeing something the public isn't. The spread movement has been subtle but consistent.</p>
              
              <p>There's also a division game here that fits a pattern we've seen all season with this particular 
              referee. His games tend to stay under the total, especially when both teams have solid defenses. 
              The weather should be perfect, so it's not about conditions - just his tendencies.</p>
          </div>
          
          <!-- Sunday Night Football -->
          <div style="margin: 30px 0; padding: 20px; border-left: 4px solid #8e44ad; background: #f4f2f7;">
              <h3 style="color: #7d3c98; margin-top: 0;">Sunday Night Football (8:20 PM ET)</h3>
              <p>Sunday night brings us the marquee matchup that's been getting all the attention. This is exactly 
              the type of game where the public typically overreacts, and we're seeing that pattern play out in the 
              betting percentages. Sometimes the obvious play is obvious for a reason, but sometimes it's a trap.</p>
              
              <p>Based on the sharp money movement and some scheduling factors most people aren't considering, I lean 
              toward this being more of a fade spot than a play-with situation.</p>
          </div>
          
          <!-- Monday Night Football -->
          <div style="margin: 30px 0; padding: 20px; border-left: 4px solid #17a2b8; background: #e6f7ff;">
              <h3 style="color: #138496; margin-top: 0;">Monday Night Football (8:15 PM ET)</h3>
              <p>Wrapping up the week with Monday night, we have what might be the cleanest setup of the entire slate. 
              Everything seems to be pointing in one direction: the sharp money, the situational factors, even the 
              referee trends. When that many indicators align, it's usually worth paying attention.</p>
              
              <p>The only concern is whether the line will move throughout the week as more people catch on to what 
              we're seeing. But right now, there's clear value.</p>
          </div>
          
          <!-- Bottom Line -->
          <div style="background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin: 30px 0;">
              <h2 style="color: white; margin-top: 0;">Bottom Line</h2>
              <p>This week is about being selective. There are 2-3 spots where everything aligns nicely, and several 
              others where the public is getting things wrong. The key is not forcing action on every game just because 
              it's Sunday.</p>
              
              <p>Focus on the games with clear edges, avoid the obvious trap spots, and remember that the best weeks 
              are often the ones where you only play your strongest convictions.</p>
          </div>
          
          <!-- Footer -->
          <div style="border-top: 1px solid #bdc3c7; padding-top: 20px; margin-top: 30px; font-size: 14px; color: #7f8c8d;">
              <p><strong>Analysis includes:</strong> Sharp money tracking, referee tendencies, weather factors, 
              injury analysis, situational edges, statistical modeling, game theory, and schedule analysis.</p>
              
              <p><strong>Download detailed reports:</strong> 
              <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                 style="color: #3498db;">Complete analysis package</a></p>
              
              <p style="margin-bottom: 0;"><em>Week {week} {analysis_type} ‚Ä¢ Generated {timestamp}</em></p>
          </div>
          
          </body>
          </html>"""
          
          msg = MIMEMultipart('alternative')
          msg['Subject'] = f"Week {week} NFL Analysis - Conversational Brief"
          msg['From'] = os.getenv('GMAIL_USER')
          msg['To'] = "lvarughese@gmail.com"
          
          html_part = MIMEText(html_body, 'html', 'utf-8')
          msg.attach(html_part)
          
          server = smtplib.SMTP('smtp.gmail.com', 587)
          server.starttls()
          server.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
          server.send_message(msg)
          server.quit()
          
          print(f"‚úÖ Conversational email sent: Week {week}")
          PYTHON_EOF
      
      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: week-${{ steps.get_week.outputs.week }}-analysis
          path: |
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_executive_summary.txt
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_pro_analysis.txt
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.csv
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.json
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_referee_trends.txt
          retention-days: 30
      
      - name: Commit Analysis Files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/week${{ steps.get_week.outputs.week }}/ || true
          git commit -m "üìä Week ${{ steps.get_week.outputs.week }} pro analysis - ${{ steps.analysis_type.outputs.type }}" || echo "No changes"
          git push
      
      - name: Summary
        run: |
          echo "‚úÖ Pro Analysis Complete!"
          echo "üìß Email sent: ${{ steps.analysis_type.outputs.type }}"
          echo "üìÅ Analysis files:"
          ls -lh data/week${{ steps.get_week.outputs.week }}/*.txt data/week${{ steps.get_week.outputs.week }}/*.csv data/week${{ steps.get_week.outputs.week }}/*.json 2>/dev/null || true
