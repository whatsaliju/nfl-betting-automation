name: NFL Weekly Analysis

on:
  schedule:
    - cron: '0 22 * * 3'  # Wednesday 6 PM ET (10 PM UTC)
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:

      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver
      
      - name: Get Week Number
        id: get_week
        run: |
          WEEK=$(python3 -c "from nfl_weekly_analyzer import get_current_nfl_week; print(get_current_nfl_week())")
          echo "week=$WEEK" >> $GITHUB_OUTPUT
      
      - name: Get Timestamp
        id: timestamp
        run: |
          echo "time=$(date '+%Y-%m-%d %I:%M %p ET')" >> $GITHUB_OUTPUT
    
      - name: Create Action Network Cookies File
        run: |
          echo "${{ secrets.ACTION_NETWORK_COOKIES }}" > action_network_cookies.json

      - name: Run NFL Analysis
        env:
          GIMMETHEDOG_EMAIL: ${{ secrets.GIMMETHEDOG_EMAIL }}
          GIMMETHEDOG_PASSWORD: ${{ secrets.GIMMETHEDOG_PASSWORD }}
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
          ACTION_NETWORK_EMAIL: ${{ secrets.ACTION_NETWORK_EMAIL }}
          ACTION_NETWORK_PASSWORD: ${{ secrets.ACTION_NETWORK_PASSWORD }}
        run: |
          echo "üèà Starting NFL Week Analysis..."
          python3 nfl_weekly_analyzer.py
      
      - name: Generate AI Summary
        run: |
          WEEK="${{ steps.get_week.outputs.week }}"
          echo "ü§ñ Generating AI analysis summary..."
          python3 generate_ai_summary.py $WEEK
          echo "‚úÖ AI summary ready for Week $WEEK"
      
      - name: Upload Analysis Files
        uses: actions/upload-artifact@v4
        with:
          name: nfl-analysis-results
          path: |
            week${{ steps.get_week.outputs.week }}_referees.csv
            week${{ steps.get_week.outputs.week }}_queries.csv
            week${{ steps.get_week.outputs.week }}_complete_data.csv
            week${{ steps.get_week.outputs.week }}_enhanced_report.txt
            week${{ steps.get_week.outputs.week }}_ai_summary.txt
            sdql_results.csv
            action_all_markets_*.csv
            rotowire_lineups_*.csv
          retention-days: 30
      
      - name: Create Summary Comment
        run: |
          WEEK="${{ steps.get_week.outputs.week }}"

          {
            echo "# üèà NFL Week $WEEK Analysis Complete!"
            echo ""
            echo "‚úÖ Analysis finished at $(date)"
            echo ""
            echo "## üì• Download Files:"
            echo "1. Go to Actions tab"
            echo "2. Click on this workflow run"
            echo "3. Download 'nfl-analysis-results' artifact"
            echo ""
            echo "## ü§ñ Next Steps:"
            echo "1. Download \`week${WEEK}_ai_summary.txt\`"
            echo "2. Copy entire contents"
            echo "3. Paste into Claude chat"
            echo "4. Ask: 'Analyze these games and give me betting recommendations'"
            echo ""
            echo "## üìä Files Generated:"
          } >> $GITHUB_STEP_SUMMARY

          # List ONLY the files for the current week
          FILES=$(ls week${WEEK}_*.txt week${WEEK}_*.csv 2>/dev/null)

          if [ -z "$FILES" ]; then
            echo "- No files found for week ${WEEK}" >> $GITHUB_STEP_SUMMARY
          else
            ls -lh week${WEEK}_*.txt week${WEEK}_*.csv 2>/dev/null | \
              awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit results to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true
          git add week*.csv week*.txt action_all_markets*.csv rotowire_*.csv sdql_results.csv || true
          git commit -m "üèà Week ${{ steps.get_week.outputs.week }} analysis - $(date +%Y-%m-%d)" || echo "No changes to commit"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
      
      - name: Send Email Notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "üèà NFL Week ${{ steps.get_week.outputs.week }} Analysis Ready!"
          to: lvarughese@gmail.com
          from: NFL Betting Bot <noreply@github.com>
          body: |
            Your NFL Week analysis is complete and ready for review!

            üì• DOWNLOAD YOUR FILES:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ü§ñ NEXT STEPS:
            1. Click the link above
            2. Scroll down to "Artifacts" section
            3. Download "nfl-analysis-results.zip"
            4. Extract and open "week_ai_summary.txt"
            5. Copy the entire file
            6. Paste into Claude.ai chat
            7. Ask: "Analyze these games and give me betting recommendations"

            ‚è∞ Analysis completed at: ${{ steps.timestamp.outputs.time }}

            Good luck with your bets! üéØ
