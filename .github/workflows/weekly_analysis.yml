name: NFL Weekly Analysis

on:
  schedule:
    - cron: '0 22 * * 3'  # Wednesday 6 PM ET (10 PM UTC)
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:

      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Clean previous run data
        run: |
          rm -f action_all_markets_*.csv
          rm -f rotowire_lineups_*.csv
          rm -f week*_*.csv week*_*.txt week*_*.md week*_*.json
          rm -f sdql_results.csv
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver
      
      - name: Get Week Number
        id: get_week
        run: |
          WEEK=$(python3 -c "from nfl_weekly_analyzer import get_current_nfl_week; print(get_current_nfl_week())")
          echo "week=$WEEK" >> $GITHUB_OUTPUT
      
      - name: Get Timestamp
        id: timestamp
        run: |
          echo "time=$(date '+%Y-%m-%d %I:%M %p ET')" >> $GITHUB_OUTPUT
    
      - name: Create Action Network Cookies File
        env:
          COOKIES: ${{ secrets.ACTION_NETWORK_COOKIES }}
        run: |
          echo "$COOKIES" > action_network_cookies.json  


      - name: Run NFL Analysis
        env:
          GIMMETHEDOG_EMAIL: ${{ secrets.GIMMETHEDOG_EMAIL }}
          GIMMETHEDOG_PASSWORD: ${{ secrets.GIMMETHEDOG_PASSWORD }}
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
          ACTION_NETWORK_EMAIL: ${{ secrets.ACTION_NETWORK_EMAIL }}
          ACTION_NETWORK_PASSWORD: ${{ secrets.ACTION_NETWORK_PASSWORD }}
        run: |
          echo "üèà Starting NFL Week Analysis..."
          python3 nfl_weekly_analyzer.py
      
      - name: Generate AI Summary
        run: |
          WEEK="${{ steps.get_week.outputs.week }}"
          echo "ü§ñ Generating AI analysis summary..."
          python3 generate_ai_summary.py $WEEK
          echo "‚úÖ AI summary ready for Week $WEEK"
      
      - name: Upload Analysis Files
        uses: actions/upload-artifact@v4
        with:
          name: nfl-analysis-results
          path: |
            week${{ steps.get_week.outputs.week }}_referees.csv
            week${{ steps.get_week.outputs.week }}_queries.csv
            week${{ steps.get_week.outputs.week }}_complete_data.csv
            week${{ steps.get_week.outputs.week }}_enhanced_report.txt
            week${{ steps.get_week.outputs.week }}_ai_summary.txt
            week${{ steps.get_week.outputs.week }}_referee_trends.txt
            sdql_results.csv
            action_all_markets_*.csv
            rotowire_lineups_*.csv
          retention-days: 30
      
      - name: Create Summary Comment
        run: |
          WEEK="${{ steps.get_week.outputs.week }}"

          {
            echo "# üèà NFL Week $WEEK Analysis Complete!"
            echo ""
            echo "‚úÖ Analysis finished at $(date)"
            echo ""
            echo "## üì• Download Files:"
            echo "1. Go to Actions tab"
            echo "2. Click on this workflow run"
            echo "3. Download 'nfl-analysis-results' artifact"
            echo ""
            echo "## ü§ñ Next Steps:"
            echo "1. Download \`week${WEEK}_ai_summary.txt\`"
            echo "2. Copy entire contents"
            echo "3. Paste into Claude chat"
            echo "4. Ask: 'Analyze these games and give me betting recommendations'"
            echo ""
            echo "## üìä Files Generated:"
          } >> $GITHUB_STEP_SUMMARY

          FILES=$(ls week${WEEK}_*.txt week${WEEK}_*.csv 2>/dev/null)

          if [ -z "$FILES" ]; then
            echo "- No files found for week ${WEEK}" >> $GITHUB_STEP_SUMMARY
          else
            ls -lh week${WEEK}_*.txt week${WEEK}_*.csv 2>/dev/null | \
              awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit results to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true
          git add week*.csv week*.txt action_all_markets*.csv rotowire_*.csv sdql_results.csv || true
          git commit -m "üèà Week ${{ steps.get_week.outputs.week }} analysis - $(date +%Y-%m-%d)" || echo "No changes to commit"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      # -------------------------------------------------------
      # REQUIRED: PREPARE EMAIL CONTENT (digest + report)
      # -------------------------------------------------------
      - name: Prepare Email Content
        run: |
          WEEK="${{ steps.get_week.outputs.week }}"

          REF_DIGEST=$(cat week${WEEK}_referee_trends.txt)
          REPORT=$(cat week${WEEK}_enhanced_report.txt)

          REF_DIGEST_ESCAPED=$(printf '%s\n' "$REF_DIGEST" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
          REPORT_ESCAPED=$(printf '%s\n' "$REPORT" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')

          echo "REFEREE_DIGEST<<EOF" >> $GITHUB_ENV
          echo "$REF_DIGEST_ESCAPED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "FULL_REPORT<<EOF" >> $GITHUB_ENV
          echo "$REPORT_ESCAPED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # -------------------------------------------------------
      # SEND HTML EMAIL (Option 4 Deluxe)
      # -------------------------------------------------------
      - name: Send Email Notification
        if: success()
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'PYTHON_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          import os
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          ref_digest = """${{ env.REFEREE_DIGEST }}"""
          full_report = """${{ env.FULL_REPORT }}"""
          
          html_body = f"""<html>
          <body style="font-family:Arial, sans-serif; line-height:1.5;">
          <h1>üèà NFL Week {week} Betting Analysis</h1>
          <p>Analysis completed: <b>{timestamp}</b></p>
          <h2>üî• Summary Highlights</h2>
          <ul>
            <li><b>Top Plays:</b> See enhanced report below</li>
            <li><b>Sharp Money Alerts:</b> High-value edges detected</li>
            <li><b>Weather Risks:</b> Included in enhanced report</li>
            <li><b>Key Injuries:</b> Included in enhanced report</li>
          </ul>
          <h2>üßë‚Äç‚öñÔ∏è Weekly Referee Trend Digest</h2>
          <pre style="background:#f4f4f4; padding:12px; border-radius:6px;">{ref_digest}</pre>
          <h2>üìÑ Full Enhanced Report</h2>
          <pre style="white-space:pre-wrap; background:#f4f4f4; padding:12px; border-radius:6px;">{full_report}</pre>
          <h3>üì• Download All Files</h3>
          <p><a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">Click here to download the complete artifact package</a></p>
          </body>
          </html>"""
          
          msg = MIMEMultipart('alternative')
          msg['Subject'] = f"üèà NFL Week {week} Betting Analysis (Full Report Included)"
          msg['From'] = os.getenv('GMAIL_USER')
          msg['To'] = "lvarughese@gmail.com"
          
          html_part = MIMEText(html_body, 'html', 'utf-8')
          msg.attach(html_part)
          
          server = smtplib.SMTP('smtp.gmail.com', 587)
          server.starttls()
          server.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
          server.send_message(msg)
          server.quit()
          
          print("‚úÖ Email sent successfully!")
          PYTHON_EOF
