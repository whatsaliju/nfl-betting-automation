name: NFL Weekly Analysis

on:
  schedule:
    - cron: '0 22 * * 3'  # Wednesday 6 PM ET (10 PM UTC)
  workflow_dispatch:  # Manual trigger

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver
      
      - name: Get Week Number
        id: get_week
        run: |
          WEEK=$(python3 -c "from nfl_weekly_analyzer import get_current_nfl_week; print(get_current_nfl_week())")
          echo "week=$WEEK" >> $GITHUB_OUTPUT
      
      - name: Get Timestamp
        id: timestamp
        run: |
          echo "time=$(date '+%Y-%m-%d %I:%M %p ET')" >> $GITHUB_OUTPUT
      
      - name: Run NFL Analysis
        env:
          GIMMETHEDOG_EMAIL: ${{ secrets.GIMMETHEDOG_EMAIL }}
          GIMMETHEDOG_PASSWORD: ${{ secrets.GIMMETHEDOG_PASSWORD }}
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
          ACTION_NETWORK_EMAIL: ${{ secrets.ACTION_NETWORK_EMAIL }}
          ACTION_NETWORK_PASSWORD: ${{ secrets.ACTION_NETWORK_PASSWORD }}
        run: |
          echo "üèà Starting NFL Week Analysis..."
          python3 nfl_weekly_analyzer.py
      
      - name: Generate AI Summary
        run: |
          echo "ü§ñ Generating AI analysis summary..."
          WEEK=$(python3 -c "from nfl_weekly_analyzer import get_current_nfl_week; print(get_current_nfl_week())")
          python3 generate_ai_summary.py $WEEK
          echo "‚úÖ AI summary ready for Week $WEEK"
      
      - name: Upload Analysis Files
        uses: actions/upload-artifact@v4
        with:
          name: nfl-analysis-results
          path: |
            week*_ai_summary.txt
            week*_enhanced_report.txt
            week*_complete_data.csv
            week*_referees.csv
            week*_queries.csv
            sdql_results.csv
            action_all_markets*.csv
            rotowire_lineups*.csv
          retention-days: 30
      
      - name: Create Summary Comment
        run: |
          WEEK=$(python3 -c "from nfl_weekly_analyzer import get_current_nfl_week; print(get_current_nfl_week())")
          echo "# üèà NFL Week $WEEK Analysis Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Analysis finished at $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì• Download Files:" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Click on this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "3. Download 'nfl-analysis-results' artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ü§ñ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download \`week${WEEK}_ai_summary.txt\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Copy entire contents" >> $GITHUB_STEP_SUMMARY
          echo "3. Paste into Claude chat" >> $GITHUB_STEP_SUMMARY
          echo "4. Ask: 'Analyze these games and give me betting recommendations'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Files Generated:" >> $GITHUB_STEP_SUMMARY
          ls -lh week*.txt week*.csv 2>/dev/null | tail -n +2 | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY || echo "- Check artifacts for files" >> $GITHUB_STEP_SUMMARY
      
      - name: Commit results to repo
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add week*.csv week*.txt action_all_markets*.csv rotowire_*.csv sdql_results.csv || true
          git commit -m "üèà Week $(python3 -c 'from nfl_weekly_analyzer import get_current_nfl_week; print(get_current_nfl_week())') analysis - $(date +%Y-%m-%d)" || true
      
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Send Email Notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "üèà NFL Week ${{ steps.get_week.outputs.week }} Analysis Ready!"
          to: lvarughese@gmail.com
          from: NFL Betting Bot <noreply@github.com>
          body: |
            Your NFL Week analysis is complete and ready for review!
            
            üì• DOWNLOAD YOUR FILES:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ü§ñ NEXT STEPS:
            1. Click the link above
            2. Scroll down to "Artifacts" section
            3. Download "nfl-analysis-results.zip"
            4. Extract and open "week_ai_summary.txt"
            5. Copy the entire file
            6. Paste into Claude.ai chat
            7. Ask: "Analyze these games and give me betting recommendations"
            
            ‚è∞ Analysis completed at: ${{ steps.timestamp.outputs.time }}
            
            Good luck with your bets! üéØ
