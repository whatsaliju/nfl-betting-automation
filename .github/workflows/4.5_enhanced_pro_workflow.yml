name: 4.5 Pro Analysis & Email (Enhanced Organized)

on:
  repository_dispatch:
    types: [initial-market-data, market-data-ready]
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        type: string
      analysis_type:
        description: 'Type of analysis'
        required: false
        default: 'default'
        type: choice
        options:
          - 'initial'
          - 'update' 
          - 'final_lineups'
          - 'default'
      organized_output:
        description: 'Use organized file structure'
        required: false
        default: true
        type: boolean

jobs:
  generate_analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pandas numpy requests

      - name: Get Week Number
        id: get_week
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
          elif [ -n "${{ github.event.client_payload.week }}" ]; then
            WEEK="${{ github.event.client_payload.week }}"
          else
            WEEK=$(ls data/week*/week*_referees.csv 2>/dev/null | grep -oP 'week\K[0-9]+' | sort -n | tail -1)
          fi
          echo "week=$WEEK" >> $GITHUB_OUTPUT

      - name: Analysis Detection
        id: analysis_type
        run: |
          TYPE="${{ github.event.inputs.analysis_type }}"
          if [ -z "$TYPE" ] || [ "$TYPE" == "default" ]; then
            TYPE="${{ github.event.client_payload.analysis_type }}"
          fi
          [ -z "$TYPE" ] && TYPE="final"
          case "$TYPE" in
            "initial") STAGE="initial" ;;
            "update") STAGE="update" ;;
            *) STAGE="final" ;;
          esac
          echo "stage=$STAGE" >> $GITHUB_OUTPUT
          echo "organized_mode=${{ github.event.inputs.organized_output }}" >> $GITHUB_OUTPUT

      - name: Run Pro Analyzer
        run: |
          WEEK=${{ steps.get_week.outputs.week }}
          python3 -m analyzers.nfl_pro_analyzer $WEEK

      - name: Metadata Update
        if: steps.analysis_type.outputs.organized_mode == 'true'
        env:
          WEEK: ${{ steps.get_week.outputs.week }}
          STAGE: ${{ steps.analysis_type.outputs.stage }}
        run: |
          python3 << 'EOF'
          import json, os, datetime
          week = os.environ['WEEK']
          stage = os.environ['STAGE']
          path = f'data/week{week}/metadata.json'
          os.makedirs(os.path.dirname(path), exist_ok=True)
          if os.path.exists(path):
              with open(path, 'r') as f: meta = json.load(f)
          else:
              meta = {'week': week, 'stages': []}
          meta['stages'] = [s for s in meta['stages'] if s.get('stage') != stage]
          meta['stages'].append({'stage': stage, 'time': datetime.datetime.now().isoformat()})
          with open(path, 'w') as f: json.dump(meta, f, indent=2)
          EOF

      - name: Send Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_PASS: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'EOF'
          import smtplib, os
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from email.mime.application import MIMEApplication
          
          week = "${{ steps.get_week.outputs.week }}"
          stage = "${{ steps.analysis_type.outputs.stage }}"
          
          msg = MIMEMultipart()
          msg['Subject'] = f"NFL Week {week} Analysis - {stage}"
          msg['From'] = os.environ['GMAIL_USER']
          msg['To'] = "lvarughese@gmail.com"
          msg.attach(MIMEText(f"Analysis for Week {week} is ready.", 'plain'))
          
          f_path = f"data/week{week}/week{week}_pro_analysis.txt"
          if os.path.exists(f_path):
              with open(f_path, "rb") as f:
                  part = MIMEApplication(f.read(), Name=os.path.basename(f_path))
                  part['Content-Disposition'] = f'attachment; filename="{os.path.basename(f_path)}"'
                  msg.attach(part)
          
          s = smtplib.SMTP('smtp.gmail.com', 587)
          s.starttls()
          s.login(os.environ['GMAIL_USER'], os.environ['GMAIL_PASS'])
          s.send_message(msg)
          s.quit()
          EOF

      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git commit -m "ðŸ“Š update" || exit 0
          git push
