name: 4.5 Pro Analysis & Email (Enhanced Organized)

on:
  repository_dispatch:
    types: [initial-market-data, market-data-ready]
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        type: string
      analysis_type:
        description: 'Type of analysis'
        required: false
        default: 'default'
        type: choice
        options:
          - 'initial'
          - 'update' 
          - 'final_lineups'
          - 'default'
      organized_output:
        description: 'Use organized file structure'
        required: false
        default: true
        type: boolean

jobs:
  generate_analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main
          
      - name: Pull latest changes
        run: git pull origin main
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: pip install pandas numpy requests
      
      - name: Get Week Number
        id: get_week
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
            WEEK="${WEEK%.*}"
          elif [ -n "${{ github.event.client_payload.week }}" ]; then
            WEEK="${{ github.event.client_payload.week }}"
            WEEK="${WEEK%.*}"
          else
            # Auto-detect from existing files
            WEEK=$(ls data/week*/week*_referees.csv 2>/dev/null | grep -oP 'week\K[0-9]+' | sort -n | tail -1)
          fi
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "üìÖ Generating analysis for Week $WEEK"
      
      - name: Enhanced Analysis Type Detection
        id: analysis_type
        run: |
          # Get inputs
          TYPE="${{ github.event.inputs.analysis_type }}"
          ORGANIZED="${{ github.event.inputs.organized_output }}"
          
          # Priority: repository_dispatch client_payload
          if [ -z "$TYPE" ] || [ "$TYPE" == "null" ] || [ "$TYPE" == "default" ]; then
            TYPE="${{ github.event.client_payload.analysis_type }}"
          fi
          
          # Default fallback
          if [ -z "$TYPE" ] || [ "$TYPE" == "null" ]; then
            TYPE="default"
          fi
          
          FLIPS="${{ github.event.client_payload.line_flips }}"
          
          # Map analysis types to organized stages
          case "$TYPE" in
            "initial")
              STAGE="initial"
              DISPLAY_TYPE="Initial Market Analysis"
              SUBJECT_PREFIX="üèà Initial Market"
              INTRO_TEXT="Here's your initial market analysis for Week ${{ steps.get_week.outputs.week }}, hot off the press! We've crunched the early numbers and identified the biggest opportunities and potential traps as lines open."
              ;;
            "update")
              STAGE="update"  
              DISPLAY_TYPE="Market Update Analysis"
              SUBJECT_PREFIX="üîÑ Market Update"
              INTRO_TEXT="Market update for Week ${{ steps.get_week.outputs.week }}! This analysis incorporates the latest line movements and sharp money flows."
              ;;
            "final_lineups")
              STAGE="final"
              DISPLAY_TYPE="Final Lineup Analysis"
              SUBJECT_PREFIX="üö® Final Lineup"
              INTRO_TEXT="The final lineups are in, and so is your updated analysis for Week ${{ steps.get_week.outputs.week }}! This report incorporates all the latest player news and how it impacts the market."
              ;;
            *)
              STAGE="final"
              DISPLAY_TYPE="Updated Analysis"
              SUBJECT_PREFIX="üìä Updated"
              INTRO_TEXT="Here's an updated analysis for Week ${{ steps.get_week.outputs.week }}, reflecting the latest market movements and data changes."
              ;;
          esac
          
          # Output all variables
          echo "type=$DISPLAY_TYPE" >> $GITHUB_OUTPUT
          echo "stage=$STAGE" >> $GITHUB_OUTPUT
          echo "subject_prefix=$SUBJECT_PREFIX" >> $GITHUB_OUTPUT
          echo "intro_text=$INTRO_TEXT" >> $GITHUB_OUTPUT
          echo "organized_mode=$ORGANIZED" >> $GITHUB_OUTPUT
          
          if [ -n "$FLIPS" ] && [ "$FLIPS" != "0" ]; then
            echo "flip_alert=üö® $FLIPS line flip(s) detected and processed" >> $GITHUB_OUTPUT
          else
            echo "flip_alert=" >> $GITHUB_OUTPUT
          fi
          
          echo "üéØ Analysis Type: $DISPLAY_TYPE"
          echo "üìÅ Stage: $STAGE" 
          echo "üóÇÔ∏è Organized Mode: $ORGANIZED"
      
      - name: Setup Directory Structure
        run: |
          WEEK=${{ steps.get_week.outputs.week }}
          ORGANIZED=${{ steps.analysis_type.outputs.organized_mode }}
          
          # Always ensure the week directory exists
          mkdir -p data/week$WEEK
          
          if [ "$ORGANIZED" = "true" ]; then
            echo "üìÅ Setting up organized structure for Week $WEEK"
            
            # Check for existing metadata
            if [ -f "data/week$WEEK/metadata.json" ]; then
              echo "üìã Existing metadata found"
              cat data/week$WEEK/metadata.json | jq '.'
            else
              echo "üÜï Creating new metadata for Week $WEEK"
            fi
          else
            echo "üìÅ Using legacy structure for Week $WEEK"
          fi
      
      - name: Get Timestamp
        id: timestamp
        run: echo "time=$(date '+%Y-%m-%d %I:%M %p ET')" >> $GITHUB_OUTPUT
      
      - name: Run Pro Analyzer (Enhanced)
        run: |
          WEEK=${{ steps.get_week.outputs.week }}
          STAGE=${{ steps.analysis_type.outputs.stage }}
          ORGANIZED=${{ steps.analysis_type.outputs.organized_mode }}
          
          echo "üî¨ Running Pro Analysis Engine..."
          echo "üìä Week: $WEEK, Stage: $STAGE, Organized: $ORGANIZED"
          
          # Run analyzer with potential stage parameter
          if [ "$ORGANIZED" = "true" ]; then
            # Try to run with stage parameter (if your analyzer supports it)
            python3 -m analyzers.nfl_pro_analyzer $WEEK --stage=$STAGE --organized || \
            python3 -m analyzers.nfl_pro_analyzer $WEEK
          else
            # Legacy mode
            python3 -m analyzers.nfl_pro_analyzer $WEEK
          fi
          
          echo "‚úÖ Analysis complete"
      
      - name: Organize Files (If Enabled)
        run: |
          WEEK=${{ steps.get_week.outputs.week }}
          STAGE=${{ steps.analysis_type.outputs.stage }}
          ORGANIZED=${{ steps.analysis_type.outputs.organized_mode }}
          
          if [ "$ORGANIZED" = "true" ]; then
            echo "üóÇÔ∏è Organizing files for Week $WEEK, Stage $STAGE"
            
            # Move/copy legacy output files to organized structure
            WEEK_DIR="data/week$WEEK"
            
            # Copy main files with stage naming
            if [ -f "$WEEK_DIR/week${WEEK}_analytics.json" ]; then
              cp "$WEEK_DIR/week${WEEK}_analytics.json" "$WEEK_DIR/${STAGE}.json"
              echo "üìÑ Created ${STAGE}.json"
            fi
            
            if [ -f "$WEEK_DIR/week${WEEK}_analytics.csv" ]; then
              cp "$WEEK_DIR/week${WEEK}_analytics.csv" "$WEEK_DIR/${STAGE}.csv"
              echo "üìä Created ${STAGE}.csv"
            fi
            
            if [ -f "$WEEK_DIR/week${WEEK}_pro_analysis.txt" ]; then
              cp "$WEEK_DIR/week${WEEK}_pro_analysis.txt" "$WEEK_DIR/${STAGE}_pro_analysis.txt"
              echo "üìã Created ${STAGE}_pro_analysis.txt"
            fi
            
            # Update metadata using Python
            python3 << 'EOF'
            import json
            import os
            from datetime import datetime
            
            week = int("$WEEK")
            stage = "$STAGE"
            timestamp = "${{ steps.timestamp.outputs.time }}"
            week_dir = f"data/week{week}"
            metadata_file = f"{week_dir}/metadata.json"
            
            # Load or create metadata
            if os.path.exists(metadata_file):
                with open(metadata_file, 'r') as f:
                    metadata = json.load(f)
            else:
                metadata = {
                    'week': week,
                    'season': 2025,
                    'created_at': datetime.now().isoformat(),
                    'stages': [],
                    'workflow_complete': False
                }
            
            # Count games
            games_count = 0
            stage_file = f'{week_dir}/{stage}.json'
            if os.path.exists(stage_file):
                with open(stage_file, 'r') as f:
                    data = json.load(f)
                    games_count = len(data) if isinstance(data, list) else 0
            
            # Remove existing stage entry
            metadata['stages'] = [s for s in metadata['stages'] if s['stage'] != stage]
            
            # Add new stage entry
            stage_entry = {
                'stage': stage,
                'timestamp': datetime.now().isoformat(),
                'games_count': games_count,
                'filename': f'{stage}.json',
                'github_run_id': '${{ github.run_id }}',
                'analysis_type': '${{ steps.analysis_type.outputs.type }}'
            }
            
            metadata['stages'].append(stage_entry)
            metadata['updated_at'] = datetime.now().isoformat()
            
            # Check workflow completeness
            stages = [s['stage'] for s in metadata['stages']]
            metadata['workflow_complete'] = 'initial' in stages and ('final' in stages or 'update' in stages)
            
            # Save metadata
            with open(metadata_file, 'w') as f:
                json.dump(metadata, f, indent=2)
            
            print(f"‚úÖ Updated metadata for week {week}, stage {stage}")
            print(f"üìä Games: {games_count}, Stages: {stages}")
            EOF
          else
            echo "üìÅ Skipping organization - using legacy structure"
          fi
      
      - name: Send Enhanced Professional Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          # Your existing email Python code with minimal modifications
          python3 << 'PYTHON_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          import email.mime.application
          import os
          import re
          import json
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          analysis_type = "${{ steps.analysis_type.outputs.type }}"
          subject_prefix = "${{ steps.analysis_type.outputs.subject_prefix }}"
          flip_alert = "${{ steps.analysis_type.outputs.flip_alert }}"
          organized_mode = "${{ steps.analysis_type.outputs.organized_mode }}" == "true"
          stage = "${{ steps.analysis_type.outputs.stage }}"

          # Load detailed pro analysis (check both legacy and organized locations)
          pro_analysis_content = ""
          
          if organized_mode:
              # Try organized structure first
              try:
                  with open(f"data/week{week}/{stage}_pro_analysis.txt", "r") as f:
                      pro_analysis_content = f.read()
                  print(f"üìÑ Loaded organized pro analysis: {stage}_pro_analysis.txt")
              except:
                  # Fallback to legacy
                  try:
                      with open(f"data/week{week}/week{week}_pro_analysis.txt", "r") as f:
                          pro_analysis_content = f.read()
                      print(f"üìÑ Loaded legacy pro analysis as fallback")
                  except:
                      pro_analysis_content = "Pro analysis file not found"
                      print("‚ö†Ô∏è No pro analysis file found")
          else:
              # Legacy mode
              try:
                  with open(f"data/week{week}/week{week}_pro_analysis.txt", "r") as f:
                      pro_analysis_content = f.read()
                  print(f"üìÑ Loaded legacy pro analysis")
              except:
                  pro_analysis_content = "Pro analysis file not found"
          
          # [Your existing email parsing and HTML generation code continues unchanged...]
          
          # --- DATA PARSING LOGIC (UNCHANGED) ---
          def parse_game_sections(content):
              games = []
              game_sections = content.split("======================================================================")
              
              for section in game_sections:
                  if "===" in section and "Classification:" in section:
                      game = {}
                      lines = section.strip().split('\n')
                      
                      for line in lines:
                          line = line.strip()
                          if line.startswith("=== ") and " ===" in line:
                              game['matchup'] = line.replace("===", "").strip()
                          elif line.startswith("Classification:"):
                              game['classification'] = line.replace("Classification:", "").strip()
                          elif line.startswith("Total Score:"):
                              game['total_score'] = line.replace("Total Score:", "").strip()
                          elif line.startswith("Confidence:"):
                              game['confidence'] = line.replace("Confidence:", "").strip().split('/')[0]
                          elif line.startswith("Recommendation:"):
                              game['recommendation'] = line.replace("Recommendation:", "").strip()
                      
                      game['sharp_stories'] = []
                      game['referee_context'] = []
                      game['weather'] = ""
                      game['injury'] = ""
                      game['situational'] = []
                      game['statistical'] = []
                      game['market'] = []
                      
                      current_section = None
                      for line in lines:
                          line = line.strip()
                          
                          if "SHARP MONEY STORY:" in line:
                              current_section = "sharp"
                          elif "REFEREE CONTEXT:" in line:
                              current_section = "referee"
                          elif "WEATHER IMPACT:" in line:
                              current_section = "weather"
                          elif "INJURY ANALYSIS:" in line:
                              current_section = "injury"
                          elif "SITUATIONAL FACTORS:" in line:
                              current_section = "situational"
                          elif "STATISTICAL EDGE:" in line:
                              current_section = "statistical"
                          elif "MARKET DYNAMICS:" in line:
                              current_section = "market"
                          elif "THE VERDICT:" in line:
                              current_section = "verdict"
                          
                          elif (line.startswith("‚Ä¢") or line.startswith("‚Üí") or line.startswith("-")) and current_section and current_section != "verdict":
                              content_line = line[1:].strip()
                              
                              if current_section == "sharp":
                                  game['sharp_stories'].append(content_line)
                              elif current_section == "referee":
                                  game['referee_context'].append(content_line)
                              elif current_section == "situational":
                                  game['situational'].append(content_line)
                              elif current_section == "statistical":
                                  game['statistical'].append(content_line)
                              elif current_section == "market":
                                  game['market'].append(content_line)
                              
                              elif current_section == "weather" and content_line and not game['weather']:
                                  game['weather'] = content_line
                              elif current_section == "injury" and "Impact:" in line:
                                  game['injury'] = line.split("Impact:")[-1].strip()
                                  
                      if game.get('matchup'):
                          games.append(game)
                          
              return games
          
          games = parse_game_sections(pro_analysis_content)
          
          # Calculate summary stats
          blue_chip = [g for g in games if "üîµ BLUE CHIP" in g.get('classification', '')]
          targeted = [g for g in games if "üéØ TARGETED" in g.get('classification', '')]
          leans = [g for g in games if "üìä LEAN" in g.get('classification', '')]
          landmines = [g for g in games if "‚ö†Ô∏è LANDMINE" in g.get('classification', '')]
          fades = [g for g in games if "‚ùå FADE" in g.get('classification', '')]
          traps = fades + landmines
          total_games = len(games)
          
          # Add stage info to email if organized mode
          stage_info = ""
          if organized_mode:
              stage_info = f"""
              <div style="background:#e8f5e8; padding:15px; border-left:4px solid #4caf50; margin:20px 0;">
                  <h3 style="margin-top:0;">üóÇÔ∏è Analysis Stage: {stage.title()}</h3>
                  <p>This is a <strong>{stage}</strong> analysis. Files are organized in the new structured format.</p>
              </div>
              """
          
          # [Rest of your HTML generation code unchanged...]
          
          def generate_game_card(game):
              classification = game.get('classification', '')
              
              if "üîµ BLUE CHIP" in classification:
                  card_class = "border-left: 5px solid #2196F3; background: #e3f2fd;"
                  badge_color = "#2196F3"
                  emoji = "üîµ"
              elif "üéØ TARGETED" in classification:
                  card_class = "border-left: 5px solid #ff9800; background: #fff3e0;"
                  badge_color = "#ff9800"
                  emoji = "üéØ"
              elif "‚ùå FADE" in classification or "‚ö†Ô∏è LANDMINE" in classification:
                  card_class = "border-left: 5px solid #f44336; background: #ffebee;"
                  badge_color = "#f44336"
                  emoji = "‚ùå"
              else:
                  card_class = "border-left: 5px solid #666; background: #f5f5f5;"
                  badge_color = "#666"
                  emoji = "üìà"
              
              other_factors = []
              if game.get('weather'):
                  other_factors.append(f"<strong>Weather:</strong> {game['weather']}")
              if game.get('injury'):
                  other_factors.append(f"<strong>Injury Impact:</strong> {game['injury']}")
              if game.get('situational'):
                  other_factors.extend([f"<strong>Situational:</strong> {factor}" for factor in game['situational'][:2]])
              if game.get('statistical'):
                  other_factors.extend([f"<strong>Statistical:</strong> {factor}" for factor in game['statistical'][:2]])
              if game.get('market'):
                  other_factors.extend([f"<strong>Market:</strong> {factor}" for factor in game['market'][:2]])
              
              factors_html = ""
              if other_factors:
                  factors_html += f"""
                  <div style="background: white; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #34495e; font-size: 15px;">üìä Additional Context</h4>
                  """
                  for factor in other_factors[:4]:
                      factors_html += f"<p style='margin: 3px 0; font-size: 13px;'>‚Ä¢ {factor}</p>"
                  factors_html += "</div>"
                  
              sharp_html = ""
              if game.get('sharp_stories'):
                  sharp_html += f"""
                  <div style="background: white; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #e65100; font-size: 15px;">üí∞ Sharp Money Analysis</h4>
                  """
                  for story in game['sharp_stories'][:3]:
                      sharp_html += f"<p style='margin: 3px 0; font-size: 13px;'>‚Ä¢ {story}</p>"
                  sharp_html += "</div>"

              ref_html = ""
              if game.get('referee_context'):
                  ref_html += f"""
                  <div style="background: white; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #5d4e75; font-size: 15px;">‚öñÔ∏è Referee Context</h4>
                  """
                  for context in game['referee_context'][:2]:
                      ref_html += f"<p style='margin: 3px 0; font-size: 13px;'>‚Ä¢ {context}</p>"
                  ref_html += "</div>"
              
              
              card_html = f"""
              <div class="game-card" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; {card_class}">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                      <h3 style="margin: 0; color: #2c3e50; font-size: 20px;">{emoji} {game.get('matchup', 'N/A')}</h3>
                      <span style="background: {badge_color}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                          {classification}
                      </span>
                  </div>
                  
                  <div style="background: #f0f0f0; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #1976D2; font-size: 16px;">
                          Prediction: {game.get('recommendation', 'No recommendation')}
                      </h4>
                      <div style="display: flex; gap: 20px; font-size: 14px;">
                          <span><strong>Total Score:</strong> {game.get('total_score', 'N/A')}</span>
                          <span><strong>Confidence:</strong> {round(float(game.get('confidence', 0))/20*100, 1) if game.get('confidence', 'N/A') != 'N/A' else 'N/A'}%</span>
                      </div>
                  </div>
                  
                  {sharp_html}
                  {ref_html}
                  {factors_html}
                  
              </div>
              """
              return card_html
          
          
          # Build HTML email
          flip_section = ""
          if flip_alert:
              flip_section = f"""
              <div style="background:#fff3cd; padding:15px; border-left:4px solid #ffc107; margin:20px 0;">
                  <h3 style="margin-top:0;">‚ö†Ô∏è Line Movement Alert</h3>
                  <p><b>{flip_alert}</b></p>
                  <p>Analysis has been updated to reflect new line movements.</p>
              </div>
              """
          
          game_cards_html = "".join([generate_game_card(game) for game in games])
          
          html_body = f"""<html>
          <head>
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                  @media only screen and (max-width: 600px) {{
                      .container {{ padding: 10px !important; }}
                      .game-card {{ margin: 10px 0 !important; padding: 15px !important; }}
                      .stats-grid {{ grid-template-columns: 1fr !important; }}
                  }}
                  .download-link {{
                      display:inline-block; padding:12px 24px; background:#0066cc; color:white; text-decoration:none; border-radius:5px; font-weight:bold; margin-top: 10px;
                  }}
              </style>
          </head>
          <body style="font-family:Arial, sans-serif; line-height:1.6; margin:0; padding:0; background-color: #f5f5f5;">
          <div class="container" style="max-width: 800px; margin: 0 auto; background: white; padding: 20px;">
          
          <div style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h1 style="margin: 0 0 10px 0;">üèà NFL Week {week} - {analysis_type}</h1>
              <p style="margin: 0; opacity: 0.9;">Generated: {timestamp}</p>
          </div>
          
          {stage_info}
          {flip_section}
          
          <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin:20px 0;">
              <h2 style="margin-top:0; color:#0066cc;">üìä Week {week} Executive Summary</h2>
              <div class="stats-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px; margin: 15px 0;">
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #2196F3;">
                      <div style="font-size:24px; font-weight:bold; color:#2196F3;">{len(blue_chip)}</div>
                      <div style="font-weight:bold;">üîµ BLUE CHIP</div>
                      <div style="font-size:12px; color:#666;">Highest Confidence</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #ff9800;">
                      <div style="font-size:24px; font-weight:bold; color:#ff9800;">{len(targeted)}</div>
                      <div style="font-weight:bold;">üéØ TARGETED</div>
                      <div style="font-size:12px; color:#666;">Good Value Plays</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #ff9800;">
                      <div style="font-size:24px; font-weight:bold; color:#ff9800;">{len(leans)}</div>
                      <div style="font-weight:bold;">üìä LEAN PLAYS</div>
                      <div style="font-size:12px; color:#666;">Proceed with Caution</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #ffc107;">
                      <div style="font-size:24px; font-weight:bold; color:#ffc107;">{len(landmines)}</div>
                      <div style="font-weight:bold;">‚ö†Ô∏è LANDMINES</div>
                      <div style="font-size:12px; color:#666;">Pass - Mixed Signals</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #f44336;">
                      <div style="font-size:24px; font-weight:bold; color:#f44336;">{len(fades)}</div>
                      <div style="font-weight:bold;">‚ùå FADES</div>
                      <div style="font-size:12px; color:#666;">Fade the Public</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #666;">
                      <div style="font-size:24px; font-weight:bold; color:#666;">{total_games}</div>
                      <div style="font-weight:bold;">üìà TOTAL GAMES</div>
                      <div style="font-size:12px; color:#666;">Full Analysis</div>
                  </div>
              </div>
          </div>
          
          <div style="margin: 30px 0;">
              <h2 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                  üéØ Complete Game-by-Game Analysis
              </h2>
              <p style="color: #7f8c8d; margin-bottom: 25px;">
                  Comprehensive breakdown of all {total_games} games with sharp money analysis, referee trends, 
                  situational factors, and confidence scores.
              </p>
              {game_cards_html}
          </div>
          
          <div style="text-align:center; padding:25px; background:#f8f9fa; border-radius:8px; margin:30px 0;">
              <h3 style="margin-top:0; color:#2c3e50;">üìÅ Complete Analysis Package (Attached)</h3>
              <p style="color:#666; margin: 10px 0;">The following files are attached to this email:</p>
              
              <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0;">
                  <span style="background: #e8f5e8; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                      üìä week{week}_analytics.csv
                  </span>
                  <span style="background: #fff3e0; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                      üìù week{week}_pro_analysis.txt
                  </span>
                  <span style="background: #f3e5f5; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                      ü§ñ week{week}_analytics.json
                  </span>
                   <span style="background: #e1f5fe; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                       üìÑ week{week}_executive_summary.txt
                   </span>
              </div>
              
              <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="download-link">
                  üîΩ Go to GitHub Run (If Attachments Fail)
              </a>
          </div>
          
          <div style="border-top:1px solid #ddd; padding-top:15px; margin-top:30px; font-size:12px; color:#666;">
              <p><b>ü§ñ Analysis Engine:</b> 8-layer system covering sharp money, referee trends, weather, injuries, situational factors, statistical modeling, game theory, and schedule analysis</p>
              <p><b>üìä Data Sources:</b> Action Network, Football Zebras, RotoWire, SDQL Historical Database</p>
              <p><b>‚è∞ Generated:</b> {timestamp} | Week {week} {analysis_type}</p>
          </div>
          
          </div>
          </body>
          </html>"""
          
          # Email assembly (keep your existing attachment logic)
          msg = MIMEMultipart()
          msg['Subject'] = f"{subject_prefix} Week {week} NFL Pro Analysis & Data Package"
          msg['From'] = os.getenv('GMAIL_USER')
          msg['To'] = "lvarughese@gmail.com"
          
          html_part = MIMEText(html_body, 'html', 'utf-8')
          msg.attach(html_part)
          
          # Attach files (check both organized and legacy locations)
          files_to_attach = [
              "executive_summary.txt",
              "pro_analysis.txt", 
              "analytics.csv",
              "analytics.json",
          ]
          
          for file_name_suffix in files_to_attach:
              file_name = f"week{week}_{file_name_suffix}"
              file_path = f"data/week{week}/{file_name}"
              
              # Try organized structure if enabled
              if organized_mode and file_name_suffix != "executive_summary.txt":
                  alt_names = {
                      "pro_analysis.txt": f"{stage}_pro_analysis.txt",
                      "analytics.csv": f"{stage}.csv", 
                      "analytics.json": f"{stage}.json"
                  }
                  alt_path = f"data/week{week}/{alt_names.get(file_name_suffix, file_name)}"
                  if os.path.exists(alt_path):
                      file_path = alt_path
                      print(f"üìé Using organized file: {alt_path}")
              
              try:
                  with open(file_path, "rb") as f:
                      part = email.mime.application.MIMEApplication(f.read(), name=file_name)
                  part['Content-Disposition'] = f'attachment; filename="{file_name}"'
                  msg.attach(part) 
                  print(f"‚úÖ Attached: {file_name}")
              except FileNotFoundError:
                  print(f"‚ö†Ô∏è Warning: File not found for attachment: {file_path}")
          
          server = smtplib.SMTP('smtp.gmail.com', 587)
          server.starttls()
          server.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
          server.send_message(msg)
          server.quit()
          
          print(f"‚úÖ Enhanced professional email sent: Week {week} - {analysis_type}")
          PYTHON_EOF
            
      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: week-${{ steps.get_week.outputs.week }}-${{ steps.analysis_type.outputs.stage }}-analysis
          path: |
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_executive_summary.txt
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_pro_analysis.txt
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.csv
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.json
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_referee_trends.txt
            data/week${{ steps.get_week.outputs.week }}/${{ steps.analysis_type.outputs.stage }}.json
            data/week${{ steps.get_week.outputs.week }}/${{ steps.analysis_type.outputs.stage }}.csv
            data/week${{ steps.get_week.outputs.week }}/${{ steps.analysis_type.outputs.stage }}_pro_analysis.txt
            data/week${{ steps.get_week.outputs.week }}/metadata.json
          retention-days: 30
            
      - name: Commit Analysis (Enhanced)
        run: |
          WEEK=${{ steps.get_week.outputs.week }}
          STAGE=${{ steps.analysis_type.outputs.stage }}
          ORGANIZED=${{ steps.analysis_type.outputs.organized_mode }}
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A || true 
          
          if [ "$ORGANIZED" = "true" ]; then
            COMMIT_MSG="üìä Week $WEEK $STAGE analysis (organized) - ${{ steps.analysis_type.outputs.type }}"
          else
            COMMIT_MSG="üìä Week $WEEK pro analysis - ${{ steps.analysis_type.outputs.type }}"
          fi
          
          git commit -m "$COMMIT_MSG" || echo "No new analysis changes to commit initially."
          
          git add -A
          git commit --amend --no-edit --allow-empty || true 
      
          git fetch origin
          
          git rebase origin/main || {
              echo "Rebase conflict detected. Attempting to resolve generated files automatically."
              
              # Resolve legacy files
              git checkout --ours data/week$WEEK/week${WEEK}_executive_summary.txt || true
              git checkout --ours data/week$WEEK/week${WEEK}_pro_analysis.txt || true
              git checkout --ours data/week$WEEK/week${WEEK}_analytics.csv || true
              git checkout --ours data/week$WEEK/week${WEEK}_analytics.json || true
              git checkout --ours data/week$WEEK/week${WEEK}_referee_trends.txt || true
              
              # Resolve organized files if they exist
              if [ "$ORGANIZED" = "true" ]; then
                git checkout --ours data/week$WEEK/${STAGE}.json || true
                git checkout --ours data/week$WEEK/${STAGE}.csv || true
                git checkout --ours data/week$WEEK/${STAGE}_pro_analysis.txt || true
                git checkout --ours data/week$WEEK/metadata.json || true
              fi
              
              git add data/week$WEEK/
              git rebase --continue || {
                  echo "ERROR: Failed to continue rebase after automatic conflict resolution."
                  exit 1
              }
          }
          
          git push --force-with-lease
      
      - name: Summary
        run: |
          WEEK=${{ steps.get_week.outputs.week }}
          STAGE=${{ steps.analysis_type.outputs.stage }}
          ORGANIZED=${{ steps.analysis_type.outputs.organized_mode }}
          
          echo "‚úÖ Pro Analysis Complete!"
          echo "üìß Email sent: ${{ steps.analysis_type.outputs.type }}"
          echo "üóÇÔ∏è Organized mode: $ORGANIZED"
          echo "üìä Stage: $STAGE"
          echo "üìÅ Analysis files:"
          
          ls -lh data/week$WEEK/*.txt data/week$WEEK/*.csv data/week$WEEK/*.json 2>/dev/null || true
          
          if [ "$ORGANIZED" = "true" ]; then
            echo ""
            echo "üìã Metadata status:"
            cat data/week$WEEK/metadata.json 2>/dev/null | jq '.stages[] | {stage, games_count, timestamp}' || echo "No metadata found"
          fi
