name: 4.5 Pro Analysis & Email (Enhanced Organized)

on:
  repository_dispatch:
    types: [initial-market-data, market-data-ready]
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        type: string
      analysis_type:
        description: 'Type of analysis'
        required: false
        default: 'default'
        type: choice
        options:
          - 'initial'
          - 'update' 
          - 'final_lineups'
          - 'default'
      organized_output:
        description: 'Use organized file structure'
        required: false
        default: true
        type: boolean

jobs:
  generate_analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main
          
      - name: Pull latest changes
        run: git pull origin main
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: pip install pandas numpy requests
      
      - name: Get Week Number
        id: get_week
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
            WEEK="${WEEK%.*}"
          elif [ -n "${{ github.event.client_payload.week }}" ]; then
            WEEK="${{ github.event.client_payload.week }}"
            WEEK="${WEEK%.*}"
          else
            # Auto-detect from existing files
            WEEK=$(ls data/week*/week*_referees.csv 2>/dev/null | grep -oP 'week\K[0-9]+' | sort -n | tail -1)
          fi
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "üìÖ Generating analysis for Week $WEEK"
      
      - name: Enhanced Analysis Type Detection
        id: analysis_type
        run: |
          # Get inputs
          TYPE="${{ github.event.inputs.analysis_type }}"
          ORGANIZED="${{ github.event.inputs.organized_output }}"
          
          # Priority: repository_dispatch client_payload
          if [ -z "$TYPE" ] || [ "$TYPE" == "null" ] || [ "$TYPE" == "default" ]; then
            TYPE="${{ github.event.client_payload.analysis_type }}"
          fi
          
          # Default fallback
          if [ -z "$TYPE" ] || [ "$TYPE" == "null" ]; then
            TYPE="default"
          fi
          
          FLIPS="${{ github.event.client_payload.line_flips }}"
          
          # Map analysis types to organized stages
          case "$TYPE" in
            "initial")
              STAGE="initial"
              DISPLAY_TYPE="Initial Market Analysis"
              SUBJECT_PREFIX="üèà Initial Market"
              INTRO_TEXT="Here's your initial market analysis for Week ${{ steps.get_week.outputs.week }}, hot off the press! We've crunched the early numbers and identified the biggest opportunities and potential traps as lines open."
              ;;
            "update")
              STAGE="update"  
              DISPLAY_TYPE="Market Update Analysis"
              SUBJECT_PREFIX="üîÑ Market Update"
              INTRO_TEXT="Market update for Week ${{ steps.get_week.outputs.week }}! This analysis incorporates the latest line movements and sharp money flows."
              ;;
            "final_lineups")
              STAGE="final"
              DISPLAY_TYPE="Final Lineup Analysis"
              SUBJECT_PREFIX="üö® Final Lineup"
              INTRO_TEXT="The final lineups are in, and so is your updated analysis for Week ${{ steps.get_week.outputs.week }}! This report incorporates all the latest player news and how it impacts the market."
              ;;
            *)
              STAGE="final"
              DISPLAY_TYPE="Updated Analysis"
              SUBJECT_PREFIX="üìä Updated"
              INTRO_TEXT="Here's an updated analysis for Week ${{ steps.get_week.outputs.week }}, reflecting the latest market movements and data changes."
              ;;
          esac
          
          # Output all variables
          echo "type=$DISPLAY_TYPE" >> $GITHUB_OUTPUT
          echo "stage=$STAGE" >> $GITHUB_OUTPUT
          echo "subject_prefix=$SUBJECT_PREFIX" >> $GITHUB_OUTPUT
          echo "intro_text=$INTRO_TEXT" >> $GITHUB_OUTPUT
          echo "organized_mode=$ORGANIZED" >> $GITHUB_OUTPUT
          
          if [ -n "$FLIPS" ] && [ "$FLIPS" != "0" ]; then
            echo "flip_alert=üö® $FLIPS line flip(s) detected and processed" >> $GITHUB_OUTPUT
          else
            echo "flip_alert=" >> $GITHUB_OUTPUT
          fi
          
          echo "üéØ Analysis Type: $DISPLAY_TYPE"
          echo "üìÅ Stage: $STAGE" 
          echo "üóÇÔ∏è Organized Mode: $ORGANIZED"
      
      - name: Setup Directory Structure
        run: |
          WEEK=${{ steps.get_week.outputs.week }}
          ORGANIZED=${{ steps.analysis_type.outputs.organized_mode }}
          
          # Always ensure the week directory exists
          mkdir -p data/week$WEEK
          
          if [ "$ORGANIZED" = "true" ]; then
            echo "üìÅ Setting up organized structure for Week $WEEK"
            
            # Check for existing metadata
            if [ -f "data/week$WEEK/metadata.json" ]; then
              echo "üìã Existing metadata found"
              cat data/week$WEEK/metadata.json | jq '.'
            else
              echo "üÜï Creating new metadata for Week $WEEK"
            fi
          else
            echo "üìÅ Using legacy structure for Week $WEEK"
          fi
      
      - name: Get Timestamp
        id: timestamp
        run: echo "time=$(date '+%Y-%m-%d %I:%M %p ET')" >> $GITHUB_OUTPUT
      
      - name: Run Pro Analyzer (Enhanced)
        run: |
          WEEK=${{ steps.get_week.outputs.week }}
          STAGE=${{ steps.analysis_type.outputs.stage }}
          ORGANIZED=${{ steps.analysis_type.outputs.organized_mode }}
          
          echo "üî¨ Running Pro Analysis Engine..."
          echo "üìä Week: $WEEK, Stage: $STAGE, Organized: $ORGANIZED"
          
          # Run analyzer with potential stage parameter
          if [ "$ORGANIZED" = "true" ]; then
            # Try to run with stage parameter (if your analyzer supports it)
            python3 -m analyzers.nfl_pro_analyzer $WEEK --stage=$STAGE --organized || \
            python3 -m analyzers.nfl_pro_analyzer $WEEK
          else
            # Legacy mode
            python3 -m analyzers.nfl_pro_analyzer $WEEK
          fi
          
          echo "‚úÖ Analysis complete"
      
      - name: Organize Files (If Enabled)
        run: |
          WEEK=${{ steps.get_week.outputs.week }}
          STAGE=${{ steps.analysis_type.outputs.stage }}
          ORGANIZED=${{ steps.analysis_type.outputs.organized_mode }}
          
          if [ "$ORGANIZED" = "true" ]; then
            echo "üóÇÔ∏è Organizing files for Week $WEEK, Stage $STAGE"
            
            # Move/copy legacy output files to organized structure
            WEEK_DIR="data/week$WEEK"
            
            # Copy main files with stage naming
            if [ -f "$WEEK_DIR/week${WEEK}_analytics.json" ]; then
              cp "$WEEK_DIR/week${WEEK}_analytics.json" "$WEEK_DIR/${STAGE}.json"
              echo "üìÑ Created ${STAGE}.json"
            fi
            
            if [ -f "$WEEK_DIR/week${WEEK}_analytics.csv" ]; then
              cp "$WEEK_DIR/week${WEEK}_analytics.csv" "$WEEK_DIR/${STAGE}.csv"
              echo "üìä Created ${STAGE}.csv"
            fi
            
            if [ -f "$WEEK_DIR/week${WEEK}_pro_analysis.txt" ]; then
              cp "$WEEK_DIR/week${WEEK}_pro_analysis.txt" "$WEEK_DIR/${STAGE}_pro_analysis.txt"
              echo "üìã Created ${STAGE}_pro_analysis.txt"
            fi
            
            # Update metadata using Python script
            python3 << 'METADATA_EOF'
import json
import os
from datetime import datetime

week = int(os.environ['WEEK'])
stage = os.environ['STAGE']
week_dir = f'data/week{week}'
metadata_file = f'{week_dir}/metadata.json'

if os.path.exists(metadata_file):
    with open(metadata_file, 'r') as f:
        metadata = json.load(f)
else:
    metadata = {
        'week': week,
        'season': 2025,
        'created_at': datetime.now().isoformat(),
        'stages': [],
        'workflow_complete': False
    }

games_count = 0
stage_file = f'{week_dir}/{stage}.json'
if os.path.exists(stage_file):
    with open(stage_file, 'r') as f:
        data = json.load(f)
        games_count = len(data) if isinstance(data, list) else 0

# Remove any existing entry for this stage
metadata['stages'] = [s for s in metadata['stages'] if s['stage'] != stage]

stage_entry = {
    'stage': stage,
    'timestamp': datetime.now().isoformat(),
    'games_count': games_count,
    'filename': f'{stage}.json',
    'github_run_id': os.environ.get('GITHUB_RUN_ID', ''),
    'analysis_type': os.environ.get('ANALYSIS_TYPE', '')
}

metadata['stages'].append(stage_entry)
metadata['updated_at'] = datetime.now().isoformat()

stages = [s['stage'] for s in metadata['stages']]
metadata['workflow_complete'] = 'initial' in stages and ('final' in stages or 'update' in stages)

with open(metadata_file, 'w') as f:
    json.dump(metadata, f, indent=2)

print(f'Updated metadata for week {week}, stage {stage}')
print(f'Games: {games_count}, Stages: {stages}')
METADATA_EOF
          else
            echo "üìÅ Skipping organization - using legacy structure"
          fi
        env:
          WEEK: ${{ steps.get_week.outputs.week }}
          STAGE: ${{ steps.analysis_type.outputs.stage }}
          ANALYSIS_TYPE: ${{ steps.analysis_type.outputs.type }}
          GITHUB_RUN_ID: ${{ github.run_id }}
      
      - name: Send Enhanced Professional Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'EMAIL_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          import email.mime.application
          import os
          import re
          import json
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          analysis_type = "${{ steps.analysis_type.outputs.type }}"
          subject_prefix = "${{ steps.analysis_type.outputs.subject_prefix }}"
          flip_alert = "${{ steps.analysis_type.outputs.flip_alert }}"
          organized_mode = "${{ steps.analysis_type.outputs.organized_mode }}" == "true"
          stage = "${{ steps.analysis_type.outputs.stage }}"

          # Load detailed pro analysis (check both legacy and organized locations)
          pro_analysis_content = ""
          
          if organized_mode:
              # Try organized structure first
              try:
                  with open(f"data/week{week}/{stage}_pro_analysis.txt", "r") as f:
                      pro_analysis_content = f.read()
                  print(f"üìÑ Loaded organized pro analysis: {stage}_pro_analysis.txt")
              except:
                  # Fallback to legacy
                  try:
                      with open(f"data/week{week}/week{week}_pro_analysis.txt", "r") as f:
                          pro_analysis_content = f.read()
                      print(f"üìÑ Loaded legacy pro analysis as fallback")
                  except:
                      pro_analysis_content = "Pro analysis file not found"
                      print("‚ö†Ô∏è No pro analysis file found")
          else:
              # Legacy mode
              try:
                  with open(f"data/week{week}/week{week}_pro_analysis.txt", "r") as f:
                      pro_analysis_content = f.read()
                  print(f"üìÑ Loaded legacy pro analysis")
              except:
                  pro_analysis_content = "Pro analysis file not found"
          
          # Data parsing logic
          def parse_game_sections(content):
              games = []
              game_sections = content.split("======================================================================")
              
              for section in game_sections:
                  if "===" in section and "Classification:" in section:
                      game = {}
                      lines = section.strip().split('\n')
                      
                      for line in lines:
                          line = line.strip()
                          if line.startswith("=== ") and " ===" in line:
                              game['matchup'] = line.replace("===", "").strip()
                          elif line.startswith("Classification:"):
                              game['classification'] = line.replace("Classification:", "").strip()
                          elif line.startswith("Total Score:"):
                              game['total_score'] = line.replace("Total Score:", "").strip()
                          elif line.startswith("Confidence:"):
                              game['confidence'] = line.replace("Confidence:", "").strip().split('/')[0]
                          elif line.startswith("Recommendation:"):
                              game['recommendation'] = line.replace("Recommendation:", "").strip()
                      
                      game['sharp_stories'] = []
                      game['referee_context'] = []
                      game['weather'] = ""
                      game['injury'] = ""
                      game['situational'] = []
                      game['statistical'] = []
                      game['market'] = []
                      
                      current_section = None
                      for line in lines:
                          line = line.strip()
                          
                          if "SHARP MONEY STORY:" in line:
                              current_section = "sharp"
                          elif "REFEREE CONTEXT:" in line:
                              current_section = "referee"
                          elif "WEATHER IMPACT:" in line:
                              current_section = "weather"
                          elif "INJURY ANALYSIS:" in line:
                              current_section = "injury"
                          elif "SITUATIONAL FACTORS:" in line:
                              current_section = "situational"
                          elif "STATISTICAL EDGE:" in line:
                              current_section = "statistical"
                          elif "MARKET DYNAMICS:" in line:
                              current_section = "market"
                          elif "THE VERDICT:" in line:
                              current_section = "verdict"
                          
                          elif (line.startswith("‚Ä¢") or line.startswith("‚Üí") or line.startswith("-")) and current_section and current_section != "verdict":
                              content_line = line[1:].strip()
                              
                              if current_section == "sharp":
                                  game['sharp_stories'].append(content_line)
                              elif current_section == "referee":
                                  game['referee_context'].append(content_line)
                              elif current_section == "situational":
                                  game['situational'].append(content_line)
                              elif current_section == "statistical":
                                  game['statistical'].append(content_line)
                              elif current_section == "market":
                                  game['market'].append(content_line)
                              
                              elif current_section == "weather" and content_line and not game['weather']:
                                  game['weather'] = content_line
                              elif current_section == "injury" and "Impact:" in line:
                                  game['injury'] = line.split("Impact:")[-1].strip()
                                  
                      if game.get('matchup'):
                          games.append(game)
                          
              return games
          
          games = parse_game_sections(pro_analysis_content)
          
          # Calculate summary stats
          blue_chip = [g for g in games if "üîµ BLUE CHIP" in g.get('classification', '')]
          targeted = [g for g in games if "üéØ TARGETED" in g.get('classification', '')]
          leans = [g for g in games if "üìä LEAN" in g.get('classification', '')]
          landmines = [g for g in games if "‚ö†Ô∏è LANDMINE" in g.get('classification', '')]
          fades = [g for g in games if "‚ùå FADE" in g.get('classification', '')]
          total_games = len(games)
          
          # Add stage info to email if organized mode
          stage_info = ""
          if organized_mode:
              stage_info = f"""
              <div style="background:#e8f5e8; padding:15px; border-left:4px solid #4caf50; margin:20px 0;">
                  <h3 style="margin-top:0;">üóÇÔ∏è Analysis Stage: {stage.title()}</h3>
                  <p>This is a <strong>{stage}</strong> analysis. Files are organized in the new structured format.</p>
              </div>
              """
          
          def generate_game_card(game):
              classification = game.get('classification', '')
              
              if "üîµ BLUE CHIP" in classification:
                  card_class = "border-left: 5px solid #2196F3; background: #e3f2fd;"
                  badge_color = "#2196F3"
                  emoji = "üîµ"
              elif "üéØ TARGETED" in classification:
                  card_class = "border-left: 5px solid #ff9800; background: #fff3e0;"
                  badge_color = "#ff9800"
                  emoji = "üéØ"
              elif "‚ùå FADE" in classification or "‚ö†Ô∏è LANDMINE" in classification:
                  card_class = "border-left: 5px solid #f44336; background: #ffebee;"
                  badge_color = "#f44336"
                  emoji = "‚ùå"
              else:
                  card_class = "border-left: 5px solid #666; background: #f5f5f5;"
                  badge_color = "#666"
                  emoji = "üìà"
              
              factors_html = ""
              sharp_html = ""
              ref_html = ""
              
              if game.get('sharp_stories'):
                  sharp_html = f"""
                  <div style="background: white; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #e65100; font-size: 15px;">üí∞ Sharp Money</h4>
                  """
                  for story in game['sharp_stories'][:2]:
                      sharp_html += f"<p style='margin: 3px 0; font-size: 13px;'>‚Ä¢ {story}</p>"
                  sharp_html += "</div>"
              
              if game.get('referee_context'):
                  ref_html = f"""
                  <div style="background: white; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #5d4e75; font-size: 15px;">‚öñÔ∏è Referee</h4>
                  """
                  for context in game['referee_context'][:1]:
                      ref_html += f"<p style='margin: 3px 0; font-size: 13px;'>‚Ä¢ {context}</p>"
                  ref_html += "</div>"
              
              card_html = f"""
              <div style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; {card_class}">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                      <h3 style="margin: 0; color: #2c3e50; font-size: 20px;">{emoji} {game.get('matchup', 'N/A')}</h3>
                      <span style="background: {badge_color}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                          {classification}
                      </span>
                  </div>
                  
                  <div style="background: #f0f0f0; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #1976D2; font-size: 16px;">
                          {game.get('recommendation', 'No recommendation')}
                      </h4>
                      <div style="display: flex; gap: 20px; font-size: 14px;">
                          <span><strong>Score:</strong> {game.get('total_score', 'N/A')}</span>
                          <span><strong>Confidence:</strong> {round(float(game.get('confidence', 0))/20*100, 1) if game.get('confidence', 'N/A') != 'N/A' else 'N/A'}%</span>
                      </div>
                  </div>
                  
                  {sharp_html}
                  {ref_html}
              </div>
              """
              return card_html
          
          # Build email HTML
          flip_section = ""
          if flip_alert:
              flip_section = f"""
              <div style="background:#fff3cd; padding:15px; border-left:4px solid #ffc107; margin:20px 0;">
                  <h3 style="margin-top:0;">‚ö†Ô∏è Line Movement Alert</h3>
                  <p><b>{flip_alert}</b></p>
              </div>
              """
          
          game_cards_html = "".join([generate_game_card(game) for game in games])
          
          html_body = f"""<html>
          <head>
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                  .download-link {{ display:inline-block; padding:12px 24px; background:#0066cc; color:white; text-decoration:none; border-radius:5px; font-weight:bold; margin-top: 10px; }}
                  @media only screen and (max-width: 600px) {{ .container {{ padding: 10px !important; }} .game-card {{ margin: 10px 0 !important; padding: 15px !important; }} }}
              </style>
          </head>
          <body style="font-family:Arial, sans-serif; line-height:1.6; margin:0; padding:0; background-color: #f5f5f5;">
          <div class="container" style="max-width: 800px; margin: 0 auto; background: white; padding: 20px;">
          
          <div style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h1 style="margin: 0 0 10px 0;">üèà NFL Week {week} - {analysis_type}</h1>
              <p style="margin: 0; opacity: 0.9;">Generated: {timestamp}</p>
          </div>
          
          {stage_info}
          {flip_section}
          
          <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin:20px 0;">
              <h2 style="margin-top:0; color:#0066cc;">üìä Week {week} Executive Summary</h2>
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin: 15px 0;">
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #2196F3;">
                      <div style="font-size:24px; font-weight:bold; color:#2196F3;">{len(blue_chip)}</div>
                      <div style="font-weight:bold;">üîµ BLUE CHIP</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #ff9800;">
                      <div style="font-size:24px; font-weight:bold; color:#ff9800;">{len(targeted)}</div>
                      <div style="font-weight:bold;">üéØ TARGETED</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #ffc107;">
                      <div style="font-size:24px; font-weight:bold; color:#ffc107;">{len(landmines)}</div>
                      <div style="font-weight:bold;">‚ö†Ô∏è LANDMINES</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #f44336;">
                      <div style="font-size:24px; font-weight:bold; color:#f44336;">{len(fades)}</div>
                      <div style="font-weight:bold;">‚ùå FADES</div>
                  </div>
              </div>
          </div>
          
          <div style="margin: 30px 0;">
              <h2 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                  üéØ Game Analysis ({total_games} games)
              </h2>
              {game_cards_html}
          </div>
          
          <div style="text-align:center; padding:25px; background:#f8f9fa; border-radius:8px; margin:30px 0;">
              <h3 style="margin-top:0; color:#2c3e50;">üìÅ Analysis Files Attached</h3>
              <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="download-link">
                  üîó View GitHub Run
              </a>
          </div>
          
          </div>
          </body>
          </html>"""
          
          # Send email
          msg = MIMEMultipart()
          msg['Subject'] = f"{subject_prefix} Week {week} NFL Analysis"
          msg['From'] = os.getenv('GMAIL_USER')
          msg['To'] = "lvarughese@gmail.com"
          
          html_part = MIMEText(html_body, 'html', 'utf-8')
          msg.attach(html_part)
          
          # Attach files
          files_to_try = [
              f"data/week{week}/week{week}_analytics.csv",
              f"data/week{week}/week{week}_analytics.json", 
              f"data/week{week}/week{week}_pro_analysis.txt"
          ]
          
          if organized_mode:
              files_to_try.extend([
                  f"data/week{week}/{stage}.csv",
                  f"data/week{week}/{stage}.json",
                  f"data/week{week}/{stage}_pro_analysis.txt"
              ])
          
          for file_path in files_to_try:
              if os.path.exists(file_path):
                  try:
                      with open(file_path, "rb") as f:
                          part = email.mime.application.MIMEApplication(f.read(), name=os.path.basename(file_path))
                      part['Content-Disposition'] = f'attachment; filename="{os.path.basename(file_path)}"'
                      msg.attach(part)
                      print(f"‚úÖ Attached: {os.path.basename(file_path)}")
                  except Exception as e:
                      print(f"‚ö†Ô∏è Failed to attach {file_path}: {e}")
          
          server = smtplib.SMTP('smtp.gmail.com', 587)
          server.starttls()
          server.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
          server.send_message(msg)
          server.quit()
          
          print(f"‚úÖ Email sent: Week {week} - {analysis_type}")
          EMAIL_EOF
            
      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: week-${{ steps.get_week.outputs.week }}-${{ steps.analysis_type.outputs.stage }}-analysis
          path: |
            data/week${{ steps.get_week.outputs.week }}/
          retention-days: 30
            
      - name: Commit Analysis (Enhanced)
        run: |
          WEEK=${{ steps.get_week.outputs.week }}
          STAGE=${{ steps.analysis_type.outputs.stage }}
          ORGANIZED=${{ steps.analysis_type.outputs.organized_mode }}
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add data/week$WEEK/ || true 
          
          if [ "$ORGANIZED" = "true" ]; then
            COMMIT_MSG="üìä Week $WEEK $STAGE analysis (organized) - ${{ steps.analysis_type.outputs.type }}"
          else
            COMMIT_MSG="üìä Week $WEEK pro analysis - ${{ steps.analysis_type.outputs.type }}"
          fi
          
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
          git push || echo "Push failed, continuing..."
      
      - name: Summary
        run: |
          WEEK=${{ steps.get_week.outputs.week }}
          STAGE=${{ steps.analysis_type.outputs.stage }}
          ORGANIZED=${{ steps.analysis_type.outputs.organized_mode }}
          
          echo "‚úÖ Pro Analysis Complete!"
          echo "üìß Email sent: ${{ steps.analysis_type.outputs.type }}"
          echo "üóÇÔ∏è Organized mode: $ORGANIZED"
          echo "üìä Stage: $STAGE"
          echo "üìÅ Analysis files:"
          
          ls -lh data/week$WEEK/ 2>/dev/null || true
          
          if [ "$ORGANIZED" = "true" ] && [ -f "data/week$WEEK/metadata.json" ]; then
            echo ""
            echo "üìã Metadata:"
            cat data/week$WEEK/metadata.json | jq '.stages[] | {stage, games_count, timestamp}' || echo "No metadata found"
          fi
