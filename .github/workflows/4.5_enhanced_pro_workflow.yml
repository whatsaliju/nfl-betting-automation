name: 4.5 Pro Analysis & Email (Enhanced Organized)

on:
  repository_dispatch:
    types: [initial-market-data, market-data-ready]
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        type: string
      analysis_type:
        description: 'Type of analysis'
        required: false
        default: 'default'
        type: choice
        options: [initial, update, final_lineups, default]
      organized_output:
        description: 'Use organized file structure'
        required: false
        default: true
        type: boolean

jobs:
  generate_analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pandas numpy requests

      - name: Get Week and Detect Type
        id: info
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
          elif [ -n "${{ github.event.client_payload.week }}" ]; then
            WEEK="${{ github.event.client_payload.week }}"
          else
            WEEK=$(ls data/week*/week*_referees.csv 2>/dev/null | grep -oP 'week\K[0-9]+' | sort -n | tail -1)
          fi
          
          TYPE="${{ github.event.inputs.analysis_type }}"
          if [ -z "$TYPE" ] || [ "$TYPE" == "default" ]; then
            TYPE="${{ github.event.client_payload.analysis_type }}"
          fi
          [ -z "$TYPE" ] && TYPE="final"
          
          case "$TYPE" in
            "initial") STAGE="initial" ; PREFIX="ðŸˆ Initial" ;;
            "update") STAGE="update" ; PREFIX="ðŸ”„ Update" ;;
            *) STAGE="final" ; PREFIX="ðŸš¨ Final" ;;
          esac
          
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "stage=$STAGE" >> $GITHUB_OUTPUT
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT
          echo "time=$(date '+%Y-%m-%d %I:%M %p ET')" >> $GITHUB_OUTPUT

      - name: Run Pro Analyzer
        run: |
          WEEK=${{ steps.info.outputs.week }}
          python3 -m analyzers.nfl_pro_analyzer $WEEK

      - name: Organize and Metadata
        env:
          WEEK: ${{ steps.info.outputs.week }}
          STAGE: ${{ steps.info.outputs.stage }}
        run: |
          WEEK_DIR="data/week$WEEK"
          # 1. Rename files for organization
          [ -f "$WEEK_DIR/week${WEEK}_analytics.json" ] && cp "$WEEK_DIR/week${WEEK}_analytics.json" "$WEEK_DIR/$STAGE.json"
          [ -f "$WEEK_DIR/week${WEEK}_analytics.csv" ] && cp "$WEEK_DIR/week${WEEK}_analytics.csv" "$WEEK_DIR/$STAGE.csv"
          [ -f "$WEEK_DIR/week${WEEK}_pro_analysis.txt" ] && cp "$WEEK_DIR/week${WEEK}_pro_analysis.txt" "$WEEK_DIR/${STAGE}_pro_analysis.txt"

          # 2. Advanced Metadata Python
          python3 << 'EOF'
          import json, os, datetime
          week, stage = os.environ['WEEK'], os.environ['STAGE']
          path = f'data/week{week}/metadata.json'
          if os.path.exists(path):
              with open(path, 'r') as f: meta = json.load(f)
          else:
              meta = {'week': int(week), 'stages': []}
          
          g_count = 0
          try:
              with open(f'data/week{week}/{stage}.json', 'r') as f:
                  data = json.load(f)
                  g_count = len(data) if isinstance(data, list) else 0
          except: pass

          meta['stages'] = [s for s in meta['stages'] if s.get('stage') != stage]
          meta['stages'].append({
              'stage': stage,
              'games': g_count,
              'timestamp': datetime.datetime.now().isoformat()
          })
          with open(path, 'w') as f: json.dump(meta, f, indent=2)
          EOF

      - name: Send Fancy Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_PASS: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'EOF'
          import smtplib, os, re
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from email.mime.application import MIMEApplication

          week = "${{ steps.info.outputs.week }}"
          stage = "${{ steps.info.outputs.stage }}"
          prefix = "${{ steps.info.outputs.prefix }}"
          
          # Load Content
          txt_path = f"data/week{week}/{stage}_pro_analysis.txt"
          if not os.path.exists(txt_path): txt_path = f"data/week{week}/week{week}_pro_analysis.txt"
          
          content = ""
          if os.path.exists(txt_path):
              with open(txt_path, 'r') as f: content = f.read()

          # Parsing Logic for Game Cards
          cards = []
          sections = content.split("======================================================================")
          for sec in sections:
              if "Classification:" in sec:
                  match = re.search(r"=== (.*?) ===", sec)
                  matchup = match.group(1) if match else "Unknown Matchup"
                  class_match = re.search(r"Classification: (.*)", sec)
                  cls = class_match.group(1) if class_match else "ðŸ“Š LEAN"
                  
                  # Color logic
                  color = "#2196F3" if "BLUE" in cls else "#ff9800" if "TARGET" in cls else "#f44336" if "FADE" in cls else "#666"
                  
                  cards.append(f"""
                  <div style="border-left:5px solid {color}; background:#f9f9f9; padding:15px; margin:10px 0; border-radius:4px;">
                      <h3 style="margin:0; color:#2c3e50;">{matchup}</h3>
                      <p style="margin:5px 0;"><strong>{cls}</strong></p>
                  </div>""")

          html = f"""
          <html><body style="font-family:sans-serif;">
              <div style="background:#1976D2; color:white; padding:20px; border-radius:8px;">
                  <h1>{prefix} NFL Week {week}</h1>
                  <p>Generated: ${{ steps.info.outputs.time }}</p>
              </div>
              {''.join(cards)}
              <p>Full analysis files are attached to this email.</p>
          </body></html>"""

          msg = MIMEMultipart()
          msg['Subject'] = f"{prefix} Week {week} NFL Analysis"
          msg['From'] = os.environ['GMAIL_USER']
          msg['To'] = "lvarughese@gmail.com"
          msg.attach(MIMEText(html, 'html'))
          
          for ext in ['csv', 'json']:
              f_path = f"data/week{week}/{stage}.{ext}"
              if os.path.exists(f_path):
                  with open(f_path, "rb") as f:
                      part = MIMEApplication(f.read(), Name=os.path.basename(f_path))
                      part['Content-Disposition'] = f'attachment; filename="{os.path.basename(f_path)}"'
                      msg.attach(part)
          
          s = smtplib.SMTP('smtp.gmail.com', 587); s.starttls()
          s.login(os.environ['GMAIL_USER'], os.environ['GMAIL_PASS'])
          s.send_message(msg); s.quit()
          EOF

      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git commit -m "ðŸ“Š Week ${{ steps.info.outputs.week }} analysis update" || exit 0
          git push
