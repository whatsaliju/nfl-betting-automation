name: 6. Enhanced Performance Tracker
on:
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        default: '12'
        type: string
      action:
        description: 'Action to perform'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto        # Log + update + report (most common)
        - log_only    # Just log recommendations
        - update_only # Just update results
        - report_only # Just generate report
      analytics_file:
        description: 'Analytics file path (optional - auto-detects if blank)'
        required: false
        default: ''
        type: string

jobs:
  update-performance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests
    
    - name: Process Week Performance
      env:
        WEEK: ${{ github.event.inputs.week }}
        ACTION: ${{ github.event.inputs.action }}
        ANALYTICS_FILE: ${{ github.event.inputs.analytics_file }}
      run: |
        python <<EOF
        import sys, os
        from analyzers.performance_tracker import EnhancedPerformanceTracker
        
        # Get inputs
        week = int(os.getenv('WEEK'))
        action = os.getenv('ACTION')
        analytics_file = os.getenv('ANALYTICS_FILE').strip() or None
        
        print('üèà Processing Week ' + str(week) + ' - Action: ' + action)
        print('=' * 50)
        
        # Initialize tracker
        tracker = EnhancedPerformanceTracker()
        
        try:
            if action == 'auto':
                # Full automatic processing using the public method
                print('üîÑ Running full automatic processing...')
                
                # Log recommendations if analytics file exists
                if analytics_file:
                    tracker.log_week_recommendations(week, analytics_file)
                else:
                    # Try to find analytics file automatically
                    possible_files = [
                        'data/week' + str(week) + '/week' + str(week) + '_analytics.json',
                        'week' + str(week) + '_analytics.json'
                    ]
                    
                    found_file = None
                    for file_path in possible_files:
                        if os.path.exists(file_path):
                            found_file = file_path
                            break
                    
                    if found_file:
                        print('üìã Found analytics file: ' + found_file)
                        tracker.log_week_recommendations(week, found_file)
                    else:
                        print('üìã No analytics file found, skipping recommendation logging')
                
                # Update results with live scores
                print('üîÑ Updating results with live NFL scores...')
                results = tracker.update_week_results_auto(week, season=2025)
                
                if 'error' in results:
                    print('‚ö†Ô∏è Auto-update failed: ' + str(results.get('error', 'Unknown error')))
                    print('üí° You may need to update results manually')
                else:
                    print('‚úÖ Updated ' + str(results.get('updated_games', 0)) + ' games')
                    wins = results.get('wins', 0)
                    losses = results.get('losses', 0)
                    pushes = results.get('pushes', 0)
                    
                    if wins + losses > 0:
                        record_str = 'üìä Record: ' + str(wins) + '-' + str(losses)
                        if pushes > 0:
                            record_str += '-' + str(pushes)
                        print(record_str)
                        
                        win_rate = results.get('win_rate', 0)
                        print('üìà Win Rate: ' + str(round(win_rate, 1)) + '%')
                
                # Generate report
                report = tracker.generate_week_results_report(week)
                print('\n' + report)
                
            elif action == 'log_only':
                print('üìã Logging recommendations only...')
                if analytics_file and os.path.exists(analytics_file):
                    tracker.log_week_recommendations(week, analytics_file)
                else:
                    print('‚ö†Ô∏è Analytics file not found: ' + str(analytics_file))
                    
            elif action == 'update_only':
                print('üîÑ Updating results only...')
                results = tracker.update_week_results_auto(week, season=2025)
                
                if 'error' not in results:
                    print('‚úÖ Updated ' + str(results.get('updated_games', 0)) + ' games')
                    
                # Show updated report
                report = tracker.generate_week_results_report(week)
                print('\n' + report)
                
            elif action == 'report_only':
                print('üìä Generating report only...')
                report = tracker.generate_week_results_report(week)
                print('\n' + report)
            
            # Save report to file for email
            report_filename = 'week' + str(week) + '_performance_report.txt'
            with open(report_filename, 'w') as f:
                f.write('NFL Week ' + str(week) + ' Performance Update\n')
                f.write('=' * 50 + '\n\n')
                if 'report' in locals():
                    f.write(report)
                else:
                    f.write('Report generation was not requested for this action.')
            
            print('\nüìÑ Report saved to ' + report_filename)
            
        except Exception as e:
            print('‚ùå Error processing Week ' + str(week) + ': ' + str(e))
            import traceback
            traceback.print_exc()
            sys.exit(1)
        EOF
    
    - name: Email Performance Report
      if: contains(github.event.inputs.action, 'auto') || contains(github.event.inputs.action, 'update')
      env:
        EMAIL_ADDRESS: ${{ secrets.GMAIL_USERNAME }}
        EMAIL_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      run: |
        python <<EOF
        import sys, os, smtplib
        from email.mime.text import MIMEText
        from email.mime.multipart import MIMEMultipart
        from email.mime.base import MIMEBase
        from email import encoders
        from datetime import datetime
        
        week = int('${{ github.event.inputs.week }}')
        action = '${{ github.event.inputs.action }}'
        
        # Read the performance report
        try:
            report_file = 'week' + str(week) + '_performance_report.txt'
            with open(report_file, 'r') as f:
                report = f.read()
        except:
            report = 'Performance report not available'
        
        # Email setup
        email_addr = os.getenv('EMAIL_ADDRESS')
        email_pass = os.getenv('EMAIL_PASSWORD')
        
        if email_addr and email_pass:
            try:
                msg = MIMEMultipart()
                msg['From'] = email_addr
                msg['To'] = email_addr
                
                # Build subject safely
                subject = 'üèà Week ' + str(week) + ' Performance Update (' + action + ')'
                msg['Subject'] = subject
                
                # Build email body safely without f-strings
                timestamp = datetime.now().strftime("%Y-%m-%d %H:%M")
                body = "NFL Performance Tracker Update\n"
                body += "==============================\n\n"
                body += "Week: " + str(week) + "\n"
                body += "Action: " + action + "\n"
                body += "Updated: " + timestamp + "\n\n"
                body += report + "\n\n"
                body += "üìä Data Files:\n"
                body += "- Historical Results: data/historical/betting_results.csv\n"
                body += "- Week Analytics: data/week" + str(week) + "/week" + str(week) + "_analytics.json\n\n"
                body += "üîÑ Next Steps:\n"
                body += "- Review performance trends\n"
                body += "- Check for any manual corrections needed\n"
                body += "- Prepare for next week's analysis\n"
                
                msg.attach(MIMEText(body, 'plain'))
                
                # Attach CSV if available
                csv_path = 'data/historical/betting_results.csv'
                if os.path.exists(csv_path):
                    with open(csv_path, 'rb') as f:
                        part = MIMEBase('application', 'octet-stream')
                        part.set_payload(f.read())
                    
                    encoders.encode_base64(part)
                    filename = 'betting_results_week' + str(week) + '.csv'
                    part.add_header(
                        'Content-Disposition',
                        'attachment; filename=' + filename
                    )
                    msg.attach(part)
                
                # Send email
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(email_addr, email_pass)
                server.sendmail(email_addr, email_addr, msg.as_string())
                server.quit()
                
                print('üìß Performance report emailed successfully')
                
            except Exception as e:
                print('üìß Email failed: ' + str(e))
        else:
            print('üìß Email credentials not configured')
        EOF
    
    - name: Commit Updated Performance Data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are changes to commit
        if [ -n "$(git status --porcelain)" ]; then
          
          # Stage files (your original line)
          git add data/historical/ week${{ github.event.inputs.week }}_performance_report.txt
          
          # 1. COMMIT LOCAL CHANGES FIRST (FIXES: 'index contains uncommitted changes')
          git commit -m "üìä Performance update: Week ${{ github.event.inputs.week }} (${{ github.event.inputs.action }})"
          
          # 2. PULL AND REBASE (FIXES: 'non-fast-forward' push failures)
          git pull --rebase
          
          # 3. PUSH the finalized commit
          git push
          
          echo "‚úÖ Performance data committed and pushed"
        else
          echo "‚ÑπÔ∏è No changes to commit"
        fi
