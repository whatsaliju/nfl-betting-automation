name: 4. Pro Analysis & Email

on:
  repository_dispatch:
    types: [market-data-ready]
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        type: string

jobs:
  generate_analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main
      
      - name: Pull latest changes
        run: git pull origin main
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: pip install pandas numpy
      
      - name: Get Week Number
        id: get_week
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
            WEEK="${WEEK%.*}"
          elif [ -n "${{ github.event.client_payload.week }}" ]; then
            WEEK="${{ github.event.client_payload.week }}"
            WEEK="${WEEK%.*}"
          else
            # Auto-detect from existing files
            WEEK=$(ls data/week*/week*_referees.csv 2>/dev/null | grep -oP 'week\K[0-9]+' | sort -n | tail -1)
          fi
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "üìÖ Generating analysis for Week $WEEK"
      
      - name: Get Analysis Type
        id: analysis_type
        run: |
          TYPE="${{ github.event.client_payload.analysis_type }}"
          FLIPS="${{ github.event.client_payload.line_flips }}"
          
          if [ "$TYPE" = "initial" ]; then
            echo "type=Initial Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üèà Initial" >> $GITHUB_OUTPUT
          else
            echo "type=Updated Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üìä Updated" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$FLIPS" ] && [ "$FLIPS" != "0" ]; then
            echo "flip_alert=üö® $FLIPS line flip(s) detected and processed" >> $GITHUB_OUTPUT
          else
            echo "flip_alert=" >> $GITHUB_OUTPUT
          fi
      
      - name: Get Timestamp
        id: timestamp
        run: echo "time=$(date '+%Y-%m-%d %I:%M %p ET')" >> $GITHUB_OUTPUT
      
      - name: Run Pro Analyzer
        run: |
          echo "üî¨ Running Pro Analysis Engine..."
          python3 analyzers/nfl_pro_analyzer.py ${{ steps.get_week.outputs.week }}
      
      - name: Send Enhanced Professional Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'PYTHON_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          import email.mime.application # CRITICAL: For attaching files correctly
          import os
          import re
          import json
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          analysis_type = "${{ steps.analysis_type.outputs.type }}"
          flip_alert = "${{ steps.analysis_type.outputs.flip_alert }}"
          
          # Load detailed pro analysis
          try:
              with open(f"data/week{week}/week{week}_pro_analysis.txt", "r") as f:
                  pro_analysis_content = f.read()
          except:
              pro_analysis_content = "Pro analysis file not found"
          
          # --- DATA PARSING LOGIC (Restored from your old script) ---
          def parse_game_sections(content):
              games = []
              # Split by game divider
              game_sections = content.split("======================================================================")
              
              for section in game_sections:
                  # Check for a new game section
                  if "===" in section and "Classification:" in section:
                      game = {}
                      lines = section.strip().split('\n')
                      
                      # Initial line parsing
                      for line in lines:
                          line = line.strip()
                          if line.startswith("=== ") and " ===" in line:
                              game['matchup'] = line.replace("===", "").strip()
                          elif line.startswith("Classification:"):
                              game['classification'] = line.replace("Classification:", "").strip()
                          elif line.startswith("Total Score:"):
                              game['total_score'] = line.replace("Total Score:", "").strip()
                          elif line.startswith("Confidence:"):
                              game['confidence'] = line.replace("Confidence:", "").strip().split('/')[0] # Clean up /10 if present
                          elif line.startswith("Recommendation:"):
                              game['recommendation'] = line.replace("Recommendation:", "").strip()
                      
                      # Detailed section parsing
                      game['sharp_stories'] = []
                      game['referee_context'] = []
                      game['weather'] = ""
                      game['injury'] = ""
                      game['situational'] = []
                      game['statistical'] = []
                      game['market'] = []
                      
                      current_section = None
                      for line in lines:
                          line = line.strip()
                          
                          if "SHARP MONEY STORY:" in line:
                              current_section = "sharp"
                          elif "REFEREE CONTEXT:" in line:
                              current_section = "referee"
                          elif "WEATHER IMPACT:" in line:
                              current_section = "weather"
                          elif "INJURY ANALYSIS:" in line:
                              current_section = "injury"
                          elif "SITUATIONAL FACTORS:" in line:
                              current_section = "situational"
                          elif "STATISTICAL EDGE:" in line:
                              current_section = "statistical"
                          elif "MARKET DYNAMICS:" in line:
                              current_section = "market"
                          elif "THE VERDICT:" in line:
                              current_section = "verdict"
                          
                          # Extract bullet points/data
                          elif (line.startswith("‚Ä¢") or line.startswith("‚Üí") or line.startswith("-")) and current_section and current_section != "verdict":
                              content_line = line[1:].strip()
                              
                              if current_section == "sharp":
                                  game['sharp_stories'].append(content_line)
                              elif current_section == "referee":
                                  game['referee_context'].append(content_line)
                              elif current_section == "situational":
                                  game['situational'].append(content_line)
                              elif current_section == "statistical":
                                  game['statistical'].append(content_line)
                              elif current_section == "market":
                                  game['market'].append(content_line)
                              
                              # Specific handling for non-list items
                              elif current_section == "weather" and content_line:
                                  game['weather'] = content_line
                              elif current_section == "injury" and "Impact:" in line:
                                  game['injury'] = line.split("Impact:")[-1].strip()
                                  
                      if game.get('matchup'):
                          games.append(game)
                          
              return games
          
          games = parse_game_sections(pro_analysis_content)
          
          # Calculate summary stats
          blue_chip = [g for g in games if "üîµ BLUE CHIP" in g.get('classification', '')]
          targeted = [g for g in games if "üéØ TARGETED" in g.get('classification', '')]
          traps = [g for g in games if "‚ùå FADE" in g.get('classification', '') or "‚ö†Ô∏è LANDMINE" in g.get('classification', '')]
          total_games = len(games)
          
          # --- HTML GENERATION (Restored and Refined) ---
          def generate_game_card(game):
              classification = game.get('classification', '')
              
              # Determine card styling
              if "üîµ BLUE CHIP" in classification:
                  card_class = "border-left: 5px solid #2196F3; background: #e3f2fd;"
                  badge_color = "#2196F3"
                  emoji = "üîµ"
              elif "üéØ TARGETED" in classification:
                  card_class = "border-left: 5px solid #ff9800; background: #fff3e0;"
                  badge_color = "#ff9800"
                  emoji = "üéØ"
              elif "‚ùå FADE" in classification or "‚ö†Ô∏è LANDMINE" in classification:
                  card_class = "border-left: 5px solid #f44336; background: #ffebee;"
                  badge_color = "#f44336"
                  emoji = "‚ùå"
              else:
                  card_class = "border-left: 5px solid #666; background: #f5f5f5;"
                  badge_color = "#666"
                  emoji = "üìà"
              
              # Combine all bullet-point factors for a concise "Other Factors" list
              other_factors = []
              if game.get('weather'):
                  other_factors.append(f"<strong>Weather:</strong> {game['weather']}")
              if game.get('injury'):
                  other_factors.append(f"<strong>Injury Impact:</strong> {game['injury']}")
              if game.get('situational'):
                  other_factors.extend([f"<strong>Situational:</strong> {factor}" for factor in game['situational'][:2]])
              if game.get('statistical'):
                  other_factors.extend([f"<strong>Statistical:</strong> {factor}" for factor in game['statistical'][:2]])
              if game.get('market'):
                  other_factors.extend([f"<strong>Market:</strong> {factor}" for factor in game['market'][:2]])
              
              factors_html = ""
              if other_factors:
                  factors_html += """
                  <div style="background: white; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #34495e; font-size: 15px;">üìä Additional Context</h4>
                  """
                  for factor in other_factors[:4]: # Limit to 4 factors
                      factors_html += f"<p style='margin: 3px 0; font-size: 13px;'>‚Ä¢ {factor}</p>"
                  factors_html += "</div>"
                  
              sharp_html = ""
              if game.get('sharp_stories'):
                  sharp_html += """
                  <div style="background: white; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #e65100; font-size: 15px;">üí∞ Sharp Money Analysis</h4>
                  """
                  for story in game['sharp_stories'][:3]:  # Top 3 stories
                      sharp_html += f"<p style='margin: 3px 0; font-size: 13px;'>‚Ä¢ {story}</p>"
                  sharp_html += "</div>"

              ref_html = ""
              if game.get('referee_context'):
                  ref_html += """
                  <div style="background: white; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #5d4e75; font-size: 15px;">‚öñÔ∏è Referee Context</h4>
                  """
                  for context in game['referee_context'][:2]: # Top 2 contexts
                      ref_html += f"<p style='margin: 3px 0; font-size: 13px;'>‚Ä¢ {context}</p>"
                  ref_html += "</div>"
              
              
              card_html = f"""
              <div class="game-card" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; {card_class}">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                      <h3 style="margin: 0; color: #2c3e50; font-size: 20px;">{emoji} {game.get('matchup', 'N/A')}</h3>
                      <span style="background: {badge_color}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                          {classification}
                      </span>
                  </div>
                  
                  <div style="background: #f0f0f0; padding: 10px 15px; border-radius: 5px; margin: 10px 0;">
                      <h4 style="margin: 0 0 5px 0; color: #1976D2; font-size: 16px;">
                          Prediction: {game.get('recommendation', 'No recommendation')}
                      </h4>
                      <div style="display: flex; gap: 20px; font-size: 14px;">
                          <span><strong>Total Score:</strong> {game.get('total_score', 'N/A')}</span>
                          <span><strong>Confidence:</strong> {game.get('confidence', 'N/A')}/10</span>
                      </div>
                  </div>
                  
                  {sharp_html}
                  {ref_html}
                  {factors_html}
                  
              </div>
              """
              return card_html
          
          
          # Build HTML email
          flip_section = ""
          if flip_alert:
              flip_section = f"""
              <div style="background:#fff3cd; padding:15px; border-left:4px solid #ffc107; margin:20px 0;">
                  <h3 style="margin-top:0;">‚ö†Ô∏è Line Movement Alert</h3>
                  <p><b>{flip_alert}</b></p>
                  <p>Analysis has been updated to reflect new line movements.</p>
              </div>
              """
          
          game_cards_html = "".join([generate_game_card(game) for game in games])
          
          html_body = f"""<html>
          <head>
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                  @media only screen and (max-width: 600px) {{
                      .container {{ padding: 10px !important; }}
                      .game-card {{ margin: 10px 0 !important; padding: 15px !important; }}
                      .stats-grid {{ grid-template-columns: 1fr !important; }}
                  }}
                  /* Ensure links in the download section look like buttons */
                  .download-link {{
                      display:inline-block; padding:12px 24px; background:#0066cc; color:white; text-decoration:none; border-radius:5px; font-weight:bold; margin-top: 10px;
                  }}
              </style>
          </head>
          <body style="font-family:Arial, sans-serif; line-height:1.6; margin:0; padding:0; background-color: #f5f5f5;">
          <div class="container" style="max-width: 800px; margin: 0 auto; background: white; padding: 20px;">
          
          <div style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h1 style="margin: 0 0 10px 0;">üèà NFL Week {week} - {analysis_type}</h1>
              <p style="margin: 0; opacity: 0.9;">Generated: {timestamp}</p>
          </div>
          
          {flip_section}
          
          <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin:20px 0;">
              <h2 style="margin-top:0; color:#0066cc;">üìä Week {week} Executive Summary</h2>
              <div class="stats-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px; margin: 15px 0;">
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #2196F3;">
                      <div style="font-size:24px; font-weight:bold; color:#2196F3;">{len(blue_chip)}</div>
                      <div style="font-weight:bold;">üîµ BLUE CHIP</div>
                      <div style="font-size:12px; color:#666;">Highest Confidence</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #ff9800;">
                      <div style="font-size:24px; font-weight:bold; color:#ff9800;">{len(targeted)}</div>
                      <div style="font-weight:bold;">üéØ TARGETED</div>
                      <div style="font-size:12px; color:#666;">Good Value Plays</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #f44336;">
                      <div style="font-size:24px; font-weight:bold; color:#f44336;">{len(traps)}</div>
                      <div style="font-weight:bold;">‚ùå FADES/TRAPS</div>
                      <div style="font-size:12px; color:#666;">Fade the Public</div>
                  </div>
                  <div style="text-align:center; padding:15px; background:white; border-radius:5px; border-left: 4px solid #666;">
                      <div style="font-size:24px; font-weight:bold; color:#666;">{total_games}</div>
                      <div style="font-weight:bold;">üìà TOTAL GAMES</div>
                      <div style="font-size:12px; color:#666;">Full Analysis</div>
                  </div>
              </div>
          </div>
          
          <div style="margin: 30px 0;">
              <h2 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                  üéØ Complete Game-by-Game Analysis
              </h2>
              <p style="color: #7f8c8d; margin-bottom: 25px;">
                  Comprehensive breakdown of all {total_games} games with sharp money analysis, referee trends, 
                  situational factors, and confidence scores.
              </p>
              {game_cards_html}
          </div>
          
          <div style="text-align:center; padding:25px; background:#f8f9fa; border-radius:8px; margin:30px 0;">
              <h3 style="margin-top:0; color:#2c3e50;">üìÅ Complete Analysis Package (Attached)</h3>
              <p style="color:#666; margin: 10px 0;">The following files are attached to this email:</p>
              
              <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0;">
                  <span style="background: #e8f5e8; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                      üìä week{week}_analytics.csv
                  </span>
                  <span style="background: #fff3e0; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                      üìù week{week}_pro_analysis.txt
                  </span>
                  <span style="background: #f3e5f5; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                      ü§ñ week{week}_analytics.json
                  </span>
                   <span style="background: #e1f5fe; padding: 8px 12px; border-radius: 5px; font-size: 14px;">
                      üìÑ week{week}_executive_summary.txt
                  </span>
              </div>
              
              <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="download-link">
                  üîΩ Go to GitHub Run (If Attachments Fail)
              </a>
          </div>
          
          <div style="border-top:1px solid #ddd; padding-top:15px; margin-top:30px; font-size:12px; color:#666;">
              <p><b>ü§ñ Analysis Engine:</b> 8-layer system covering sharp money, referee trends, weather, injuries, situational factors, statistical modeling, game theory, and schedule analysis</p>
              <p><b>üìä Data Sources:</b> Action Network, Football Zebras, RotoWire, SDQL Historical Database</p>
              <p><b>‚è∞ Generated:</b> {timestamp} | Week {week} {analysis_type}</p>
          </div>
          
          </div>
          </body>
          </html>"""
          
          
          # --- EMAIL ASSEMBLY (CRITICAL FIX: MIME Structure for Attachments) ---
          # 1. Main container is 'mixed' (default) to hold attachments
          msg = MIMEMultipart() 
          msg['Subject'] = f"Week {week} NFL Pro Analysis & Data Package"
          msg['From'] = os.getenv('GMAIL_USER')
          msg['To'] = "lvarughese@gmail.com"
          
          # 2. Attach the HTML body directly
          html_part = MIMEText(html_body, 'html', 'utf-8')
          msg.attach(html_part)
          
          # ATTACH ALL FOUR ANALYSIS FILES INDIVIDUALLY
          files_to_attach = [
              "executive_summary.txt",
              "pro_analysis.txt",
              "analytics.csv",
              "analytics.json",
          ]
          
          for file_name_suffix in files_to_attach:
              file_name = f"week{week}_{file_name_suffix}"
              file_path = f"data/week{week}/{file_name}"
              try:
                  with open(file_path, "rb") as f:
                      # CRITICAL: Use email.mime.application for proper attachment
                      part = email.mime.application.MIMEApplication(f.read(), name=file_name)
                  part['Content-Disposition'] = f'attachment; filename="{file_name}"'
                  # 3. Attach files directly to the main message
                  msg.attach(part) 
                  print(f"Attached: {file_name}")
              except FileNotFoundError:
                  print(f"‚ö†Ô∏è Warning: File not found for attachment: {file_path}")
          
          server = smtplib.SMTP('smtp.gmail.com', 587)
          server.starttls()
          server.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
          server.send_message(msg)
          server.quit()
          
          print(f"‚úÖ Enhanced professional email sent: Week {week}")
          PYTHON_EOF
      
      - name: Send Conversational Analysis Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'PYTHON_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          # FIX: Use fully qualified import for reliable scope access
          import email.mime.application 
          import os
          import re
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          analysis_type = "${{ steps.analysis_type.outputs.type }}"
          
          # --- HELPER FUNCTION TO PULL SCORES AND SHARP MONEY STORY ---
          def get_game_data(week, matchup):
              score = 'N/A'
              confidence = 'N/A'
              story = 'No major divergence identified.' 
              
              # Fetching pro analysis content
              try:
                  with open(f"data/week{week}/week{week}_pro_analysis.txt", "r") as f:
                      content = f.read()
              except FileNotFoundError:
                  return score, confidence, story

              # Escape special characters for regex search
              escaped_matchup = re.escape(matchup)
              
              # Regex to capture the SHARP MONEY STORY block and the THE VERDICT scores
              # Finds ===Matchup===... SHARP MONEY STORY: (Story content)... THE VERDICT: Total Score: X, Confidence: Y
              matchup_pattern = re.compile(
                  rf"==={escaped_matchup}===\n.*?SHARP MONEY STORY:\n(.*?)\n\n.*?THE VERDICT:\n\s*Total Score: (\S+)\n\s*Confidence: (\S+)", 
                  re.DOTALL
              )
              match = matchup_pattern.search(content)

              if match:
                  story = match.group(1).strip()
                  score = match.group(2)
                  confidence = match.group(3)
                  
                  # Clean up story text by replacing newlines/tabs with single space
                  story = re.sub(r'[\n\t\r]', ' ', story).strip()
                  # Remove list markers and excess whitespace
                  story = re.sub(r'‚Ä¢\s*', '', story)
                  story = re.sub(r'\s{2,}', ' ', story)
              
              return score, confidence, story

          
          # --- MAIN PARSING LOGIC (CORRECTED FADES SECTION) ---
          def parse_executive_summary(week):
              plays = []
              fades = []
              try:
                  # NOTE: Assumes files are in data/week{week}/...
                  with open(f"data/week{week}/week{week}_executive_summary.txt", "r") as f:
                      content = f.read()
              except FileNotFoundError:
                  return [], []
              
              # Parse Targeted Plays (No change needed here)
              if "üéØ TARGETED PLAY" in content:
                  targeted_section = content.split("üéØ TARGETED PLAY")[1].split("‚ùå FADE")[0]
                  
                  for block in targeted_section.strip().split('\n\n'):
                      if 'TARGETED PLAY' in block and '‚Üí' in block:
                          lines = [l.strip() for l in block.split('\n') if l.strip()]
                          if not lines: continue
                          
                          matchup = lines[0].strip()
                          recommendation = lines[1].split('‚Üí')[1].split(':')[1].strip() if len(lines) > 1 and 'TARGETED PLAY:' in lines[1] else 'N/A'
                          reason = lines[2].split('‚Üí')[1].strip() if len(lines) > 2 and '‚Üí' in lines[2] else 'Key factors align'
                          
                          score, confidence, story = get_game_data(week, matchup)
                          
                          plays.append({
                              'matchup': matchup,
                              'recommendation': recommendation,
                              'reason': reason,
                              'score': score,
                              'confidence': confidence,
                              'story': story
                          })
              
              # Parse Fades (THE CORRECTED LOGIC IS HERE)
              if "‚ùå FADE" in content:
                  fade_section = content.split("‚ùå FADE")[1]
                  
                  # Split the section by double newline, which separates game entries
                  blocks = fade_section.strip().split('\n\n')
          
                  # === FIX: Remove the leading separator line from the first block ===
                  first_block_lines = [l.strip() for l in blocks[0].split('\n') if l.strip()]
                  
                  # If the first line is clearly a separator, remove it
                  if first_block_lines and first_block_lines[0].startswith('---'):
                      first_block_lines.pop(0)
          
                  # Update the first block with the cleaned lines
                  blocks[0] = '\n'.join(first_block_lines)
                  # =================================================================
                  
                  for block in blocks:
                      # Check if the block contains the warning and is not empty
                      if '‚ùå AVOID' in block and '‚Üí' in block:
                          lines = [l.strip() for l in block.split('\n') if l.strip()]
                          if len(lines) < 3: continue # Ensure we have Matchup, Warning, Divergence lines
                          
                          # Now, lines[0] is guaranteed to be the matchup name
                          matchup = lines[0].strip()
                          recommendation = 'AVOID/FADE'
                          
                          # Capture the primary AVOID text from lines[1]
                          primary_warning = lines[1].split('‚Üí')[1].strip() if len(lines) > 1 and '‚Üí' in lines[1] else '‚ùå AVOID: Multiple negative factors align'
                          
                          # Capture the divergence detail from lines[2]
                          divergence_detail = lines[2].split('‚Üí')[1].strip() if len(lines) > 2 and '‚Üí' in lines[2] else 'Mixed signals/conflicts'
                          
                          # Combine them for the 'The Warning' field
                          reason = f"{primary_warning} ‚Äî {divergence_detail}"
                          
                          # Fetch the data using the now-correct 'matchup' name
                          score, confidence, story = get_game_data(week, matchup)
                          
                          fades.append({
                              'matchup': matchup,
                              'recommendation': recommendation,
                              'reason': reason,
                              'score': score,
                              'confidence': confidence,
                              'story': story
                          })
                          
              return plays, fades  
          # --- DYNAMIC CONTENT GENERATION ---
          plays_html = ""
          for play in plays:
              plays_html += f"""
              <div style="margin: 20px 0; padding: 15px; border-left: 5px solid #28a745; background: #e9f7ef; border-radius: 4px;">
                  <h3 style="color: #28a745; margin-top: 0; font-size: 18px;">üéØ {play['recommendation']} | {play['matchup']}</h3>
                  
                  <p style="margin: 0 0 10px 0; font-size: 14px; color: #007bff; font-weight: bold;">
                      Market Narrative: 
                      <span style="font-weight: normal; color: #495057;">{play['story']}</span>
                  </p>

                  <p style="margin: 0; font-size: 14px;">
                      <strong style="color: #155724;">The Edge:</strong> {play['reason']}
                  </p>
                  <p style="margin: 5px 0 0 0; font-size: 14px; color: #333;">
                      <strong style="color: #0066cc;">Total Score:</strong>&nbsp;{play['score']}
                      &bull;
                      <strong style="color: #0066cc;">Confidence:</strong>&nbsp;{play['confidence']}/10
                  </p>
              </div>
              """
          
          fades_html = ""
          for fade in fades:
              fades_html += f"""
              <div style="margin: 20px 0; padding: 15px; border-left: 5px solid #dc3545; background: #fbe9e9; border-radius: 4px;">
                  <h3 style="color: #dc3545; margin-top: 0; font-size: 18px;">‚ùå {fade['recommendation']} | {fade['matchup']}</h3>
                  
                  <p style="margin: 0 0 10px 0; font-size: 14px; color: #721c24; font-weight: bold;">
                      Market Narrative: 
                      <span style="font-weight: normal; color: #495057;">{fade['story']}</span>
                  </p>

                  <p style="margin: 0; font-size: 14px;">
                      <strong style="color: #721c24;">The Warning:</strong> {fade['reason']}
                  </p>
                  <p style="margin: 5px 0 0 0; font-size: 14px; color: #333;">
                      <strong style="color: #0066cc;">Total Score:</strong>&nbsp;{fade['score']}
                      &bull;
                      <strong style="color: #0066cc;">Confidence:</strong>&nbsp;{fade['confidence']}/10
                  </p>
              </div>
              """

          # --- HTML BODY ---
          html_body = f"""<html>
          <body style="font-family: Arial, sans-serif; line-height: 1.6; max-width: 700px; margin: 0 auto; padding: 20px; color: #333; background-color: #f4f4f4;">
          
          <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.05);">

              <h1 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; font-size: 24px;">
                  üèà Week {week} NFL Analysis - Conversational Brief
              </h1>
              <p style="color: #7f8c8d; font-style: italic; margin-top: -10px;">Generated: {timestamp}</p>
              
              <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #eee;">
                  <h2 style="color: #2c3e50; margin-top: 0; font-size: 20px;">What I'm seeing this week</h2>
                  
                  <p>This week‚Äôs slate is characterized by several major **Sharp Divergences**‚Äîspots where professional money is taking a clear stand against the public. We have a few key spots that offer fantastic value, specifically targeting **OVERs** where the market is sleeping on high-scoring matchups. Conversely, there are several popular games the public is chasing that we need to avoid, primarily because of alignments favoring the **UNDER**.</p>
                  
                  <p>Focus your attention on the **TARGETED PLAYS** below. Everything else should be treated as a **PASS** unless you have a strong, independent conviction.</p>
              </div>
              
              <h2 style="color: #0066cc; border-bottom: 2px solid #0066cc; padding-bottom: 10px; margin-top: 30px; font-size: 20px;">
                  üî• Top Plays: The High-Value Targets
              </h2>
              
              <p style="color: #666;">These are the games where our analysis‚Äîcombining sharp money, referee context, and situational factors‚Äîidentifies a clear, high-confidence edge. **Read the Market Narrative for the 'Why'.**</p>
              
              {plays_html}
              
              <h2 style="color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 10px; margin-top: 30px; font-size: 20px;">
                  ‚ùå Trap Games: Games to AVOID
              </h2>

              <p style="color: #666;">These games are loaded with conflicting signals or strong factors pointing to an outcome the public is ignoring. Stay away or consider fading the consensus! **The narrative explains the risk.**</p>
              
              {fades_html}
          
              <div style="border-top: 1px solid #bdc3c7; padding-top: 20px; margin-top: 30px; font-size: 12px; color: #7f8c8d;">
                  <p><strong>Detailed Analysis Attached:</strong> The full Pro Analysis (`.txt`) and data spreadsheet (`.csv`) are attached to this email. Please refer to them for a game-by-game breakdown.</p>
                  
                  <p style="margin-bottom: 0;"><em>Generated {timestamp} ‚Ä¢ Week {week} {analysis_type}</em></p>
              </div>
              
          </div>
          </body>
          </html>"""
          
          # --- EMAIL ASSEMBLY WITH ATTACHMENTS (MIME Structure Fix) ---
          # 1. Main container is 'mixed' (default) to hold attachments
          msg = MIMEMultipart() 
          msg['Subject'] = f"Week {week} NFL Analysis - Conversational Brief"
          msg['From'] = os.getenv('GMAIL_USER')
          msg['To'] = "lvarughese@gmail.com"
          
          # 2. Attach the HTML body directly
          html_part = MIMEText(html_body, 'html', 'utf-8')
          msg.attach(html_part)
          
          # ATTACH KEY SUMMARY FILES INDIVIDUALLY
          files_to_attach = [
              "executive_summary.txt", # Primary summary
              "analytics.csv",         # Convenient data spreadsheet
          ]
          
          for file_name_suffix in files_to_attach:
              file_name = f"week{week}_{file_name_suffix}"
              file_path = f"data/week{week}/{file_name}"
              try:
                  with open(file_path, "rb") as f:
                      # Using fully qualified name to avoid NameError
                      part = email.mime.application.MIMEApplication(f.read(), name=file_name)
                  part['Content-Disposition'] = f'attachment; filename="{file_name}"'
                  # 3. Attach files directly to the main message
                  msg.attach(part)
                  print(f"Attached: {file_name}")
              except FileNotFoundError:
                  print(f"‚ö†Ô∏è Warning: File not found for attachment: {file_path}")
          
          server = smtplib.SMTP('smtp.gmail.com', 587)
          server.starttls()
          server.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
          server.send_message(msg)
          server.quit()
          
          print(f"‚úÖ Conversational email sent: Week {week}")
          PYTHON_EOF
      
      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: week-${{ steps.get_week.outputs.week }}-analysis
          path: |
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_executive_summary.txt
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_pro_analysis.txt
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.csv
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.json
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_referee_trends.txt
          retention-days: 30
      
      - name: Commit Pro Analysis
        run: |
          # 1. Configuration
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 2. Stage ALL changes (-A) and attempt the initial commit.
          git add -A || true 
          git commit -m "üìä Week ${{ steps.get_week.outputs.week }} pro analysis - Initial Analysis" || echo "No changes to commit (Proceeding to pull)"
          
          # 3. Defensive Cleanup: Amend any new changes to ensure a clean commit.
          git add -A
          git commit --amend --no-edit || true
      
          # 4. Integrate remote changes with conflict handling
          # Fetch latest remote state
          git fetch origin
          
          # Attempt rebase; if it fails (due to conflicts), execute the block in curly braces
          git rebase origin/main || {
              echo "Rebase conflict detected. Resolving generated files automatically."
              
              # Resolve: Tell Git to take OUR version of the generated files
              git checkout --ours data/week12/week12_executive_summary.txt || true
              git checkout --ours data/week12/week12_pro_analysis.txt || true
              
              # Stage the resolved files
              git add data/week12/week12_executive_summary.txt
              git add data/week12/week12_pro_analysis.txt
              
              # Continue the rebase (this now completes the rebase operation)
              git rebase --continue
          }
          
          # 5. Push the resulting changes
          git push
      
      - name: Summary
        run: |
          echo "‚úÖ Pro Analysis Complete!"
          echo "üìß Email sent: ${{ steps.analysis_type.outputs.type }}"
          echo "üìÅ Analysis files:"
          ls -lh data/week${{ steps.get_week.outputs.week }}/*.txt data/week${{ steps.get_week.outputs.week }}/*.csv data/week${{ steps.get_week.outputs.week }}/*.json 2>/dev/null || true
