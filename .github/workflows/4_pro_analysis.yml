name: 4. Pro Analysis & Email

on:
  repository_dispatch:
    types: [market-data-ready]
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        type: string

jobs:
  generate_analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main
      
      - name: Pull latest changes
        run: git pull origin main
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: pip install pandas numpy
      
      - name: Get Week Number
        id: get_week
        run: |
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
            WEEK="${WEEK%.*}"
          elif [ -n "${{ github.event.client_payload.week }}" ]; then
            WEEK="${{ github.event.client_payload.week }}"
            WEEK="${WEEK%.*}"
          else
            # Auto-detect from existing files
            WEEK=$(ls data/week*/week*_referees.csv 2>/dev/null | grep -oP 'week\K[0-9]+' | sort -n | tail -1)
          fi
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "üìÖ Generating analysis for Week $WEEK"
      
      - name: Get Analysis Type
        id: analysis_type
        run: |
          TYPE="${{ github.event.client_payload.analysis_type }}"
          FLIPS="${{ github.event.client_payload.line_flips }}"
          
          if [ "$TYPE" = "initial" ]; then
            echo "type=Initial Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üèà Initial" >> $GITHUB_OUTPUT
          else
            echo "type=Updated Analysis" >> $GITHUB_OUTPUT
            echo "subject_prefix=üìä Updated" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$FLIPS" ] && [ "$FLIPS" != "0" ]; then
            echo "flip_alert=üö® $FLIPS line flip(s) detected and processed" >> $GITHUB_OUTPUT
          else
            echo "flip_alert=" >> $GITHUB_OUTPUT
          fi
      
      - name: Get Timestamp
        id: timestamp
        run: echo "time=$(date '+%Y-%m-%d %I:%M %p ET')" >> $GITHUB_OUTPUT
      
      - name: Run Pro Analyzer
        run: |
          echo "üî¨ Running Pro Analysis Engine..."
          python3 analyzers/nfl_pro_analyzer.py ${{ steps.get_week.outputs.week }}
      
      - name: Send Enhanced Professional Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'PYTHON_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          # --- FIX: Import the full module for reliable scope access ---
          import email.mime.application 
          import os
          import re
          import json
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          analysis_type = "${{ steps.analysis_type.outputs.type }}"
          
          # --- EMAIL CONTENT GENERATION (Plain and HTML) ---
          
          def generate_email_content(week, analysis_type, timestamp):
              # Load the executive summary text for plain text body
              summary_file = f"data/week{week}/week{week}_executive_summary.txt"
              try:
                  with open(summary_file, 'r') as f:
                      summary_text = f.read()
              except FileNotFoundError:
                  summary_text = f"Executive summary for Week {week} not found."

              # Generate Plain Text Body
              plain_body = f"""
              NFL WEEK {week} - ENHANCED PROFESSIONAL ANALYSIS

              Date Generated: {timestamp}
              Analysis Type: {analysis_type}

              ======================================================================
              EXECUTIVE SUMMARY
              ======================================================================

              {summary_text}

              ======================================================================
              ATTACHMENTS:
              - Full Pro Analysis (week{week}_pro_analysis.txt)
              - Detailed Analytics Data (week{week}_analytics.csv)
              - Raw JSON Data (week{week}_analytics.json)
              
              All files are attached individually for easy access.
              """

              # Generate HTML Body (More structured for Pro Email)
              html_body = f"""
              <html>
              <body style="font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; background-color: #f4f4f4;">
              
              <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
              
                  <h1 style="color: #17202A; border-bottom: 3px solid #2ECC71; padding-bottom: 15px; font-size: 26px;">
                      üèà Week {week} NFL Pro Analysis & Data Package
                  </h1>
                  <p style="color: #7F8C8D; font-style: italic; margin-top: -10px;">Generated: {timestamp} | Type: {analysis_type}</p>
                  
                  <div style="background: #ECF0F1; padding: 20px; border-radius: 8px; margin: 25px 0;">
                      <h2 style="color: #2C3E50; margin-top: 0; font-size: 22px;">Executive Summary</h2>
                      <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; background: #FDFEFE; padding: 15px; border-radius: 5px; border: 1px solid #D5DBDB; font-size: 14px;">{summary_text}</pre>
                  </div>
                  
                  <h2 style="color: #2ECC71; margin-top: 30px; border-bottom: 1px solid #BDC3C7; padding-bottom: 5px; font-size: 20px;">
                      Data Attachments
                  </h2>
                  <p style="color: #566573;">The following four files contain the comprehensive analysis and raw data for Week {week}:</p>
                  
                  <ul style="list-style-type: none; padding: 0;">
                      <li style="padding: 5px 0;"><strong style="color: #17A2B8;">üìÅ week{week}_pro_analysis.txt:</strong> Full game-by-game breakdown and context.</li>
                      <li style="padding: 5px 0;"><strong style="color: #17A2B8;">üìä week{week}_analytics.csv:</strong> Spreadsheet-ready data for quick sorting and filtering.</li>
                      <li style="padding: 5px 0;"><strong style="color: #17A2B8;">üíæ week{week}_analytics.json:</strong> Raw structured data for direct ingestion into models.</li>
                      <li style="padding: 5px 0;"><strong style="color: #17A2B8;">üìÑ week{week}_executive_summary.txt:</strong> The main summary (included in this email body and attached).</li>
                  </ul>
                  
                  <p style="margin-top: 30px; font-size: 14px; color: #808B96;">
                      <em>This is an automated delivery. Please use the attached files for all detailed analysis.</em>
                  </p>
              </div>
              </body>
              </html>
              """
              return plain_body, html_body

          plain_body, html_body = generate_email_content(week, analysis_type, timestamp)

          # --- EMAIL ASSEMBLY WITH ATTACHMENTS ---
          msg = MIMEMultipart('alternative') 
          msg['Subject'] = f"Week {week} NFL Pro Analysis & Data Package"
          msg['From'] = os.getenv('GMAIL_USER')
          msg['To'] = "lvarughese@gmail.com"
          
          # Attach both Plain Text and HTML versions
          plain_part = MIMEText(plain_body, 'plain', 'utf-8')
          html_part = MIMEText(html_body, 'html', 'utf-8')
          msg.attach(plain_part)
          msg.attach(html_part)
          
          # ATTACH ALL FOUR ANALYSIS FILES INDIVIDUALLY
          files_to_attach = [
              "executive_summary.txt",
              "pro_analysis.txt",
              "analytics.csv",
              "analytics.json",
          ]
          
          for file_name_suffix in files_to_attach:
              file_name = f"week{week}_{file_name_suffix}"
              file_path = f"data/week{week}/{file_name}"
              try:
                  with open(file_path, "rb") as f:
                      # --- FIX: USE FULLY QUALIFIED NAME HERE ---
                      part = email.mime.application.MIMEApplication(f.read(), name=file_name)
                  part['Content-Disposition'] = f'attachment; filename="{file_name}"'
                  msg.attach(part)
                  print(f"Attached: {file_name}")
              except FileNotFoundError:
                  print(f"‚ö†Ô∏è Warning: File not found for attachment: {file_path}")
          
          server = smtplib.SMTP('smtp.gmail.com', 587)
          server.starttls()
          server.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
          server.send_message(msg)
          server.quit()
          
          print(f"‚úÖ Enhanced professional email sent: Week {week}")
          PYTHON_EOF
      
      - name: Send Conversational Analysis Email
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'PYTHON_EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          # --- FIX: Changed import to use fully qualified name ---
          import email.mime.application 
          import os
          import re
          
          week = "${{ steps.get_week.outputs.week }}"
          timestamp = "${{ steps.timestamp.outputs.time }}"
          analysis_type = "${{ steps.analysis_type.outputs.type }}"
          
          # --- NEW PARSING LOGIC (omitted for brevity) ---
          def parse_executive_summary(week):
              # ... (Your parsing logic here) ...
              plays = []
              fades = []
              # Fetching file content to ensure the new code has it available
              try:
                  with open(f"data/week{week}/week{week}_executive_summary.txt", "r") as f:
                      content = f.read()
              except FileNotFoundError:
                  return [], []
              
              if "üéØ TARGETED PLAY" in content:
                  targeted_section = content.split("üéØ TARGETED PLAY")[1].split("‚ùå FADE")[0]
                  for block in targeted_section.strip().split('\n\n'):
                      if 'TARGETED PLAY' in block and '‚Üí' in block:
                          lines = [l.strip() for l in block.split('\n') if l.strip()]
                          if not lines: continue
                          matchup = lines[0].strip()
                          recommendation = lines[1].split('‚Üí')[1].split(':')[1].strip() if len(lines) > 1 and 'TARGETED PLAY:' in lines[1] else 'N/A'
                          reason = lines[2].split('‚Üí')[1].strip() if len(lines) > 2 and '‚Üí' in lines[2] else 'Key factors align'
                          plays.append({'matchup': matchup, 'recommendation': recommendation, 'reason': reason})
              
              if "‚ùå FADE" in content:
                  fade_section = content.split("‚ùå FADE")[1]
                  for block in fade_section.strip().split('\n\n'):
                      if '‚ùå AVOID' in block and '‚Üí' in block:
                          lines = [l.strip() for l in block.split('\n') if l.strip()]
                          if not lines: continue
                          matchup = lines[0].strip()
                          recommendation = 'AVOID/FADE'
                          reason = lines[2].split('‚Üí')[1].strip() if len(lines) > 2 and '‚Üí' in lines[2] else 'Mixed signals/conflicts'
                          fades.append({'matchup': matchup, 'recommendation': recommendation, 'reason': reason})
              return plays, fades

          
          plays, fades = parse_executive_summary(week)
          
          # --- DYNAMIC CONTENT GENERATION (omitted for brevity) ---
          plays_html = ""
          for play in plays:
              plays_html += f"""
              <div style="margin: 20px 0; padding: 15px; border-left: 5px solid #28a745; background: #e9f7ef; border-radius: 4px;">
                  <h3 style="color: #28a745; margin-top: 0; font-size: 18px;">üéØ {play['recommendation']} | {play['matchup']}</h3>
                  <p style="margin: 0; font-size: 14px;">
                      <strong style="color: #155724;">The Edge:</strong> {play['reason']}
                  </p>
              </div>
              """
          
          fades_html = ""
          for fade in fades:
              fades_html += f"""
              <div style="margin: 20px 0; padding: 15px; border-left: 5px solid #dc3545; background: #fbe9e9; border-radius: 4px;">
                  <h3 style="color: #dc3545; margin-top: 0; font-size: 18px;">‚ùå {fade['recommendation']} | {fade['matchup']}</h3>
                  <p style="margin: 0; font-size: 14px;">
                      <strong style="color: #721c24;">The Warning:</strong> {fade['reason']}
                  </p>
              </div>
              """
              
          html_body = f"""<html>
          <body style="font-family: Arial, sans-serif; line-height: 1.6; max-width: 700px; margin: 0 auto; padding: 20px; color: #333; background-color: #f4f4f4;">
          
          <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.05);">
              <h1 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; font-size: 24px;">
                  üèà Week {week} NFL Analysis - Conversational Brief
              </h1>
              <p style="color: #7f8c8d; font-style: italic; margin-top: -10px;">Generated: {timestamp}</p>
              
              <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #eee;">
                  <h2 style="color: #2c3e50; margin-top: 0; font-size: 20px;">What I'm seeing this week</h2>
                  
                  <p>This week‚Äôs slate is characterized by several major **Sharp Divergences**‚Äîspots where professional money is taking a clear stand against the public. We have a few key spots that offer fantastic value, specifically targeting **OVERs** where the market is sleeping on high-scoring matchups. Conversely, there are several popular games the public is chasing that we need to avoid, primarily because of alignments favoring the **UNDER**.</p>
                  
                  <p>Focus your attention on the **TARGETED PLAYS** below. Everything else should be treated as a **PASS** unless you have a strong, independent conviction.</p>
              </div>
              
              <h2 style="color: #0066cc; border-bottom: 2px solid #0066cc; padding-bottom: 10px; margin-top: 30px; font-size: 20px;">
                  üî• Top Plays: The High-Value Targets
              </h2>
              
              <p style="color: #666;">These are the games where our analysis‚Äîcombining sharp money, referee context, and situational factors‚Äîidentifies a clear, high-confidence edge.</p>
              
              {plays_html}
              
              <h2 style="color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 10px; margin-top: 30px; font-size: 20px;">
                  ‚ùå Trap Games: Games to AVOID
              </h2>

              <p style="color: #666;">These games are loaded with conflicting signals or strong factors pointing to an outcome the public is ignoring. Stay away or consider fading the consensus!</p>
              
              {fades_html}
          
              <div style="border-top: 1px solid #bdc3c7; padding-top: 20px; margin-top: 30px; font-size: 12px; color: #7f8c8d;">
                  <p><strong>Detailed Analysis Attached:</strong> The full Pro Analysis (`.txt`) and data spreadsheet (`.csv`) are attached to this email. Please refer to them for a game-by-game breakdown.</p>
                  
                  <p style="margin-bottom: 0;"><em>Generated {timestamp} ‚Ä¢ Week {week} {analysis_type}</em></p>
              </div>
              
          </div>
          </body>
          </html>"""
          
          # --- EMAIL ASSEMBLY WITH ATTACHMENTS ---
          msg = MIMEMultipart() 
          msg['Subject'] = f"Week {week} NFL Analysis - Conversational Brief"
          msg['From'] = os.getenv('GMAIL_USER')
          msg['To'] = "lvarughese@gmail.com"
          
          html_part = MIMEText(html_body, 'html', 'utf-8')
          msg.attach(html_part)
          
          # ATTACH KEY SUMMARY FILES INDIVIDUALLY
          files_to_attach = [
              "executive_summary.txt", # Primary summary
              "analytics.csv",         # Convenient data spreadsheet
          ]
          
          for file_name_suffix in files_to_attach:
              file_name = f"week{week}_{file_name_suffix}"
              file_path = f"data/week{week}/{file_name}"
              try:
                  with open(file_path, "rb") as f:
                      # --- FIX: USE FULLY QUALIFIED NAME HERE ---
                      part = email.mime.application.MIMEApplication(f.read(), name=file_name)
                  part['Content-Disposition'] = f'attachment; filename="{file_name}"'
                  msg.attach(part)
                  print(f"Attached: {file_name}")
              except FileNotFoundError:
                  print(f"‚ö†Ô∏è Warning: File not found for attachment: {file_path}")
          
          server = smtplib.SMTP('smtp.gmail.com', 587)
          server.starttls()
          server.login(os.getenv('GMAIL_USER'), os.getenv('GMAIL_APP_PASSWORD'))
          server.send_message(msg)
          server.quit()
          
          print(f"‚úÖ Conversational email sent: Week {week}")
          PYTHON_EOF
      
      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: week-${{ steps.get_week.outputs.week }}-analysis
          path: |
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_executive_summary.txt
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_pro_analysis.txt
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.csv
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_analytics.json
            data/week${{ steps.get_week.outputs.week }}/week${{ steps.get_week.outputs.week }}_referee_trends.txt
          retention-days: 30
      
      - name: Commit Pro Analysis
        run: |
          # 1. Configuration
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 2. Stage ALL changes (-A) and attempt the initial commit.
          git add -A || true 
          git commit -m "üìä Week ${{ steps.get_week.outputs.week }} pro analysis - Initial Analysis" || echo "No changes to commit (Proceeding to pull)"
          
          # 3. Defensive Cleanup: Amend any new changes to ensure a clean commit.
          git add -A
          git commit --amend --no-edit || true
      
          # 4. Integrate remote changes with conflict handling
          # Fetch latest remote state
          git fetch origin
          
          # Attempt rebase; if it fails (due to conflicts), execute the block in curly braces
          git rebase origin/main || {
              echo "Rebase conflict detected. Resolving generated files automatically."
              
              # Resolve: Tell Git to take OUR version of the generated files
              git checkout --ours data/week12/week12_executive_summary.txt || true
              git checkout --ours data/week12/week12_pro_analysis.txt || true
              
              # Stage the resolved files
              git add data/week12/week12_executive_summary.txt
              git add data/week12/week12_pro_analysis.txt
              
              # Continue the rebase (this now completes the rebase operation)
              git rebase --continue
          }
          
          # 5. Push the resulting changes
          git push
      
      - name: Summary
        run: |
          echo "‚úÖ Pro Analysis Complete!"
          echo "üìß Email sent: ${{ steps.analysis_type.outputs.type }}"
          echo "üìÅ Analysis files:"
          ls -lh data/week${{ steps.get_week.outputs.week }}/*.txt data/week${{ steps.get_week.outputs.week }}/*.csv data/week${{ steps.get_week.outputs.week }}/*.json 2>/dev/null || true
