name: 5. Enhanced Performance Tracker
on:
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        default: '12'
        type: string
      action:
        description: 'Action to perform'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto        # Log + update + report (most common)
        - log_only    # Just log recommendations
        - update_only # Just update results
        - report_only # Just generate report
      analytics_file:
        description: 'Analytics file path (optional - auto-detects if blank)'
        required: false
        default: ''
        type: string

jobs:
  update-performance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests
    
    - name: Process Week Performance
      env:
        WEEK: ${{ github.event.inputs.week }}
        ACTION: ${{ github.event.inputs.action }}
        ANALYTICS_FILE: ${{ github.event.inputs.analytics_file }}
      run: |
        python <<EOF
        import sys, os
        sys.path.append('.')
        from analyzers.performance_tracker import EnhancedPerformanceTracker
        
        # Get inputs
        week = int(os.getenv('WEEK'))
        action = os.getenv('ACTION')
        analytics_file = os.getenv('ANALYTICS_FILE').strip() or None
        
        print(f'üèà Processing Week {week} - Action: {action}')
        print('=' * 50)
        
        # Initialize tracker
        tracker = EnhancedPerformanceTracker()
        
        try:
            if action == 'auto':
                # Full automatic processing using the public method
                print('üîÑ Running full automatic processing...')
                
                # Log recommendations if analytics file exists
                if analytics_file:
                    tracker.log_week_recommendations(week, analytics_file)
                else:
                    # Try to find analytics file automatically
                    possible_files = [
                        f'data/week{week}/week{week}_analytics.json',
                        f'week{week}_analytics.json'
                    ]
                    
                    found_file = None
                    for file_path in possible_files:
                        if os.path.exists(file_path):
                            found_file = file_path
                            break
                    
                    if found_file:
                        print(f'üìã Found analytics file: {found_file}')
                        tracker.log_week_recommendations(week, found_file)
                    else:
                        print(f'üìã No analytics file found, skipping recommendation logging')
                
                # Update results with live scores
                print('üîÑ Updating results with live NFL scores...')
                results = tracker.update_week_results_auto(week, season=2025)
                
                if 'error' in results:
                    print(f'‚ö†Ô∏è Auto-update failed: {results["error"]}')
                    print('üí° You may need to update results manually')
                else:
                    print(f'‚úÖ Updated {results["updated_games"]} games')
                    if results.get('wins', 0) + results.get('losses', 0) > 0:
                        print(f'üìä Record: {results["wins"]}-{results["losses"]}' + 
                              (f'-{results["pushes"]}' if results.get("pushes", 0) > 0 else ''))
                        print(f'üìà Win Rate: {results.get("win_rate", 0):.1f}%')
                
                # Generate report
                report = tracker.generate_week_results_report(week)
                print(f'\n{report}')
                
            elif action == 'log_only':
                print('üìã Logging recommendations only...')
                if analytics_file and os.path.exists(analytics_file):
                    tracker.log_week_recommendations(week, analytics_file)
                else:
                    print(f'‚ö†Ô∏è Analytics file not found: {analytics_file}')
                    
            elif action == 'update_only':
                print('üîÑ Updating results only...')
                results = tracker.update_week_results_auto(week, season=2025)
                
                if 'error' not in results:
                    print(f'‚úÖ Updated {results["updated_games"]} games')
                    
                # Show updated report
                report = tracker.generate_week_results_report(week)
                print(f'\n{report}')
                
            elif action == 'report_only':
                print('üìä Generating report only...')
                report = tracker.generate_week_results_report(week)
                print(f'\n{report}')
            
            # Save report to file for email
            with open(f'week{week}_performance_report.txt', 'w') as f:
                f.write(f'NFL Week {week} Performance Update\n')
                f.write('=' * 50 + '\n\n')
                if 'report' in locals():
                    f.write(report)
                else:
                    f.write('Report generation was not requested for this action.')
            
            print(f'\nüìÑ Report saved to week{week}_performance_report.txt')
            
        except Exception as e:
            print(f'‚ùå Error processing Week {week}: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        EOF
    
    - name: Generate Multi-Week Analysis
      if: contains(github.event.inputs.action, 'auto') || contains(github.event.inputs.action, 'report')
      run: |
        python <<EOF
        import sys
        sys.path.append('.')
        from analyzers.performance_tracker import EnhancedPerformanceTracker
        
        tracker = EnhancedPerformanceTracker()
        
        print('\nüìà MULTI-WEEK ANALYSIS (Last 4 Weeks)')
        print('=' * 60)
        
        # Analyze performance across last 4 weeks
        analysis = tracker.analyze_performance(weeks_back=4)
        
        if 'overall' in analysis:
            overall = analysis['overall']
            print(f'Total Recommendations: {overall["total_recommendations"]}')
            print(f'Completed Bets: {overall["completed_bets"]}')
            print(f'Win Rate: {overall["win_rate"]}%')
            print(f'Pending Results: {overall["pending_results"]}')
        
        if 'by_classification' in analysis:
            print(f'\nPerformance by Classification:')
            for tier, stats in analysis['by_classification'].items():
                print(f'  {tier}: {stats["win_rate"]}% ({stats["count"]} bets)')
        
        if 'insights' in analysis:
            insights = analysis['insights']
            print(f'\nKey Insights:')
            print(f'  Best Factor: {insights["best_performing_factor"]}')
            print(f'  Most Reliable: {insights["most_reliable_classification"]}')
        EOF
    
    - name: Email Performance Report
      if: contains(github.event.inputs.action, 'auto') || contains(github.event.inputs.action, 'update')
      env:
        EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      run: |
        python <<EOF
        import sys, os, smtplib
        from email.mime.text import MIMEText
        from email.mime.multipart import MIMEMultipart
        from email.mime.base import MIMEBase
        from email import encoders
        from datetime import datetime
        
        week = int('${{ github.event.inputs.week }}')
        action = '${{ github.event.inputs.action }}'
        
        # Read the performance report
        try:
            report_file = 'week' + str(week) + '_performance_report.txt'
            with open(report_file, 'r') as f:
                report = f.read()
        except:
            report = 'Performance report not available'
        
        # Email setup
        email_addr = os.getenv('EMAIL_ADDRESS')
        email_pass = os.getenv('EMAIL_PASSWORD')
        
        if email_addr and email_pass:
            try:
                msg = MIMEMultipart()
                msg['From'] = email_addr
                msg['To'] = email_addr
                
                # Build subject safely
                subject = 'üèà Week ' + str(week) + ' Performance Update (' + action + ')'
                msg['Subject'] = subject
                
                # Build email body safely without f-strings
                timestamp = datetime.now().strftime("%Y-%m-%d %H:%M")
                body = "NFL Performance Tracker Update\n"
                body += "==============================\n\n"
                body += "Week: " + str(week) + "\n"
                body += "Action: " + action + "\n"
                body += "Updated: " + timestamp + "\n\n"
                body += report + "\n\n"
                body += "üìä Data Files:\n"
                body += "- Historical Results: data/historical/betting_results.csv\n"
                body += "- Week Analytics: data/week" + str(week) + "/week" + str(week) + "_analytics.json\n\n"
                body += "üîÑ Next Steps:\n"
                body += "- Review performance trends\n"
                body += "- Check for any manual corrections needed\n"
                body += "- Prepare for next week's analysis\n"
                
                msg.attach(MIMEText(body, 'plain'))
                
                # Attach CSV if available
                csv_path = 'data/historical/betting_results.csv'
                if os.path.exists(csv_path):
                    with open(csv_path, 'rb') as f:
                        part = MIMEBase('application', 'octet-stream')
                        part.set_payload(f.read())
                    
                    encoders.encode_base64(part)
                    filename = 'betting_results_week' + str(week) + '.csv'
                    part.add_header(
                        'Content-Disposition',
                        'attachment; filename=' + filename
                    )
                    msg.attach(part)
                
                # Send email
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(email_addr, email_pass)
                server.sendmail(email_addr, email_addr, msg.as_string())
                server.quit()
                
                print('üìß Performance report emailed successfully')
                
            except Exception as e:
                print('üìß Email failed: ' + str(e))
        else:
            print('üìß Email credentials not configured')
        EOF
    
    - name: Commit Updated Performance Data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are changes to commit
        if [ -n "$(git status --porcelain)" ]; then
          git add data/historical/ week${{ github.event.inputs.week }}_performance_report.txt
          git commit -m "üìä Performance update: Week ${{ github.event.inputs.week }} (${{ github.event.inputs.action }})"
          git push
          echo "‚úÖ Performance data committed and pushed"
        else
          echo "‚ÑπÔ∏è No changes to commit"
        fi
