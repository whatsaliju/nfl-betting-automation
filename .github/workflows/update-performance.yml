name: 5. Enhanced Performance Tracker
on:
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        default: '12'
        type: string
      action:
        description: 'Action to perform'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto        # Log + update + report (most common)
        - log_only    # Just log recommendations
        - update_only # Just update results
        - report_only # Just generate report
      analytics_file:
        description: 'Analytics file path (optional - auto-detects if blank)'
        required: false
        default: ''
        type: string

jobs:
  update-performance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests
    
    - name: Process Week Performance
      env:
        WEEK: ${{ github.event.inputs.week }}
        ACTION: ${{ github.event.inputs.action }}
        ANALYTICS_FILE: ${{ github.event.inputs.analytics_file }}
      run: |
        python <<EOF
        import sys, os
        sys.path.append('.')
        from analyzers.performance_tracker import EnhancedPerformanceTracker
        
        # Get inputs
        week = int(os.getenv('WEEK'))
        action = os.getenv('ACTION')
        analytics_file = os.getenv('ANALYTICS_FILE').strip() or None
        
        print(f'ðŸˆ Processing Week {week} - Action: {action}')
        print('=' * 50)
        
        # Initialize tracker
        tracker = EnhancedPerformanceTracker()
        
        try:
            if action == 'auto':
                # Full automatic processing
                print('ðŸ”„ Running full automatic processing...')
                
                # 1. Log recommendations if analytics file exists
                log_result = tracker._log_recommendations(week, analytics_file, 2025)
                for msg in log_result.get('messages', []):
                    print(f'   {msg}')
                
                # 2. Update results with live scores
                update_result = tracker._update_results(week, 2025)
                for msg in update_result.get('messages', []):
                    print(f'   {msg}')
                
                # 3. Generate report
                report = tracker._generate_report(week)
                print(f'\n{report}')
                
            elif action == 'log_only':
                print('ðŸ“‹ Logging recommendations only...')
                result = tracker._log_recommendations(week, analytics_file, 2025)
                for msg in result.get('messages', []):
                    print(f'   {msg}')
                    
            elif action == 'update_only':
                print('ðŸ”„ Updating results only...')
                result = tracker._update_results(week, 2025)
                for msg in result.get('messages', []):
                    print(f'   {msg}')
                    
                # Show updated report
                report = tracker._generate_report(week)
                print(f'\n{report}')
                
            elif action == 'report_only':
                print('ðŸ“Š Generating report only...')
                report = tracker._generate_report(week)
                print(f'\n{report}')
            
            # Save report to file for email
            with open(f'week{week}_performance_report.txt', 'w') as f:
                f.write(f'NFL Week {week} Performance Update\n')
                f.write('=' * 50 + '\n\n')
                if 'report' in locals():
                    f.write(report)
                else:
                    f.write('Report generation was not requested for this action.')
            
            print(f'\nðŸ“„ Report saved to week{week}_performance_report.txt')
            
        except Exception as e:
            print(f'âŒ Error processing Week {week}: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        EOF
    
    - name: Generate Multi-Week Analysis
      if: contains(github.event.inputs.action, 'auto') || contains(github.event.inputs.action, 'report')
      run: |
        python <<EOF
        import sys
        sys.path.append('.')
        from analyzers.performance_tracker import EnhancedPerformanceTracker
        
        tracker = EnhancedPerformanceTracker()
        
        print('\nðŸ“ˆ MULTI-WEEK ANALYSIS (Last 4 Weeks)')
        print('=' * 60)
        
        # Analyze performance across last 4 weeks
        analysis = tracker.analyze_performance(weeks_back=4)
        
        if 'overall' in analysis:
            overall = analysis['overall']
            print(f'Total Recommendations: {overall["total_recommendations"]}')
            print(f'Completed Bets: {overall["completed_bets"]}')
            print(f'Win Rate: {overall["win_rate"]}%')
            print(f'Pending Results: {overall["pending_results"]}')
        
        if 'by_classification' in analysis:
            print(f'\nPerformance by Classification:')
            for tier, stats in analysis['by_classification'].items():
                print(f'  {tier}: {stats["win_rate"]}% ({stats["count"]} bets)')
        
        if 'insights' in analysis:
            insights = analysis['insights']
            print(f'\nKey Insights:')
            print(f'  Best Factor: {insights["best_performing_factor"]}')
            print(f'  Most Reliable: {insights["most_reliable_classification"]}')
        EOF
    
    - name: Email Performance Report
      if: contains(github.event.inputs.action, 'auto') || contains(github.event.inputs.action, 'update')
      env:
        EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      run: |
        python <<EOF
        import sys, os, smtplib
        from email.mime.text import MIMEText
        from email.mime.multipart import MIMEMultipart
        from email.mime.base import MIMEBase
        from email import encoders
        from datetime import datetime
        
        week = int('${{ github.event.inputs.week }}')
        action = '${{ github.event.inputs.action }}'
        
        # Read the performance report
        try:
            with open(f'week{week}_performance_report.txt', 'r') as f:
                report = f.read()
        except:
            report = 'Performance report not available'
        
        # Email setup
        email_addr = os.getenv('EMAIL_ADDRESS')
        email_pass = os.getenv('EMAIL_PASSWORD')
        
        if email_addr and email_pass:
            try:
                msg = MIMEMultipart()
                msg['From'] = email_addr
                msg['To'] = email_addr
                msg['Subject'] = f'ðŸˆ Week {week} Performance Update ({action})'
                
                body = f'''NFL Performance Tracker Update
                Week: {week}
                Action: {action}
                Updated: {datetime.now().strftime("%Y-%m-%d %H:%M")}

                {report}

                ðŸ“Š Data Files:
                - Historical Results: data/historical/betting_results.csv
                - Week Analytics: data/week{week}/week{week}_analytics.json
                
                ðŸ”„ Next Steps:
                - Review performance trends
                - Check for any manual corrections needed
                - Prepare for next week's analysis
                '''
                
                msg.attach(MIMEText(body, 'plain'))
                
                # Attach CSV if available
                csv_path = 'data/historical/betting_results.csv'
                if os.path.exists(csv_path):
                    with open(csv_path, 'rb') as f:
                        part = MIMEBase('application', 'octet-stream')
                        part.set_payload(f.read())
                    
                    encoders.encode_base64(part)
                    part.add_header(
                        'Content-Disposition',
                        f'attachment; filename=betting_results_week{week}.csv'
                    )
                    msg.attach(part)
                
                # Send email
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(email_addr, email_pass)
                server.sendmail(email_addr, email_addr, msg.as_string())
                server.quit()
                
                print('ðŸ“§ Performance report emailed successfully')
                
            except Exception as e:
                print(f'ðŸ“§ Email failed: {e}')
        else:
            print('ðŸ“§ Email credentials not configured')
        EOF
    
    - name: Commit Updated Performance Data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are changes to commit
        if [ -n "$(git status --porcelain)" ]; then
          git add data/historical/ week${{ github.event.inputs.week }}_performance_report.txt
          git commit -m "ðŸ“Š Performance update: Week ${{ github.event.inputs.week }} (${{ github.event.inputs.action }})"
          git push
          echo "âœ… Performance data committed and pushed"
        else
          echo "â„¹ï¸ No changes to commit"
        fi
