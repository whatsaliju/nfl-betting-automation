name: 5. Update Performance Tracker
on:
  workflow_dispatch:  # Manual trigger - you run this after games complete
    inputs:
      week:
        description: 'NFL Week Number'
        required: true
        default: '12'
        type: string
      action:
        description: 'Action to perform'
        required: true
        default: 'log_only'
        type: choice
        options:
        - log_only
        - log_and_update
        - update_only
      game_results:
        description: 'Game results (JSON format) - only needed for updates'
        required: false
        default: ''
        type: string

jobs:
  update-performance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy
    
    - name: Log Week Recommendations
      if: contains(github.event.inputs.action, 'log')
      run: |
        python -c "
        import sys
        sys.path.append('.')
        from analyzers.performance_tracker import PerformanceTracker
        
        week = int('${{ github.event.inputs.week }}')
        tracker = PerformanceTracker()
        
        print(f'üìä Logging Week {week} recommendations...')
        try:
            tracker.log_week_recommendations(week, f'data/week{week}/week{week}_analytics.json')
            print('‚úÖ Recommendations logged successfully')
        except Exception as e:
            print(f'‚ö†Ô∏è Error logging recommendations: {e}')
            print(f'Make sure data/week{week}/week{week}_analytics.json exists')
        "
    
    - name: Update Game Results (Generic)
      if: contains(github.event.inputs.action, 'update')
      run: |
        # Execute the Python script using a Here Document (<<EOF)
        python <<EOF
        import sys, json, os
        sys.path.append('.')
        from analyzers.performance_tracker import PerformanceTracker
        
        # GitHub context variables are safe to inject here
        week = int('${{ github.event.inputs.week }}')
        tracker = PerformanceTracker()
        
        results_input = ''
        results_file_path = f'data/week{week}/game_results.json'
        source_description = ''
        
        # 1. Get results from file or input
        if os.path.exists(results_file_path):
            with open(results_file_path, 'r') as f:
                results_input = f.read()
            source_description = f'Detected and using game results from file: {results_file_path}'
        else:
            # Fallback to manual input
            results_input = '''${{ github.event.inputs.game_results }}'''.strip()
            if results_input:
                source_description = 'Using game results from manual workflow input.'
        
        if not results_input:
            print('‚ö†Ô∏è No game results provided. Skipping update.')
            sys.exit(0)
        
        # 2. Parse and Update Results
        print(f'üìÑ {source_description}')
        try:
            results_list = json.loads(results_input)
            
            if not isinstance(results_list, list):
                raise ValueError('Parsed JSON is not a list of results.')
            
            print(f'üîÑ Processing {len(results_list)} game results for Week {week}...')
            updated_count = 0
            for result in results_list:
                # Check for mandatory keys
                if all(k in result for k in ['game', 'actual_result', 'won']):
                    # Call the tracker method for each game
                    tracker.update_results(
                        week=week,
                        game=result['game'],
                        actual_result=result['actual_result'],
                        won=result['won'],
                        closing_line=result.get('closing_line') # Use .get() for optional fields
                    )
                    updated_count += 1
                else:
                    print(f'‚ö†Ô∏è Skipped result missing key field (game, actual_result, or won): {result}')
            print(f'‚úÖ Successfully updated {updated_count} game records.')
        
        except json.JSONDecodeError:
            print('‚ùå ERROR: Failed to parse results input as JSON. Check file/input format.')
            sys.exit(1)
        except Exception as e:
            print(f'‚ùå An unexpected error occurred during update: {e}')
            sys.exit(1)
        EOF
    
    - name: Generate Performance Report
      run: |
        python -c "
        import sys
        sys.path.append('.')
        from analyzers.performance_tracker import PerformanceTracker
        
        week = int('${{ github.event.inputs.week }}')
        tracker = PerformanceTracker()
        
        print(f'üìà Generating performance analysis (last 3 weeks)...')
        report = tracker.generate_performance_report(weeks_back=3)
        print('\\n' + '='*60)
        print(report)
        print('='*60)
        
        # Also save report to file for email
        with open(f'week{week}_performance_report.txt', 'w') as f:
            f.write(f'NFL Week {week} Performance Update\\n')
            f.write('='*50 + '\\n\\n')
            f.write(report)
        
        print(f'\\nüìÑ Report saved to week{week}_performance_report.txt')
        "
    
    - name: Email Performance Report
      if: contains(github.event.inputs.action, 'update')
      env:
        EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      run: |
        python -c "
        import sys, os, smtplib
        from email.mime.text import MIMEText
        from email.mime.multipart import MIMEMultipart
        from email.mime.base import MIMEBase
        from email import encoders
        sys.path.append('.')
        
        week = int('${{ github.event.inputs.week }}')
        
        # Read the performance report
        try:
            with open(f'week{week}_performance_report.txt', 'r') as f:
                report = f.read()
        except:
            report = 'Performance report not available'
        
        # Email setup
        email_addr = os.getenv('EMAIL_ADDRESS')
        email_pass = os.getenv('EMAIL_PASSWORD')
        
        if email_addr and email_pass:
            try:
                msg = MIMEMultipart()
                msg['From'] = email_addr
                msg['To'] = email_addr
                msg['Subject'] = f'üìä NFL Week {week} Performance Update'
                
                body = f'''
        NFL Performance Tracker Update
        ==============================
        
        Week {week} results have been processed.
        
        {report}
        
        Full historical data: data/historical/betting_results.csv
        Analytics data: data/week{week}/week{week}_analytics.json
                '''
                
                msg.attach(MIMEText(body, 'plain'))
                
                # Attach CSV if available
                csv_path = 'data/historical/betting_results.csv'
                if os.path.exists(csv_path):
                    with open(csv_path, 'rb') as f:
                        part = MIMEBase('application', 'octet-stream')
                        part.set_payload(f.read())
                    
                    encoders.encode_base64(part)
                    part.add_header(
                        'Content-Disposition',
                        f'attachment; filename= betting_results.csv'
                    )
                    msg.attach(part)
                
                # Send email
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(email_addr, email_pass)
                server.sendmail(email_addr, email_addr, msg.as_string())
                server.quit()
                
                print('üìß Performance report emailed successfully')
                
            except Exception as e:
                print(f'üìß Email failed: {e}')
        else:
            print('üìß Email credentials not configured')
        "
    
    - name: Commit Updated Performance Data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are changes to commit
        if [ -n "$(git status --porcelain)" ]; then
          git add data/historical/ week${{ github.event.inputs.week }}_performance_report.txt
          git commit -m "Update performance tracking - Week ${{ github.event.inputs.week }} (${{ github.event.inputs.action }})"
          git push
          echo "‚úÖ Performance data committed and pushed"
        else
          echo "‚ÑπÔ∏è No changes to commit"
        fi
